<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Writing a compiler - Emulator programming tutorial for emuStudio 0.39</title> <link rel="shortcut icon" href="/documentation/developer/0.39/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/documentation/developer/0.39/assets/css/just-the-docs.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3492956-5"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', "UA-3492956-5"); </script> <script type="text/javascript" src="/documentation/developer/0.39/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/documentation/developer/0.39/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Writing a compiler | Emulator programming tutorial for emuStudio 0.39</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="Writing a compiler" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Emulator programming tutorial for emuStudio 0.39. emuStudio is universal emulation platform and framework targeting mainly academic sphere." /> <meta property="og:description" content="Emulator programming tutorial for emuStudio 0.39. emuStudio is universal emulation platform and framework targeting mainly academic sphere." /> <link rel="canonical" href="/documentation/developer/0.39/compiler/" /> <meta property="og:url" content="/documentation/developer/0.39/compiler/" /> <meta property="og:site_name" content="Emulator programming tutorial for emuStudio 0.39" /> <script type="application/ld+json"> {"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/documentation/developer/0.39/assets/logo-1.svg"}},"description":"Emulator programming tutorial for emuStudio 0.39. emuStudio is universal emulation platform and framework targeting mainly academic sphere.","@type":"WebPage","headline":"Writing a compiler","url":"/documentation/developer/0.39/compiler/","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="/documentation/developer/0.39" class="site-title lh-tight"> <div class="site-logo"></div> </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item active"><a href="/documentation/developer/0.39/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item active"><a href="/documentation/developer/0.39/" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="/documentation/developer/0.39/introduction/" class="navigation-list-link">Introduction</a></li><li class="navigation-list-item"><a href="/documentation/developer/0.39/getting_started/" class="navigation-list-link">Getting started</a></li><li class="navigation-list-item active"><a href="/documentation/developer/0.39/compiler/" class="navigation-list-link active">Writing a compiler</a></li><li class="navigation-list-item"><a href="/documentation/developer/0.39/memory/" class="navigation-list-link">Writing a memory</a></li><li class="navigation-list-item"><a href="/documentation/developer/0.39/cpu/" class="navigation-list-link">Writing a CPU emulator</a></li><li class="navigation-list-item"><a href="/documentation/developer/0.39/device/" class="navigation-list-link">Writing a device</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Emulator programming tutorial for emuStudio 0.39" aria-label="Search Emulator programming tutorial for emuStudio 0.39" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> <ul class="list-style-none text-small aux-nav"> <li class="d-inline-block my-0"><a href="/">Back to website</a></li> </ul> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <div class="sect1"> <h2 id="writing-a-compiler"> <a href="#writing-a-compiler" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Writing a compiler </h2> <div class="sectionbody"> <div class="paragraph"> <p>This tutorial will guide you to how to create a compiler for emuStudio. It focuses on things around emuStudio, emuLib and some common practices. It will not dig deep into the compiler theory, only what will be required on the way.</p> </div> <div class="paragraph"> <p>In present days, general scheme of compiler&#8217;s work is parsing, semantic analysis, optimalization and code generation. Quite tedious and error-prone work of parsing can be generated automatically with parser generators. All emuStudio compilers use such tools; and they will be also used in this tutorial:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://jflex.de/">JFlex</a> for generating the lexical analyzer, or lexer for short,</p> </li> <li> <p><a href="http://www2.cs.tum.edu/projects/cup/">Java cup</a> for generating LR(k) parsers.</p> </li> </ul> </div> <div class="paragraph"> <p>Before reading on, please read the <a href="#INTRODUCTION_PLUGINS">[INTRODUCTION_PLUGINS]</a> chapter. It provides the information needed for setting up the development environment and explains how emuStudio plug-ins' lifecycle work.</p> </div> <div class="sect2"> <h3 id="COMPILER_GETTING_STARTED"> <a href="#COMPILER_GETTING_STARTED" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Getting started </h3> <div class="paragraph"> <p>In the context of the whole emulator, the compiler is usually an assembler which produces binary instructions for the emulated CPU. However, it does not have to be assembler; it really can be any language compiler. The output of the compiler is often loaded directly into emulated operating memory, so the program can be run in emuStudio in a single click. This is one of the great features of emuStudio.</p> </div> <div class="paragraph"> <p>A compiler is a plug-in, which means that it requires to implement an API. The API for compilers is defined in the form of Java interfaces and some classes in emuLib, in package <code>emulib.plugins.compiler</code>. This tutorial will guide you with implementing the API and the whole compiler.</p> </div> </div> <div class="sect2"> <h3 id="COMPILER_SSEM_ASM"> <a href="#COMPILER_SSEM_ASM" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Assembler for SSEM </h3> <div class="paragraph"> <p>In this tutorial, we will implement an assembler for the world&#8217;s very first stored-program computer, <a href="https://en.wikipedia.org/wiki/Manchester_Small-Scale_Experimental_Machine">SSEM</a>, nicknamed "Baby". It was a predecessor of Manchester Mark 1 which led to Ferranti Mark 1, the world&#8217;s first commercially available general-purpose computer.</p> </div> <div class="paragraph"> <p>It it very simple computer, which can run only 7 instructions. The instructions table follows (modified from <a href="https://en.wikipedia.org/wiki/Manchester_Small-Scale_Experimental_Machine#Programming">Wikipedia</a>):</p> </div> <div class="table-wrapper"><table class="tableblock frame-topbot grid-all spread table table-striped table-condensed"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Binary code</th> <th class="tableblock halign-left valign-top">Mnemonic</th> <th class="tableblock halign-left valign-top">Action</th> <th class="tableblock halign-left valign-top">Operation</th> </tr> </thead> <tfoot> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">111</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">STP / HLT</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Stop</p></td> <td class="tableblock halign-left valign-top"></td> </tr> </tfoot> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">000</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JMP S</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">S(L) &#8594; CI</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the instruction at the address obtained from the specified memory address <code>S(L)</code> (absolute unconditional jump)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JRP / JPR / JMR S</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CI + S(L) &#8594; CI</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the instruction at the program counter (<code>CI</code>) plus the relative value obtained from the specified memory address <code>S(L)</code> (relative unconditional jump)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">010</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">LDN S</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">-S(L) &#8594; A</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Take the number from the specified memory address <code>S(L)</code>, negate it, and load it into the accumulator</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">STO S</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A &#8594; S(L)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Store the number in the accumulator to the specified memory address <code>S(L)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">001 or 101</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">SUB S</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A - S(L) &#8594; A</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Subtract the number at the specified memory address <code>S(L)</code> from the value in accumulator, and store the result in the accumulator</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">011</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CMP / SKN</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">if A&lt;0 then CI+1&#8594;CI</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Skip next instruction if the accumulator contains a negative value</p></td> </tr> </tbody> </table></div> <div class="paragraph"> <p>The instructions are stored in a memory, which had 32 cells. Each cell was 32 bits long, and each instruction fit into exactly one cell. So each instruction has 32 bits. The bit representation was reversed, so the most and the least significant bits were put on opposite sides. For example, value <code>3</code>, in common personal computers represented as <code>011</code>, was in SSEM represented as <code>110</code>.</p> </div> <div class="paragraph"> <p>The instruction format is as follows:</p> </div> <div class="table-wrapper"><table class="tableblock frame-topbot grid-all spread table table-striped table-condensed"> <caption class="title">Table 1. SSEM Instruction Format</caption> <colgroup> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3333%;"> <col style="width: 8.3337%;"> </colgroup> <tfoot> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Value:</strong></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2^0</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2^31</p></td> </tr> </tfoot> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Bit:</strong></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">01</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">02</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">03</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">04</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">31</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Use:</strong></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> </tr> </tbody> </table></div> <div class="paragraph"> <p>where bits <code>LLLLL</code> denote a "line", which is basically the memory address - index of a memory cell. It can be understood as instruction operand. Bits <code>III</code> specify the instruction opcode (3 bits are enough for 7 instructions).</p> </div> </div> <div class="sect2"> <h3 id="language-specification"> <a href="#language-specification" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Language specification </h3> <div class="paragraph"> <p>Each compiler is just a program which translates an input source code into output code. Usually, the input language is more high level than the output language, and often offers some features, which are not supported by the output language. For example, assembler source codes often support comments, various formats of number literals, labels, or macros. These are features, which are not supported by the instruction set itself, and they must be translated to it by compiler.</p> </div> <div class="paragraph"> <p>SSEM assembler specification can be started with informal expressing, what it will know:</p> </div> <div class="sect3"> <h4 id="COMPILER_TOKEN_CATEGORIES"> <a href="#COMPILER_TOKEN_CATEGORIES" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Token categories </h4> <div class="paragraph"> <p>Tokens, parsed by lexical analyzer have assigned a so-called category. The category is useful mainly for syntax highlighter in emuStudio editor. For example, reserved words are colored differently than e.g. numeric constants, or comments.</p> </div> <div class="paragraph"> <p>The list of all categories can be seen in the following class: <a href="https://github.com/vbmacher/emuLib/blob/branch-9_0/src/main/java/emulib/plugins/compiler/Token.java">Token.java</a>.</p> </div> </div> <div class="sect3"> <h4 id="new-lines"> <a href="#new-lines" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> New-lines </h4> <div class="paragraph"> <p>New-line character (LF, CR, or CRLF) will be required as a delimiter of instructions, and as the last character. Successive empty new-line characters will be ignored.</p> </div> </div> <div class="sect3"> <h4 id="instructions"> <a href="#instructions" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Instructions </h4> <div class="paragraph"> <p>Assembler will support all forms of instructions shown in the table in section <a href="#COMPILER_SSEM_ASM">Assembler for SSEM</a>. All instructions must start with a line number. For example:</p> </div> <div class="literalblock"> <div class="content"><pre>01 LDN 20</pre></div> </div> <div class="paragraph"> <p>Instructions belong to token category called "reserved words".</p> </div> </div> <div class="sect3"> <h4 id="literals-constants"> <a href="#literals-constants" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Literals / constants </h4> <div class="paragraph"> <p>Raw number constants can be defined in separate lines using special preprocessor keywords. The first one is <code>NUM xxx</code>, where <code>xxx</code> is a number in either decimal or hexadecimal form. Hexadecimal format must start with prefix <code>0x</code>. For example:</p> </div> <div class="literalblock"> <div class="content"><pre>00 NUM 0x20
01 NUM 1207943145</pre></div> </div> <div class="paragraph"> <p>Another keyword is <code>BNUM xxx</code>, where <code>xxx</code> can be only a binary number. For example:</p> </div> <div class="literalblock"> <div class="content"><pre>01 BNUM 10011011111000101111110000111111</pre></div> </div> <div class="paragraph"> <p>It means that the number will be stored untouched to the memory in the format as it appears in the binary form.</p> </div> <div class="paragraph"> <p>There exists also a third keyword, <code>BINS xxx</code>, with the exact meaning as <code>BNUM</code>. The reason for its presence is to be compatible with most of the programs <a href="http://www.cs.ubc.ca/~hilpert/e/SSEM/programs/noodle.html">found on internet</a>.</p> </div> <div class="paragraph"> <p>For all constants, the following rules hold. Only integral constants are supported, and the allowed range is from 0 - 31 (maximum is 2^5).</p> </div> <div class="paragraph"> <p>Word <code>NUM</code>, <code>BNUM</code> and <code>BINS</code> keywords belong to "preprocessor" category, but number constants to the category called "literals".</p> </div> </div> <div class="sect3"> <h4 id="comments"> <a href="#comments" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Comments </h4> <div class="paragraph"> <p>Only one-line comments will be supported, but of various forms. Generally, comment will be everything starting with some prefix until the end of the line. Comment prefixes are:</p> </div> <div class="ulist"> <ul> <li> <p>Double-slash (<code>//</code>)</p> </li> <li> <p>Semi-colon (<code>;</code>)</p> </li> <li> <p>Double-dash (<code>--</code>)</p> </li> </ul> </div> <div class="paragraph"> <p>The token category of comments is "comments".</p> </div> </div> <div class="sect3"> <h4 id="full-example"> <a href="#full-example" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Full example </h4> <div class="paragraph"> <p>For example, simple <code>5+3</code> addition can be implemented as follows:</p> </div> <div class="literalblock"> <div class="content"><pre>0 LDN 7 // load negative X into the accumulator
1 SUB 8 // subtract Y from the value in the accumulator
2 STO 9 // store the sum at address 7
3 LDN 9 // A = -(-Sum)
4 STO 9 // store sum
5 HLT</pre></div> </div> <div class="literalblock"> <div class="content"><pre>7 NUM 3 // X
8 NUM 5 // Y
9       // here will be the result</pre></div> </div> <div class="paragraph"> <p>The accumulator should now contain value <code>8</code>, as well as memory cell at index 9.</p> </div> </div> </div> <div class="sect2"> <h3 id="preparing-the-environment"> <a href="#preparing-the-environment" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Preparing the environment </h3> <div class="paragraph"> <p>In order to start developing the compiler, create new Java project in your favorite IDE. In emuStudio, Maven is used for dependencies management. If you&#8217;re not familiar with Maven, you can start <a href="https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html">here</a>.</p> </div> <div class="paragraph"> <p>The compiler will be implemented as another standard emuStudio plug-in in standard path <code>plugins/compilers/as-ssem</code>. It will inherit all Maven plug-in dependencies from the main POM file.</p> </div> <div class="paragraph"> <p>The directory structure is "dictated" by Maven, so it should look as follows:</p> </div> <div class="literalblock"> <div class="content"><pre>src/
  main/
    java/
    resources/
test/
  java/
pom.xml</pre></div> </div> <div class="admonitionblock note"> <div class="table-wrapper"><table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Note the naming of the plug-in. We are following the naming convention as described in the <a href="#INTRODUCTION_NAMING">[INTRODUCTION_NAMING]</a> guide. </td> </tr> </table></div> </div> <div class="paragraph"> <p>The POM file of the project looks as follows:</p> </div> <div class="listingblock"> <div class="title"><code>pom.xml</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="xml"><span style="color: #BC7A00">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;project</span> <span style="color: #7D9029">xmlns=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
         <span style="color: #7D9029">xmlns:xsi=</span><span style="color: #BA2121">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span style="color: #7D9029">xsi:schemaLocation=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;parent&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emustudio-parent<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;version&gt;</span>0.39<span style="color: #008000; font-weight: bold">&lt;/version&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;relativePath&gt;</span>../../../pom.xml<span style="color: #008000; font-weight: bold">&lt;/relativePath&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/parent&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;modelVersion&gt;</span>4.0.0<span style="color: #008000; font-weight: bold">&lt;/modelVersion&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>as-ssem<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;name&gt;</span>SSEM Assembler<span style="color: #008000; font-weight: bold">&lt;/name&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;description&gt;</span>Assembler of SSEM processor language<span style="color: #008000; font-weight: bold">&lt;/description&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;build&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;finalName&gt;</span>as-ssem<span style="color: #008000; font-weight: bold">&lt;/finalName&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;plugins&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-jar-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;archive&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;manifest&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addClasspath&gt;</span>false<span style="color: #008000; font-weight: bold">&lt;/addClasspath&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;mainClass&gt;</span>net.sf.emustudio.ssem.assembler.Main<span style="color: #008000; font-weight: bold">&lt;/mainClass&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultImplementationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultImplementationEntries&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultSpecificationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultSpecificationEntries&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/manifest&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;manifestEntries&gt;</span>
              <span style="color: #408080; font-style: italic">&lt;!-- DO NOT REMOVE THESE DEPENDENCIES; COMMAND LINE THEN WON&#39;T WORK --&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;Class-Path&gt;</span>lib/java-cup-runtime-${javacup.version}.jar lib/emuLib-${emulib.version}.jar lib/slf4j-api-${slf4j.version}.jar<span style="color: #008000; font-weight: bold">&lt;/Class-Path&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/manifestEntries&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/archive&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-dependency-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>de.jflex<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>jflex-maven-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;executions&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;execution&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;goals&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;goal&gt;</span>generate<span style="color: #008000; font-weight: bold">&lt;/goal&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/goals&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/execution&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/executions&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>com.github.vbmacher<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>cup-maven-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;executions&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;execution&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;goals&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;goal&gt;</span>generate<span style="color: #008000; font-weight: bold">&lt;/goal&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/goals&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/execution&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/executions&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;className&gt;</span>ParserImpl<span style="color: #008000; font-weight: bold">&lt;/className&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;symbolsName&gt;</span>Symbols<span style="color: #008000; font-weight: bold">&lt;/symbolsName&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/plugins&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/build&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;dependencies&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.slf4j<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>slf4j-api<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emuLib<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>com.github.vbmacher<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>java-cup-runtime<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.easymock<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>easymock<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>cpu-testsuite<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;scope&gt;</span>test<span style="color: #008000; font-weight: bold">&lt;/scope&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/dependencies&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/project&gt;</span></code></pre></div> </div> </div> <div class="sect2"> <h3 id="lexical-analyzer-lexer"> <a href="#lexical-analyzer-lexer" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Lexical analyzer (lexer) </h3> <div class="paragraph"> <p>We will start with definition of the lexer specfile. It is a special file, which will be given to <a href="http://jflex.de/">JFlex</a> during project compilation. Jflex will generate a Java class - the lexer - which will be used by the parser later, and by emuStudio editor, too. The specification file has special place in the directory structure:</p> </div> <div class="literalblock"> <div class="content"><pre>src/
  main/
    jflex/
      lexer.jflex</pre></div> </div> <div class="admonitionblock note"> <div class="table-wrapper"><table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Note that the specfile is not put into resources directory. If it was so, then it would be included in the final JAR file. </td> </tr> </table></div> </div> <div class="paragraph"> <p>JFlex will be called during compilation of the assembler by the <a href="http://jflex.sourceforge.net/maven-jflex-plugin/generate-mojo.html">JFlex Maven plugin</a> (see the POM file above). The content of the specfile is as follows:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/jflex/ssem.jflex</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="flex">package net.sf.emustudio.ssem.assembler;

import emulib.plugins.compiler.LexicalAnalyzer;
import emulib.plugins.compiler.Token;
import emulib.runtime.NumberUtils;
import emulib.runtime.RadixUtils;

import java.io.IOException;
import java.io.Reader;
import java.util.Arrays;

%%

/* options */
%class LexerImpl
%cup
%public
%implements LexicalAnalyzer, Symbols
%line
%column
%char
%caseless
%unicode
%type TokenImpl

%{
    @Override
    public Token getSymbol() throws IOException {
        return next_token();
    }

    @Override
    public void reset(Reader in, int yyline, int yychar, int yycolumn) {
        yyreset(in);
        this.yyline = yyline;
        this.yychar = yychar;
        this.yycolumn = yycolumn;
    }

    @Override
    public void reset() {
        this.yyline = 0;
        this.yychar = 0;
        this.yycolumn = 0;
    }

    private TokenImpl token(int type, int category) {
        return new TokenImpl(type, category, yytext(), yyline, yycolumn, yychar);
    }

    private TokenImpl token(int type, int category, Object value) {
        return new TokenImpl(type, category, yytext(), yyline, yycolumn, yychar, value);
    }
%}

%eofval{
    return token(EOF, Token.TEOF);
%eofval}

comment = &quot;//&quot;[^\r\n]*
comment2 = &quot;--&quot;[^\r\n]*
comment3 = &quot;;&quot;[^\r\n]*
eol = \r|\n|\r\n
space = [ \t\f]+
number = \-?[0-9]+
hexnumber = \-?0x[0-9a-fA-F]+
binnumber = [01]+

%xstate BIN

%%

&lt;YYINITIAL&gt; {
    /* reserved words */
    &quot;jmp&quot; {
        return token(JMP, Token.RESERVED);
    }
    &quot;jrp&quot; {
        return token(JPR, Token.RESERVED);
    }
    &quot;jpr&quot; {
        return token(JPR, Token.RESERVED);
    }
    &quot;jmr&quot; {
        return token(JPR, Token.RESERVED);
    }
    &quot;ldn&quot; {
        return token(LDN, Token.RESERVED);
    }
    &quot;sto&quot; {
        return token(STO, Token.RESERVED);
    }
    &quot;sub&quot; {
        return token(SUB, Token.RESERVED);
    }
    &quot;cmp&quot; {
        return token(CMP, Token.RESERVED);
    }
    &quot;skn&quot; {
        return token(CMP, Token.RESERVED);
    }
    &quot;stp&quot; {
        return token(STP, Token.RESERVED);
    }
    &quot;hlt&quot; {
        return token(STP, Token.RESERVED);
    }

    /* special */
    &quot;start:&quot; {
        return token(START, Token.PREPROCESSOR);
    }
    &quot;num&quot; {
        return token(NUM, Token.PREPROCESSOR);
    }
    &quot;bnum&quot; {
        yybegin(BIN);
        return token(BNUM, Token.PREPROCESSOR);
    }
    &quot;bins&quot; {
        yybegin(BIN);
        return token(BNUM, Token.PREPROCESSOR);
    }

    /* comment */
    {comment} {
        return token(TCOMMENT, Token.COMMENT);
    }
    {comment2} {
        return token(TCOMMENT, Token.COMMENT);
    }
    {comment3} {
        return token(TCOMMENT, Token.COMMENT);
    }

    /* literals */
    {number} {
        int num = Integer.parseInt(yytext(), 10);
        return token(NUMBER, Token.LITERAL, num);
    }

    {hexnumber} {
        int num = Integer.decode(yytext());
        return token(NUMBER, Token.LITERAL, num);
    }
}

/* separators */
&lt;YYINITIAL, BIN&gt; {eol} {
    return token(SEPARATOR_EOL, Token.SEPARATOR);
}
&lt;YYINITIAL, BIN&gt; {space} { /* ignore white spaces */ }

&lt;BIN&gt; {

    {binnumber} {
        yybegin(YYINITIAL);

        byte[] numberArray = RadixUtils.convertToNumber(yytext(), 2, 4);
        int num = NumberUtils.reverseBits(
            NumberUtils.readInt(
                NumberUtils.toObjectArray(numberArray), NumberUtils.Strategy.LITTLE_ENDIAN
            ), 32
        );

        return token(NUMBER, Token.LITERAL, num);
    }

    [^] {
        yybegin(YYINITIAL);
    }

}

/* error fallback */
[^] {
    return token(ERROR_UNKNOWN_TOKEN, Token.ERROR);
}</code></pre></div> </div> <div class="paragraph"> <p>As you can notice, the specfile uses special class named <code>TokenImpl</code>. We must implement this class by ourselves. It holds the basic information about the parsed token, like offset, length, type, etc. There are several requirements when implementing the class:</p> </div> <div class="ulist"> <ul> <li> <p>It must extend <code>java_cup.runtime.Symbol</code> class, for JFlex - cup interoperability.</p> </li> <li> <p>It must implement <code>emulib.plugins.compiler.Token</code> interface, for being able to use this class in emuStudio syntax highlighter</p> </li> <li> <p>It&#8217;s now a secret, but it would have to implement also special <code>Symbols</code> interface, which will be generated by parser, described in section below.</p> </li> </ul> </div> <div class="paragraph"> <p>Syntax highlighter in emuStudio represents the source code in a dynamic "lexical tree". It scans regularly required text blocks in the editor and translates them into the symbolic representation - into tokens, which are arranged in a tree structure. Tokens are parsed by the lexer, provided by us. And <code>Token</code> interface is the shared API known by our specific lexer and general syntax highlighter in emuStudio.</p> </div> <div class="paragraph"> <p>Tokens are assigned into categories, as was already mentioned in section <a href="#COMPILER_TOKEN_CATEGORIES">Token categories</a>. Token categories have assigned their specific editor style, like color or font.</p> </div> <div class="paragraph"> <p>The content of the <code>net.sf.emustudio.ssem.assembler.TokenImpl</code> class is as follows:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/TokenImpl.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.Token</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java_cup.runtime.ComplexSymbolFactory</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TokenImpl</span> <span style="color: #008000; font-weight: bold">extends</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">ComplexSymbol</span> <span style="color: #008000; font-weight: bold">implements</span> Token<span style="color: #666666">,</span> Symbols <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">int</span> category<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">int</span> cchar<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">TokenImpl</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> id<span style="color: #666666">,</span> <span style="color: #B00040">int</span> category<span style="color: #666666">,</span> String text<span style="color: #666666">,</span> <span style="color: #B00040">int</span> line<span style="color: #666666">,</span> <span style="color: #B00040">int</span> column<span style="color: #666666">,</span> <span style="color: #B00040">int</span> cchar<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>
            text<span style="color: #666666">,</span> id<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">Location</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> column<span style="color: #666666">),</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">Location</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> column<span style="color: #666666">)</span>
        <span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">category</span> <span style="color: #666666">=</span> category<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">cchar</span> <span style="color: #666666">=</span> cchar<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">TokenImpl</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> id<span style="color: #666666">,</span> <span style="color: #B00040">int</span> category<span style="color: #666666">,</span> String text<span style="color: #666666">,</span> <span style="color: #B00040">int</span> line<span style="color: #666666">,</span> <span style="color: #B00040">int</span> column<span style="color: #666666">,</span> <span style="color: #B00040">int</span> cchar<span style="color: #666666">,</span> Object value<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>
            text<span style="color: #666666">,</span> id<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">Location</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> column<span style="color: #666666">),</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">Location</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> column<span style="color: #666666">),</span> value
        <span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">category</span> <span style="color: #666666">=</span> category<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">cchar</span> <span style="color: #666666">=</span> cchar<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getID</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">sym</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getType</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> category<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getLine</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">getLeft</span><span style="color: #666666">().</span><span style="color: #7D9029">getLine</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getColumn</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">getLeft</span><span style="color: #666666">().</span><span style="color: #7D9029">getColumn</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getOffset</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> cchar<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getLength</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> getName<span style="color: #666666">().</span><span style="color: #7D9029">length</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getErrorString</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;Unknown token&quot;</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getText</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> getName<span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isInitialLexicalState</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">sym</span> <span style="color: #666666">!=</span> BNUM<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> </div> <div class="sect2"> <h3 id="COMPILER_GRAMMAR"> <a href="#COMPILER_GRAMMAR" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Syntax analyzer (parser) </h3> <div class="paragraph"> <p>Next, we define the grammar file. It is also a special file, which will be given to cup during project compilation. Cup will generate Java classes - the parser - which we will use in our code. The specfile has special place in the directory structure:</p> </div> <div class="literalblock"> <div class="content"><pre>src/
  main/
    cup/
      parser.cup</pre></div> </div> <div class="paragraph"> <p>Grammar type and form we use depends on the parsing algorithm we choose. In emuStudio, all compilers use <a href="http://www2.cs.tum.edu/projects/cup/">Java cup</a> parser generator, which does bottom-up parsing, and supported grammars are of type LALR.</p> </div> <div class="paragraph"> <p>The main difference between LL and LALR grammars is that in LALR you can freely use left-recursion, but not right recursion. Otherwise you would get shift/reduce conflicts. For more information, see for example <a href="https://lambda.uta.edu/cse5317/notes/node21.html">this site</a>.</p> </div> <div class="paragraph"> <p>The grammar specfile of SSEM assembler parser follows:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/cup/parser.cup</code></div> <div class="content"><pre class="pygments highlight"><code>package net.sf.emustudio.ssem.assembler;

import emulib.plugins.compiler.Message;
import emulib.plugins.compiler.Token;
import java_cup.runtime.ComplexSymbolFactory;
import java_cup.runtime.Symbol;
import net.sf.emustudio.ssem.assembler.tree.ASTnode;
import net.sf.emustudio.ssem.assembler.tree.Constant;
import net.sf.emustudio.ssem.assembler.tree.Instruction;
import net.sf.emustudio.ssem.assembler.tree.Program;

import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

parser code {:
    private LexerImpl lexer;
    private boolean syntaxErrors;
    private CompilerImpl compiler;

    public ParserImpl(LexerImpl lex, ComplexSymbolFactory csf, CompilerImpl compiler) {
        super(lex, csf);
        lexer = Objects.requireNonNull(lex);
        this.compiler = Objects.requireNonNull(compiler);
    }

    @Override
    public void report_fatal_error(String message, Object info) throws Exception {
        done_parsing();
        report_error(message, info);
        throw new Exception("Can\'t recover from previous error(s)");
    }

    @Override
    public void report_error(String messageText, Object current) {
        syntaxErrors = true;

        Token token = (Token)current;

        messageText += ":" + token.getErrorString() + " ('" + token.getText() + "')";

        List expectedTokenIds = expected_token_ids()
            .stream()
            .map(id -&gt; symbl_name_from_id(id.intValue()))
            .collect(Collectors.toList());

        if (!expectedTokenIds.isEmpty()) {
            messageText += "\nExpected tokens: " + expectedTokenIds;
        }

        Message message = new Message(
            Message.MessageType.TYPE_ERROR, messageText, token.getLine()+1, token.getColumn(), null, 0
        );

        if (compiler != null) {
            compiler.notifyOnMessage(message);
        } else {
            System.err.println(message.getFormattedMessage());
        }
    }

    public boolean hasSyntaxErrors() {
        return syntaxErrors;
    }

:};

terminal JMP, JPR, LDN, STO, SUB, CMP, STP, NUM, BNUM;
terminal SEPARATOR_EOL, TCOMMENT, ERROR_UNKNOWN_TOKEN;
terminal Integer NUMBER;
terminal START;

non terminal Program Program;
non terminal ASTnode Statement;
non terminal Instruction Instruction;
non terminal Constant Constant;
non terminal Comment;

start with Program;

Program ::= NUMBER:c Statement:s Program:p              {: if (s != null) p.statement(c, s); RESULT = p;  :}
    | NUMBER:c Comment SEPARATOR_EOL Program:p          {: RESULT = p; :}
    | Comment SEPARATOR_EOL Program:p                   {: RESULT = p; :}
    | START SEPARATOR_EOL Program:p                     {: p.nextLineStarts(); RESULT = p; :}
    | /* empty program */                               {: RESULT = new Program(); :}
    ;

Statement ::= Instruction:i Comment SEPARATOR_EOL       {: RESULT = i; :}
    | Constant:c Comment SEPARATOR_EOL                  {: RESULT = c; :}
    ;

Instruction ::= JMP NUMBER:line             {: RESULT = Instruction.jmp(line); :}
    | JPR NUMBER:line                       {: RESULT = Instruction.jrp(line); :}
    | LDN NUMBER:line                       {: RESULT = Instruction.ldn(line); :}
    | STO NUMBER:line                       {: RESULT = Instruction.sto(line); :}
    | SUB NUMBER:line                       {: RESULT = Instruction.sub(line); :}
    | CMP                                   {: RESULT = Instruction.cmp(); :}
    | STP                                   {: RESULT = Instruction.stp(); :}
    | error
    ;

Constant ::= NUM NUMBER:raw                 {: RESULT = new Constant(raw); :}
    | BNUM NUMBER:raw                       {: RESULT = new Constant(raw); :}
    ;

Comment ::= TCOMMENT
    | /* no comment*/
    ;</code></pre></div> </div> <div class="paragraph"> <p>The right sides - code snippets wrapped between <code>{:</code> and <code>:}</code> - is Java code which will be executed when particular rule of the grammar is applied. Remember, that they will be applied in reverse - first will be applied the right-most rules.</p> </div> <div class="paragraph"> <p>There exist a special variable <code>RESULT</code>, which should return some Java object of type which the non-terminal defines for it <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>.</p> </div> <div class="paragraph"> <p>For more information, especially about the <code>error</code> symbol, please read <a href="http://www2.cs.tum.edu/projects/cup/">cup</a> documentation.</p> </div> </div> <div class="sect2"> <h3 id="COMPILER_AST"> <a href="#COMPILER_AST" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Introducing AST </h3> <div class="paragraph"> <p>The code won&#8217;t compile so far. The reason is that the parser strangely uses some undefined classes, such as <code>Program</code>, <code>ASTnode</code>, <code>Instruction</code> and <code>Constant</code>. They are defined in the grammar file as follows (see above):</p> </div> <div class="literalblock"> <div class="content"><pre>non terminal Program Program;
non terminal ASTnode Statement;
non terminal Instruction Instruction;
non terminal Constant Constant;</pre></div> </div> <div class="paragraph"> <p>These classes are part of so-called abstract syntax tree, and they wait for our implementation. Abstract Syntax Tree (or AST) is a "symbolic" representation of the parsed program source code. The parser creates one as a side-effect of parsing. It is different from Parse Syntax Tree (PST), which represents a tree of true grammar derivations which were "detected" by the parser for given source code of a program.</p> </div> <div class="paragraph"> <p>AST is something more artificial, ie. not all grammar rules need to be taken into account when representing the program. For this reason, we define only some "nodes" of the derivation tree. In our case, it is <code>Program</code>, representing the "root" of the tree, which has children - `Statement`s. Statements have `Instruction`s or `Constant`s as its children.</p> </div> <div class="paragraph"> <p>Do you remember those code snippets in the grammar specfile wrapped in <code>{: &#8230;&#8203; :}</code> ? This code snippets create the AST, just follow them.</p> </div> <div class="paragraph"> <p>It&#8217;s now time to implement them. Since we know all nodes are just nodes of our AST, we should define common <code>ASTnode</code> interface first:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/tree/ASTnode.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">interface</span> <span style="color: #0000FF; font-weight: bold">ASTnode</span> <span style="color: #666666">{</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">accept</span><span style="color: #666666">(</span>ASTvisitor visitor<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception<span style="color: #666666">;</span>

<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>This interface will be useful when we will traverse the tree. For tree traversal it is very well-suited the <a href="https://sourcemaking.com/design_patterns/visitor">Visitor pattern</a>. The idea of traversing a tree using visitor pattern is to have the "visitor" object - which represents an object which wants to go through all nodes of the tree and do something. The algorithm of visiting is based on a premise that each node of the AST implements the <code>accept()</code> method. That way, each node is responsible for calling the visitor for each its children and itself. So the effect is that the "visitor" will "get" the all tree node objects, when the <code>accept()</code> method is called on the root of the tree.</p> </div> <div class="paragraph"> <p>We can now define the visitor interface as follows:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/tree/ASTvisitor.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">interface</span> <span style="color: #0000FF; font-weight: bold">ASTvisitor</span> <span style="color: #666666">{</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">setCurrentLine</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">);</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Instruction instruction<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception<span style="color: #666666">;</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Constant constant<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception<span style="color: #666666">;</span>

<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>The methods of the visitor will be implemented by some visitor, for example a code generator. However, we need to finish implementation of the AST first.</p> </div> <div class="sect3"> <h4 id="program-node"> <a href="#program-node" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 'Program' node </h4> <div class="paragraph"> <p>The root node of the AST is the <code>Program</code> class. According to the grammar, it contains all the statements, which are either <code>Instruction</code> or <code>Constant</code>. Notice how we implemented traversing of the node:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/tree/Program.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.HashMap</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Map</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Program</span> <span style="color: #008000; font-weight: bold">implements</span> ASTnode <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> Map<span style="color: #666666">&lt;</span>Integer<span style="color: #666666">,</span> ASTnode<span style="color: #666666">&gt;</span> nodes <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> HashMap<span style="color: #666666">&lt;&gt;();</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> startLine <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> previousLine <span style="color: #666666">=</span> <span style="color: #666666">0;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">statement</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">,</span> ASTnode node<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        previousLine <span style="color: #666666">=</span> line<span style="color: #666666">;</span>
        nodes<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> node<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">nextLineStarts</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">startLine</span> <span style="color: #666666">=</span> previousLine<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getStartLine</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> startLine<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">accept</span><span style="color: #666666">(</span>ASTvisitor visitor<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span>Map<span style="color: #666666">.</span><span style="color: #7D9029">Entry</span><span style="color: #666666">&lt;</span>Integer<span style="color: #666666">,</span> ASTnode<span style="color: #666666">&gt;</span> node <span style="color: #666666">:</span> nodes<span style="color: #666666">.</span><span style="color: #7D9029">entrySet</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
            visitor<span style="color: #666666">.</span><span style="color: #7D9029">setCurrentLine</span><span style="color: #666666">(</span>node<span style="color: #666666">.</span><span style="color: #7D9029">getKey</span><span style="color: #666666">());</span>
            node<span style="color: #666666">.</span><span style="color: #7D9029">getValue</span><span style="color: #666666">().</span><span style="color: #7D9029">accept</span><span style="color: #666666">(</span>visitor<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>The important note is that how the statements are stored. They are in fact the children of the program node. For this purpose a key-value map is used. Key has type <code>Integer</code> and it represents the line - or memory cell index, or address - on which the statement will be located. That way we can write several instructions which lie on the same line, e.g.:</p> </div> <div class="literalblock"> <div class="content"><pre>01 LDN 15
01 STO 06</pre></div> </div> <div class="paragraph"> <p>which will be translated into two statements, but the program node will contain just the last one. The reason is that they share the line - <code>01</code> - which is the key in the map of statements, so the first statement will be "overwritten" by the second one.</p> </div> <div class="paragraph"> <p>It is for a debate if we want this behavior to happen. For simplicity, we allow it. Otherwise we would throw some compiler exception.</p> </div> </div> <div class="sect3"> <h4 id="instruction-node"> <a href="#instruction-node" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 'Instruction' node </h4> <div class="paragraph"> <p>Instruction node represents the instruction. If you remember, each instruction except <code>STP</code> and <code>CMP</code> has a parameter, or better - operand - which is a "line" - index of a memory cell. It would be possible to represent specific instructions by separate classes, but since the required operations would be shared, it would be much easier to have just one class for all the instructions. Generally, instructions with same number and type of parameters are usually implemented in one AST node.</p> </div> <div class="paragraph"> <p>Here&#8217;s the source code:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/tree/Instruction.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.CompileException</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Optional</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Instruction</span> <span style="color: #008000; font-weight: bold">implements</span> ASTnode <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> JMP <span style="color: #666666">=</span> <span style="color: #666666">0;</span> <span style="color: #408080; font-style: italic">// 000</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> JRP <span style="color: #666666">=</span> <span style="color: #666666">4;</span> <span style="color: #408080; font-style: italic">// 100</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> LDN <span style="color: #666666">=</span> <span style="color: #666666">2;</span> <span style="color: #408080; font-style: italic">// 010</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> STO <span style="color: #666666">=</span> <span style="color: #666666">6;</span> <span style="color: #408080; font-style: italic">// 110</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> SUB <span style="color: #666666">=</span> <span style="color: #666666">1;</span> <span style="color: #408080; font-style: italic">// 001</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> CMP <span style="color: #666666">=</span> <span style="color: #666666">3;</span> <span style="color: #408080; font-style: italic">// 011</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> STP <span style="color: #666666">=</span> <span style="color: #666666">7;</span> <span style="color: #408080; font-style: italic">// 111</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> String<span style="color: #666666">[]</span> INSTRUCTION_STRING <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> String<span style="color: #666666">[]</span> <span style="color: #666666">{</span>
        <span style="color: #BA2121">&quot;JMP&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;SUB&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;LDN&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;CMP&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;JRP&quot;</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;STO&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;STP&quot;</span>
    <span style="color: #666666">};</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">int</span> opcode<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> Optional<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> operand<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #0000FF">Instruction</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> opcode<span style="color: #666666">,</span> <span style="color: #B00040">int</span> operand<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>operand <span style="color: #666666">&gt;</span> <span style="color: #666666">31</span> <span style="color: #666666">||</span> operand <span style="color: #666666">&lt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> CompileException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Instruction operand must be in range &lt;0,31&gt;!&quot;</span><span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">operand</span> <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">of</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)(</span>operand <span style="color: #666666">&amp;</span> <span style="color: #666666">0xFF));</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">opcode</span> <span style="color: #666666">=</span> opcode<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #0000FF">Instruction</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> opcode<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">operand</span> <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">empty</span><span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">opcode</span> <span style="color: #666666">=</span> opcode<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getOpcode</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> opcode<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> Optional<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> <span style="color: #0000FF">getOperand</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> operand<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">jmp</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>JMP<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">jrp</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>JRP<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">ldn</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>LDN<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">sto</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>STO<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">sub</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>SUB<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">cmp</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>CMP<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">stp</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>STP<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">accept</span><span style="color: #666666">(</span>ASTvisitor visitor<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
         visitor<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">equals</span><span style="color: #666666">(</span>Object o<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span> <span style="color: #666666">==</span> o<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>o <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">||</span> getClass<span style="color: #666666">()</span> <span style="color: #666666">!=</span> o<span style="color: #666666">.</span><span style="color: #7D9029">getClass</span><span style="color: #666666">())</span> <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>

        Instruction that <span style="color: #666666">=</span> <span style="color: #666666">(</span>Instruction<span style="color: #666666">)</span> o<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">return</span> opcode <span style="color: #666666">==</span> that<span style="color: #666666">.</span><span style="color: #7D9029">opcode</span> <span style="color: #666666">&amp;&amp;</span> operand<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span>that<span style="color: #666666">.</span><span style="color: #7D9029">operand</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">hashCode</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> result <span style="color: #666666">=</span> opcode<span style="color: #666666">;</span>
        result <span style="color: #666666">=</span> <span style="color: #666666">31</span> <span style="color: #666666">*</span> result <span style="color: #666666">+</span> operand<span style="color: #666666">.</span><span style="color: #7D9029">hashCode</span><span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">return</span> result<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">toString</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> INSTRUCTION_STRING<span style="color: #666666">[</span>opcode<span style="color: #666666">]</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; &quot;</span> <span style="color: #666666">+</span> operand<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>Note that the constructor is private. The implication is that it is just impossible to create some invalid <code>Instruction</code> object. The only possible way how to define it is using static factory methods, which represent the instructions themselves. These are called from the parser - check the grammar specfile in the section <a href="#COMPILER_GRAMMAR">Syntax analyzer (parser)</a>.</p> </div> <div class="paragraph"> <p>Also, note that we can compare instructions based on opcode and operand. This is allowed by custom implementations of methods <code>hashCode()</code> and <code>equals()</code>.</p> </div> </div> <div class="sect3"> <h4 id="constant-node"> <a href="#constant-node" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 'Constant' node </h4> <div class="paragraph"> <p>Another kind of statement is a constant. The constant is just a number, and the node class is very simple:</p> </div> <div class="listingblock"> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Constant</span> <span style="color: #008000; font-weight: bold">implements</span> ASTnode <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">int</span> number<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">Constant</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> number<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">number</span> <span style="color: #666666">=</span> number<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">accept</span><span style="color: #666666">(</span>ASTvisitor visitor<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        visitor<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getNumber</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> number<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">equals</span><span style="color: #666666">(</span>Object o<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span> <span style="color: #666666">==</span> o<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>o <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">||</span> getClass<span style="color: #666666">()</span> <span style="color: #666666">!=</span> o<span style="color: #666666">.</span><span style="color: #7D9029">getClass</span><span style="color: #666666">())</span> <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>

        Constant constant <span style="color: #666666">=</span> <span style="color: #666666">(</span>Constant<span style="color: #666666">)</span> o<span style="color: #666666">;</span>

        <span style="color: #008000; font-weight: bold">return</span> number <span style="color: #666666">==</span> constant<span style="color: #666666">.</span><span style="color: #7D9029">number</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">hashCode</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> number<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>Comparing <code>Constant</code> instances is based on comparing the numbers they represent.</p> </div> </div> </div> <div class="sect2"> <h3 id="testing"> <a href="#testing" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Testing </h3> <div class="paragraph"> <p>It is very good practice to write automated tests. These will give us some level of confidence that what we did so far is actually working. It is the earliest feedback we can get on our work, which consequently improves the speed of creating sofware which actually works.</p> </div> <div class="paragraph"> <p>A unit test is just a normal class which contains test methods. A test method generally creates the testing object, does the testing operation and finally check if the operation did what it should. Each test method should test just one thing and should be short and clear. It is good practice to name test method according to the test case, possibly resulting in a whole sentence, in camel case.</p> </div> <div class="paragraph"> <p>Java projects use some unit testing framework for that, e.g. JUnit or TestNG, which recognizes those classes automatically and runs the test methods during the compilation of the project. If a test fails, the whole compilation is stopped as failed.</p> </div> <div class="paragraph"> <p>For lexer and parser we create unit test classes, which will be placed here (following to Maven directory structure):</p> </div> <div class="literalblock"> <div class="content"><pre>src/
  test/
    java/
      net/
        sf/
          emustudio/
            ssem/
              assembler/
                LexerTest.java
                ParserTest.java</pre></div> </div> <div class="paragraph"> <p>The content of the test classes are as follows:</p> </div> <div class="listingblock"> <div class="title"><code>src/test/java/net/sf/emustudio/ssem/assembler/LexerTest.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.Token</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.Test</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.StringReader</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertEquals</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertFalse</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">LexerTest</span> <span style="color: #666666">{</span>

    LexerImpl <span style="color: #0000FF">lexer</span><span style="color: #666666">(</span>String tokens<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> LexerImpl<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> StringReader<span style="color: #666666">(</span>tokens<span style="color: #666666">));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testNumberUpperBoundary</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;31&quot;</span><span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(31,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">value</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testNumberLowerBoundary</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(0,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">value</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testNumber</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;22&quot;</span><span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(22,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">value</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">checkInstruction</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> id<span style="color: #666666">,</span> LexerImpl lexer<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">RESERVED</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>id<span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">checkInstructionWithOperand</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> id<span style="color: #666666">,</span> LexerImpl lexer<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        checkInstruction<span style="color: #666666">(</span>id<span style="color: #666666">,</span> lexer<span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionsWithOperand</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">JMP</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;jmp 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">JPR</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;jrp 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">JPR</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;jpr 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">JPR</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;jmr 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">LDN</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;ldn 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">STO</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;sto 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">SUB</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;sub 12&quot;</span><span style="color: #666666">));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionsWithoutOperand</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        checkInstruction<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">CMP</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;cmp&quot;</span><span style="color: #666666">));</span>
        checkInstruction<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">CMP</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;skn&quot;</span><span style="color: #666666">));</span>
        checkInstruction<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">STP</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;stp&quot;</span><span style="color: #666666">));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionInComment</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;// cmp&quot;</span><span style="color: #666666">);</span>
        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>

        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">TCOMMENT</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">COMMENT</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>

        token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">TEOF</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">EOF</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testBinaryNumber</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;BNUM 10011011111000101111110000111111\n&quot;</span><span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">PREPROCESSOR</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">BNUM</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertFalse<span style="color: #666666">(</span>token<span style="color: #666666">.</span><span style="color: #7D9029">isInitialLexicalState</span><span style="color: #666666">());</span>

        token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> <div class="listingblock"> <div class="title"><code>src/test/java/net/sf/emustudio/ssem/assembler/ParserTest.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java_cup.runtime.ComplexSymbolFactory</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.ASTvisitor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Constant</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Instruction</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Program</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.Test</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.StringReader</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Arrays</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Deque</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.LinkedList</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertEquals</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertFalse</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertTrue</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.fail</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ParserTest</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> ParserImpl <span style="color: #0000FF">program</span><span style="color: #666666">(</span>String program<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> ParserImpl<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> LexerImpl<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> StringReader<span style="color: #666666">(</span>program<span style="color: #666666">)),</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructions</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span>
            <span style="color: #BA2121">&quot;0 cmp // comment\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;1 stp\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;2 jmp 22\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;3 jrp 0\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;4 ldn 31\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;5 sto 10\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;6 sub 15\n&quot;</span>
        <span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>

        Deque<span style="color: #666666">&lt;</span>Instruction<span style="color: #666666">&gt;</span> expectedInstructions <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> LinkedList<span style="color: #666666">&lt;&gt;(</span>Arrays<span style="color: #666666">.</span><span style="color: #7D9029">asList</span><span style="color: #666666">(</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">cmp</span><span style="color: #666666">(),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">stp</span><span style="color: #666666">(),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">jmp</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)22),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">jrp</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)0),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">ldn</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)31),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">sto</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)10),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">sub</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)15)</span>
        <span style="color: #666666">));</span>
        program<span style="color: #666666">.</span><span style="color: #7D9029">accept</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> ASTvisitor<span style="color: #666666">()</span> <span style="color: #666666">{</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setCurrentLine</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>

            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Instruction instruction<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
                assertEquals<span style="color: #666666">(</span>expectedInstructions<span style="color: #666666">.</span><span style="color: #7D9029">removeFirst</span><span style="color: #666666">(),</span> instruction<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Constant constant<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
                fail<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Didn&#39;t expect a constant&quot;</span><span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>
    <span style="color: #666666">}</span>


    <span style="color: #AA22FF">@Test</span><span style="color: #666666">(</span>expected <span style="color: #666666">=</span> Exception<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">)</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionWithoutEOL</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0 jmp 1&quot;</span><span style="color: #666666">);</span>

        parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionWithoutProperArgument</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0 jmp ffff\n&quot;</span><span style="color: #666666">);</span>

        parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">();</span>
        assertTrue<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testConstantIsTranslatedCorrectly</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span>
            <span style="color: #BA2121">&quot;0 NUM 5\n&quot;</span>
        <span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>

        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>
        assertConstant<span style="color: #666666">(</span>program<span style="color: #666666">,</span> <span style="color: #666666">5);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testHexadecimalConstant</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span>
            <span style="color: #BA2121">&quot;0 NUM -0x20\n&quot;</span>
        <span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>

        assertConstant<span style="color: #666666">(</span>program<span style="color: #666666">,</span> <span style="color: #666666">-32);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testStartingPointIsAccepted</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0 jmp 1\nstart:\n3 cmp\n&quot;</span><span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(3,</span> program<span style="color: #666666">.</span><span style="color: #7D9029">getStartLine</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testIndexOfLineThenCommentWorks</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0 --comment\n&quot;</span><span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">assertConstant</span><span style="color: #666666">(</span>Program program<span style="color: #666666">,</span> <span style="color: #B00040">int</span> value<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        program<span style="color: #666666">.</span><span style="color: #7D9029">accept</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> ASTvisitor<span style="color: #666666">()</span> <span style="color: #666666">{</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setCurrentLine</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>

            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Instruction instruction<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
                fail<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Didn&#39;t expect an instruction&quot;</span><span style="color: #666666">);</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Constant constant<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
                assertEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Constant<span style="color: #666666">(</span>value<span style="color: #666666">),</span> constant<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> <div class="admonitionblock note"> <div class="table-wrapper"><table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The tests of parser are based on comparing <code>Instruction</code> and <code>Constant</code> instances with JUnit&#8217;s <code>assertEquals()</code> method. This is possible only because of overriden <code>equals()</code> and <code>hashCode()</code> methods in the classes, since they are used directly by Java when it is comparing the instances. </td> </tr> </table></div> </div> </div> <div class="sect2"> <h3 id="the-main-class"> <a href="#the-main-class" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The main class </h3> <div class="paragraph"> <p>The time has come for implementing the main plug-in class. It will be placed in a package <code>net.sf.emustudio.ssem.assembler</code>, and the class will be named <code>CompilerImpl</code>.</p> </div> <div class="paragraph"> <p>There are several requirements (behavioral contracts) put on the compiler main class:</p> </div> <div class="ulist"> <ul> <li> <p>It must implement <code>emulib.plugins.compiler.Compiler</code> interface. There already exists helper abstract class called <code>emulib.plugins.compiler.AbstractCompiler</code>, which implements some fundamental and general methods. We will use that class.</p> </li> <li> <p>It must be annotated with <code>emulib.annotations.PluginType</code> annotation.</p> </li> <li> <p>The constructor gets two arguments: unique plugin ID (<code>Long</code>) and <code>emulib.runtime.ContextPool</code> object. Both values are created by emuStudio, and we will talk about them later.</p> </li> </ul> </div> <div class="paragraph"> <p>Now, the "skeleton" of the class follows:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/CompilerImpl.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PLUGIN_TYPE</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PluginType</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.AbstractCompiler</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.LexicalAnalyzer</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.SourceFileExtension</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.ContextPool</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.Reader</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>

<span style="color: #AA22FF">@PluginType</span><span style="color: #666666">(</span>
    type <span style="color: #666666">=</span> PLUGIN_TYPE<span style="color: #666666">.</span><span style="color: #7D9029">COMPILER</span><span style="color: #666666">,</span>
    title <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;SSEM Assembler&quot;</span><span style="color: #666666">,</span>
    copyright <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;\u00A9 Copyright 2016, YourName&quot;</span><span style="color: #666666">,</span>
    description <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Assembler of SSEM processor language&quot;</span>
<span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CompilerImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCompiler <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">final</span> SourceFileExtension<span style="color: #666666">[]</span> SOURCE_FILE_EXTENSIONS <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> SourceFileExtension<span style="color: #666666">[]{</span>
        <span style="color: #008000; font-weight: bold">new</span> SourceFileExtension<span style="color: #666666">(</span><span style="color: #BA2121">&quot;ssem&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;SSEM source file&quot;</span><span style="color: #666666">)</span>
    <span style="color: #666666">};</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> ContextPool contextPoolImpl<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">CompilerImpl</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPoolImpl<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">contextPoolImpl</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>contextPoolImpl<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">compile</span><span style="color: #666666">(</span>String inputFileName<span style="color: #666666">,</span> String outputFileName<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #408080; font-style: italic">// TODO !!</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">compile</span><span style="color: #666666">(</span>String inputFileName<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        String outputFileName <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>inputFileName<span style="color: #666666">);</span>
        SourceFileExtension srcExtension <span style="color: #666666">=</span> SOURCE_FILE_EXTENSIONS<span style="color: #666666">[0];</span>

        <span style="color: #B00040">int</span> i <span style="color: #666666">=</span> inputFileName<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;.&quot;</span> <span style="color: #666666">+</span> srcExtension<span style="color: #666666">.</span><span style="color: #7D9029">getExtension</span><span style="color: #666666">());</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>i <span style="color: #666666">&gt;=</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
            outputFileName <span style="color: #666666">=</span> outputFileName<span style="color: #666666">.</span><span style="color: #7D9029">substring</span><span style="color: #666666">(0,</span> i<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> compile<span style="color: #666666">(</span>inputFileName<span style="color: #666666">,</span> outputFileName <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;.bin&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> LexicalAnalyzer <span style="color: #0000FF">getLexer</span><span style="color: #666666">(</span>Reader reader<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> LexerImpl<span style="color: #666666">(</span>reader<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> SourceFileExtension<span style="color: #666666">[]</span> <span style="color: #0000FF">getSourceSuffixList</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> SOURCE_FILE_EXTENSIONS<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">destroy</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">showSettings</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isShowSettingsSupported</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getVersion</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;1.0&quot;</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>Some things are obvious, some maybe not. For example, method <code>getLexer()</code> is called by emuStudio for the syntax highlighter. It is very straightforward - just return new <code>LexerImpl()</code> which was generated by JFlex from our specfile.</p> </div> <div class="paragraph"> <p>Method <code>compile(String)</code> might seem complex at first look. It is "ugly" Java code which tries to check if the given file name ends with our supported file suffix, which is ".ssem". We chose it as the suffix of SSEM source code file. We could chose ".asm" or other extension as well. Then, the "real" <code>compile()</code> method is called with the input file and the output file name, which has suffix ".bin".</p> </div> <div class="paragraph"> <p>Method <code>getSourceSuffixList()</code> returns all supported extensions, and will be used in the file filter in the open file dialog shown in emuStudio.</p> </div> <div class="paragraph"> <p>Compiler can have it&#8217;s own settings dialog (GUI window) which can be shown. This is reflected by the methods <code>isShowSettingsSupported()</code> and <code>showSettings()</code>. Our assembler will not support the dialog.</p> </div> <div class="paragraph"> <p>The "real" <code>compile()</code> method is left to be done in the last section.</p> </div> </div> <div class="sect2"> <h3 id="generating-code"> <a href="#generating-code" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Generating code </h3> <div class="paragraph"> <p>So far, we have implemented a parser which creates our AST. Next operations which compilers do are semantic analysis, optimization and code generation. These three phases are performed on the AST. The algorithms traverse the tree and update some own internal state, or state of the AST based on visited nodes. Code generator at the end take the results, and again - by traversing AST - generates the code.</p> </div> <div class="paragraph"> <p>In our case, we don&#8217;t need any semantic analysis, like type-checks or so, because we have simple machine instructions, which do not require it. We could optimize them, but for the simplicity we will omit this step as well. We will rather focus on the final step - code generation.</p> </div> <div class="paragraph"> <p>You might remember the section <a href="#COMPILER_AST">Introducing AST</a>, which talked about AST traversal. We already have <code>ASTnode</code> and <code>ASTvisitor</code> interfaces. The traversal is already implemented, according to the Visitor pattern, by the nodes themselves. One thing which is left to do is to implement the visitor itself - the code generator class.</p> </div> <div class="paragraph"> <p>For each encountered instruction, the code generator will generate a binary code. Our code generator will write the binary representation into a file. However, it is generally better if I/O classes work with I/O abstractions (streams, channels, etc.) rather than specific objects, e.g. files. Out code generator will be implemented in a similar fashion. The code is as follows:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/CodeGenerator.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.NumberUtils</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.NumberUtils.Strategy</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.ASTvisitor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Constant</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Instruction</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CodeGenerator</span> <span style="color: #008000; font-weight: bold">implements</span> ASTvisitor<span style="color: #666666">,</span> AutoCloseable <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> SeekableOutputStream writer<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> currentLine<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">CodeGenerator</span><span style="color: #666666">(</span>SeekableOutputStream writer<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">writer</span><span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>writer<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setCurrentLine</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">currentLine</span> <span style="color: #666666">=</span> line<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Instruction instruction<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException<span style="color: #666666">,</span> IOException <span style="color: #666666">{</span>
        <span style="color: #B00040">byte</span> address <span style="color: #666666">=</span> instruction<span style="color: #666666">.</span><span style="color: #7D9029">getOperand</span><span style="color: #666666">().</span><span style="color: #7D9029">orElse</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)0);</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>address <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span> <span style="color: #666666">||</span> address <span style="color: #666666">&gt;</span> <span style="color: #666666">31)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> CompileException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Operand must be between &lt;0, 31&gt;; it was &quot;</span> <span style="color: #666666">+</span> address<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>

        <span style="color: #408080; font-style: italic">// Instruction has 32 bits, i.e. 4 bytes</span>
        <span style="color: #B00040">int</span> addressSSEM <span style="color: #666666">=</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">reverseBits</span><span style="color: #666666">(</span>address<span style="color: #666666">,</span> <span style="color: #666666">8)</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">0xF8;</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">seek</span><span style="color: #666666">(4</span> <span style="color: #666666">*</span> currentLine<span style="color: #666666">);</span>

        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>addressSSEM<span style="color: #666666">);</span> <span style="color: #408080; font-style: italic">// address + 3 empty bits</span>

        <span style="color: #408080; font-style: italic">// next: 5 empty bits + 3 bit instruction</span>
        <span style="color: #B00040">int</span> opcode <span style="color: #666666">=</span> instruction<span style="color: #666666">.</span><span style="color: #7D9029">getOpcode</span><span style="color: #666666">()</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">7;</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>opcode<span style="color: #666666">);</span>

        <span style="color: #408080; font-style: italic">// 16 empty bits</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[2]);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Constant constant<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> number <span style="color: #666666">=</span> constant<span style="color: #666666">.</span><span style="color: #7D9029">getNumber</span><span style="color: #666666">();</span>

        writer<span style="color: #666666">.</span><span style="color: #7D9029">seek</span><span style="color: #666666">(4</span> <span style="color: #666666">*</span> currentLine<span style="color: #666666">);</span>
        writeInt<span style="color: #666666">(</span>number<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">writeInt</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> value<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        Byte<span style="color: #666666">[]</span> word <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Byte<span style="color: #666666">[4];</span>
        NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">writeInt</span><span style="color: #666666">(</span>value<span style="color: #666666">,</span> word<span style="color: #666666">,</span> Strategy<span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">);</span>

        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>word<span style="color: #666666">[0]);</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>word<span style="color: #666666">[1]);</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>word<span style="color: #666666">[2]);</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>word<span style="color: #666666">[3]);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">close</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>There are several things to notice:</p> </div> <div class="ulist"> <ul> <li> <p>Output code is written into class <code>SeekableOutputStream</code>. Wi will define this class later.</p> </li> <li> <p><code>CodeGenerator</code> is a visitor, which has separate methods for code generation of <code>Constant</code> and <code>Instruction</code>.</p> </li> <li> <p><code>CodeGenerator</code> can be "closed" - so it handles closing of the writer (our <code>SeekableOutputStream</code>).</p> </li> <li> <p>Generated code is binary</p> </li> </ul> </div> <div class="paragraph"> <p>The code generation is not that complex. There is some complexity caused by a fact, that the binary representations are reversed, when comparing to our present-time PCs/laptops.</p> </div> <div class="paragraph"> <p>The idea of generating code for instruction is to prepare 4 bytes, 32 bits, which are then written into the "writer" as one <code>Integer</code>, which has also 32 bits. The instruction format is explained in section <a href="#COMPILER_SSEM_ASM">Assembler for SSEM</a>. First 5 bits from the left represent the "line" - instruction operand. It must be reversed. Then, bits 13,14,15 represent the instruction opcode. It does not have to be reversed here, since the instructions are already encoded properly in the <code>Instruction</code> class. Last two bytes are just empty.</p> </div> <div class="paragraph"> <p>Code generation for constant is much easier - it&#8217;s just retrieving the value and writing it in the reversed fashion as <code>Integer</code>.</p> </div> <div class="paragraph"> <p>Code generator uses a "seekable" output stream, which allows to seek in the output. It is a separate class, which is actually an abstract class, extending <code>OutputStream</code>. The reason is easier testing:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/SeekableOutputStream.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.OutputStream</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">SeekableOutputStream</span> <span style="color: #008000; font-weight: bold">extends</span> OutputStream <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">seek</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> position<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException<span style="color: #666666">;</span>

<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>and here&#8217;s the implementation:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/MemoryAndFileOutput.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.MemoryContext</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.jcip.annotations.NotThreadSafe</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.RandomAccessFile</span><span style="color: #666666">;</span>

<span style="color: #AA22FF">@NotThreadSafe</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryAndFileOutput</span> <span style="color: #008000; font-weight: bold">extends</span> SeekableOutputStream <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> RandomAccessFile file<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memoryContext<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> position <span style="color: #666666">=</span> <span style="color: #666666">0;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">MemoryAndFileOutput</span><span style="color: #666666">(</span>String filename<span style="color: #666666">,</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memoryContext<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">file</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> RandomAccessFile<span style="color: #666666">(</span>filename<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;rw&quot;</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memoryContext</span> <span style="color: #666666">=</span> memoryContext<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">write</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> b<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>memoryContext <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            memoryContext<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>position<span style="color: #666666">,</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)</span> <span style="color: #666666">(</span>b <span style="color: #666666">&amp;</span> <span style="color: #666666">0xFF));</span>
        <span style="color: #666666">}</span>
        file<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>b<span style="color: #666666">);</span>
        position<span style="color: #666666">++;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">seek</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> position<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">position</span> <span style="color: #666666">=</span> position<span style="color: #666666">;</span>
        file<span style="color: #666666">.</span><span style="color: #7D9029">seek</span><span style="color: #666666">(</span>position<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">close</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
            file<span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">finally</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>The "seeking" capability is required, because, as you remember, it&#8217;s possible to write something like this:</p> </div> <div class="literalblock"> <div class="content"><pre>06 STO 05
05 LDN 06
07 STP</pre></div> </div> <div class="paragraph"> <p>It&#8217;s not quite common, but it&#8217;s possible.</p> </div> <div class="sect3"> <h4 id="testing-2"> <a href="#testing-2" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Testing </h4> <div class="paragraph"> <p>As being our practice, we must test it.</p> </div> <div class="listingblock"> <div class="title"><code>src/test/java/net/sf/emustudio/ssem/assembler/CodeGeneratorTest.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Instruction</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.After</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.Before</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.Test</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertArrayEquals</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CodeGeneratorTest</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> SeekableByteArrayOutputStream out<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> CodeGenerator codeGenerator<span style="color: #666666">;</span>

    <span style="color: #AA22FF">@Before</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setUp</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        out <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> SeekableByteArrayOutputStream<span style="color: #666666">(32);</span>
        codeGenerator <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> CodeGenerator<span style="color: #666666">(</span>out<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@After</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">tearDown</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testCMP</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">cmp</span><span style="color: #666666">());</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{0,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">CMP</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testSTP</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">stp</span><span style="color: #666666">());</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{0,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">STP</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testJMP</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">jmp</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)6));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{0x60,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">JMP</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testJRP</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">jrp</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)23));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{(</span><span style="color: #B00040">byte</span><span style="color: #666666">)0xE8,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">JRP</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testLDN</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">ldn</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)12));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{(</span><span style="color: #B00040">byte</span><span style="color: #666666">)0x30,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">LDN</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testSTO</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">sto</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)30));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{(</span><span style="color: #B00040">byte</span><span style="color: #666666">)0x78,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">STO</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testSUB</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">sub</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)18));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{(</span><span style="color: #B00040">byte</span><span style="color: #666666">)0x48,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">SUB</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">SeekableByteArrayOutputStream</span> <span style="color: #008000; font-weight: bold">extends</span> SeekableOutputStream <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> array<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> pos<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> length<span style="color: #666666">;</span>

        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">SeekableByteArrayOutputStream</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> count<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">array</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[</span>count<span style="color: #666666">];</span>
        <span style="color: #666666">}</span>

        <span style="color: #AA22FF">@Override</span>
        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">seek</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> position<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
            length <span style="color: #666666">=</span> Math<span style="color: #666666">.</span><span style="color: #7D9029">max</span><span style="color: #666666">(</span>position<span style="color: #666666">,</span> pos<span style="color: #666666">);</span>
            pos <span style="color: #666666">=</span> position<span style="color: #666666">;</span>
        <span style="color: #666666">}</span>

        <span style="color: #AA22FF">@Override</span>
        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">write</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> b<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
            array<span style="color: #666666">[</span>pos<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)</span>b<span style="color: #666666">;</span>
            pos<span style="color: #666666">++;</span>
            length <span style="color: #666666">=</span> Math<span style="color: #666666">.</span><span style="color: #7D9029">max</span><span style="color: #666666">(</span>pos<span style="color: #666666">,</span> length<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>

        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #0000FF">toArray</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> tmp <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[</span>length<span style="color: #666666">];</span>
            System<span style="color: #666666">.</span><span style="color: #7D9029">arraycopy</span><span style="color: #666666">(</span>array<span style="color: #666666">,</span> <span style="color: #666666">0,</span> tmp<span style="color: #666666">,</span> <span style="color: #666666">0,</span> length<span style="color: #666666">);</span>
            <span style="color: #008000; font-weight: bold">return</span> tmp<span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre></div> </div> </div> </div> <div class="sect2"> <h3 id="finalizing"> <a href="#finalizing" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Finalizing </h3> <div class="paragraph"> <p>We&#8217;re almost done now! What is missing so far is to finish implementation of the main <code>CompilerImpl.compile()</code> method. Let&#8217;s begin with it first.</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/CompilerImpl.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CompilerImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCompiler <span style="color: #666666">{</span>

    <span style="color: #666666">...</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">compile</span><span style="color: #666666">(</span>String inputFileName<span style="color: #666666">,</span> String outputFileName<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        notifyCompileStart<span style="color: #666666">();</span>

        <span style="color: #B00040">int</span> errorCode <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">(</span>Reader reader <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> FileReader<span style="color: #666666">(</span>inputFileName<span style="color: #666666">))</span> <span style="color: #666666">{</span>
            MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory <span style="color: #666666">=</span> contextPoolImpl<span style="color: #666666">.</span><span style="color: #7D9029">getMemoryContext</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">,</span> MemoryContext<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

            <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">(</span>CodeGenerator codeGenerator <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> CodeGenerator<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> MemoryAndFileOutput<span style="color: #666666">(</span>outputFileName<span style="color: #666666">,</span> memory<span style="color: #666666">)))</span> <span style="color: #666666">{</span>
                LexerImpl lexer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> LexerImpl<span style="color: #666666">(</span>reader<span style="color: #666666">);</span>
                ParserImpl parser <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> ParserImpl<span style="color: #666666">(</span>lexer<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">(),</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>

                Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>program <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> Exception<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Unexpected end of file&quot;</span><span style="color: #666666">);</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
                    <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> Exception<span style="color: #666666">(</span><span style="color: #BA2121">&quot;One or more errors has been found, cannot continue.&quot;</span><span style="color: #666666">);</span>
                <span style="color: #666666">}</span>

                program<span style="color: #666666">.</span><span style="color: #7D9029">accept</span><span style="color: #666666">(</span>codeGenerator<span style="color: #666666">);</span>
                programStart <span style="color: #666666">=</span> program<span style="color: #666666">.</span><span style="color: #7D9029">getStartLine</span><span style="color: #666666">()</span> <span style="color: #666666">*</span> <span style="color: #666666">4;</span>
                notifyInfo<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Compile was successful. Output: &quot;</span> <span style="color: #666666">+</span> outputFileName<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>Exception e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            errorCode <span style="color: #666666">=</span> <span style="color: #666666">1;</span>
            LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">error</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Compilation error.&quot;</span><span style="color: #666666">,</span> e<span style="color: #666666">);</span>
            notifyError<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Compilation error.&quot;</span><span style="color: #666666">);</span>

            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">finally</span> <span style="color: #666666">{</span>
            notifyCompileFinish<span style="color: #666666">(</span>errorCode<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>

        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>As input, we have full path to the input file, and to the output file. It is good to use Java <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html">try-with-resources</a> statement for opening the files. The same approach can be used for the code generator, because the class implements <code>AutoCloseable</code> interface.</p> </div> <div class="paragraph"> <p>We want to notify emuStudio about compilation progress, as we have already done in the parser, when dealing with parsing errors. For this purpose, <code>emulib.plugins.compiler.AbstractCompiler</code> class offers several methods:</p> </div> <div class="ulist"> <ul> <li> <p><code>notifyCompileStart()</code>, which will inform emuStudio that the compilation has started,</p> </li> <li> <p><code>notifyCompileFinish(errorCode)</code> will inform emuStudio that the compilation has finished, with given error code. <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup></p> </li> <li> <p><code>notifyOnMessage()</code> - notifies emuStudio about some general message, it can be either error, info, warning.</p> </li> <li> <p><code>notifyWarning()</code> - compiler warning</p> </li> <li> <p><code>notifyError()</code> - compilation error</p> </li> <li> <p><code>notifyInfo()</code> - informational message</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="command-line-interface-cli"> <a href="#command-line-interface-cli" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Command-line interface (CLI) </h3> <div class="paragraph"> <p>It might be sometimes useful to being able to run the compiler from the command line. We can add the implementation in the <code>Main</code> class, as follows:</p> </div> <div class="listingblock"> <div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/Main.java</code></div> <div class="content"><pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.Compiler</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.Message</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.ContextPool</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Main</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">main</span><span style="color: #666666">(</span>String<span style="color: #666666">...</span> args<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        String inputFile<span style="color: #666666">;</span>
        String outputFile <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>

        <span style="color: #B00040">int</span> i<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span>i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> args<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">;</span> i<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
            String arg <span style="color: #666666">=</span> args<span style="color: #666666">[</span>i<span style="color: #666666">].</span><span style="color: #7D9029">toLowerCase</span><span style="color: #666666">();</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">((</span>arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;--output&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">||</span> arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;-o&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">((</span>i <span style="color: #666666">+</span> <span style="color: #666666">1)</span> <span style="color: #666666">&lt;</span> args<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
                outputFile <span style="color: #666666">=</span> args<span style="color: #666666">[++</span>i<span style="color: #666666">];</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;--help&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">||</span> arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;-h&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
                printHelp<span style="color: #666666">();</span>
                <span style="color: #008000; font-weight: bold">return</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;--version&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">||</span> arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;-v&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
                System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> CompilerImpl<span style="color: #666666">(0</span>L<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ContextPool<span style="color: #666666">()).</span><span style="color: #7D9029">getVersion</span><span style="color: #666666">());</span>
                <span style="color: #008000; font-weight: bold">return</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>i <span style="color: #666666">&gt;=</span> args<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            System<span style="color: #666666">.</span><span style="color: #7D9029">err</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Error: expected input file name&quot;</span><span style="color: #666666">);</span>
            <span style="color: #008000; font-weight: bold">return</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
        inputFile <span style="color: #666666">=</span> args<span style="color: #666666">[</span>i<span style="color: #666666">];</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>outputFile <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #B00040">int</span> index <span style="color: #666666">=</span> inputFile<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&#39;.&#39;</span><span style="color: #666666">);</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>index <span style="color: #666666">!=</span> <span style="color: #666666">-1)</span> <span style="color: #666666">{</span>
                outputFile <span style="color: #666666">=</span> inputFile<span style="color: #666666">.</span><span style="color: #7D9029">substring</span><span style="color: #666666">(0,</span> index<span style="color: #666666">);</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
                outputFile <span style="color: #666666">=</span> inputFile<span style="color: #666666">;</span>
            <span style="color: #666666">}</span>
            outputFile <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;.bin&quot;</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>

        CompilerImpl compiler <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> CompilerImpl<span style="color: #666666">(0</span>L<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ContextPool<span style="color: #666666">());</span>
        compiler<span style="color: #666666">.</span><span style="color: #7D9029">addCompilerListener</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Compiler<span style="color: #666666">.</span><span style="color: #7D9029">CompilerListener</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onStart</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onMessage</span><span style="color: #666666">(</span>Message message<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                System<span style="color: #666666">.</span><span style="color: #7D9029">err</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span>message<span style="color: #666666">.</span><span style="color: #7D9029">toString</span><span style="color: #666666">());</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onFinish</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> errorCode<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                System<span style="color: #666666">.</span><span style="color: #7D9029">err</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Compilation finished (error code: &quot;</span> <span style="color: #666666">+</span> errorCode <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;)&quot;</span><span style="color: #666666">);</span>

            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
            compiler<span style="color: #666666">.</span><span style="color: #7D9029">compile</span><span style="color: #666666">(</span>inputFile<span style="color: #666666">,</span> outputFile<span style="color: #666666">);</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>Exception e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            System<span style="color: #666666">.</span><span style="color: #7D9029">err</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span>e<span style="color: #666666">.</span><span style="color: #7D9029">getMessage</span><span style="color: #666666">());</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">printHelp</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Syntax: java -jar as-ssem.jar [-o outputFile] inputFile\nOptions:&quot;</span><span style="color: #666666">);</span>
        System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;\t--output, -o\tfile: name of the output file&quot;</span><span style="color: #666666">);</span>
        System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;\t--version, -v\t: print version&quot;</span><span style="color: #666666">);</span>
        System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;\t--help, -h\t: this help&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre></div> </div> <div class="paragraph"> <p>And that was the very last thing, now you have SSEM compiler ready :)</p> </div> </div> </div> </div> <div id="footnotes"> <hr> <div class="footnote" id="_footnote_1"> <a href="#_footnoteref_1">1</a>. For example, <code>non terminal Instruction Statement;</code> in the gramamr above defines a non-terminal <code>Statement</code>, which should return an instance of <code>Instruction</code> class. The class <code>Instruction</code> must be implemented manually - it is part of AST; there are no special requirements for the implementation. </div> <div class="footnote" id="_footnote_2"> <a href="#_footnoteref_2">2</a>. The error code should be defined by you, developer, if you want. It is a convention used also in other compilers that specific error has assigned a unique number. In our compiler, we do not use it. </div> </div> </div> </div> </div> </div> </body> </html>
