






<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>Developing emuStudio Plugins &diams; emuStudio</title>
    <meta name="keywords" content="emulator,emulation,emustudio,programming emulator,debugging in emulator,computer emulation,altair emulation">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="emuStudio &diams; Computer emulation platform/framework" href="../../../feed.xml">
    <link rel="alternate" type="application/atom+xml" title="emuStudio &diams; Computer emulation platform/framework" href="../../../atom.xml">

    <!-- Favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="../../../favicon.ico?">
    <meta name="application-name" content="emuStudio &diams; Computer emulation platform/framework">
    <meta name="msapplication-TileColor" content="#ffffff">

    <!-- Fonts -->
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto+Condensed:300,300italic,400,400italic,700,700italic|Oswald:300,400,700">

    <!-- Styles -->
    <link rel="stylesheet" href="../../../css/style.css">

    <link rel="stylesheet" href="../../../css/bootstrap-toc.min.css">
    <link rel="stylesheet" href="../../../fonts/font-awesome.min.css">


    <!-- Scripts -->

    <!--[if lt IE 9]>
        <script src="../../../js/html5shiv.min.js"></script>
        <script src="../../../js/respond.min.js"></script>
    [endif]-->

    <script src="../../../js/jquery-3.1.1.min.js"></script>
    <script src="../../../js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous">
    </script>

    <script src="../../../js/bootstrap-toc.min.js"></script>


    <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-3492956-5', 'auto');
        ga('send', 'pageview');

    </script>
</head>


<body data-spy="scroll" data-target="#toc">


<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/emuStudio/"><i><img alt="&diams;" style="margin: -5px;margin-right:2px;" src="../../../img/logo-2.svg" width="30px" /></i>emuStudio</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <!--<form class="navbar-form navbar-left" role="search">-->
                <!--<div class="form-group">-->
                    <!--<input type="text" class="form-control" placeholder="Search website">-->
                <!--</div>-->
                <!--<button type="submit" class="btn btn-default">Submit</button>-->
            <!--</form>-->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/emuStudio/">Home</a>
                </li>
                
                <li>
                    <a href="/emuStudio/download">Download</a>
                </li>
                
                <li>
                    <a href="/emuStudio/docs">Docs</a>
                </li>
                
                <li>
                    <a href="/emuStudio/devel">Developer</a>
                </li>
                
                <li>
                    <a href="/emuStudio/roadmap">Roadmap</a>
                </li>
                
                <li>
                    <a href="/emuStudio/about">About</a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>





<div class="title-group">
    <h1 class="special" data-toc-skip>
      <span>
          
            For developers
          
      </span>
    </h1>
    
      Version 0.39
    
    
    <aside>
        
        
        
        
        
        
        
        
        <span>
            
            
                
                <a href="/emuStudio/docdevel/emulator_tutorial/index/" role="button" class="btn btn-default active">
                    emulator tutorial
                </a>
            
        </span>
        
        
        
        
        
        
        
        <span>
            
            
                <a href="/emuStudio/docdevel/javadoc_and_others/index/" role="button" class="btn btn-default">
                    javadoc and others
                </a>
            
        </span>
        
        
    </aside>

    <script>
        $('#toc').on('affixed.bs.affix', function(){
            $(this).removeAttr('style');
        });
    </script>
    
</div>


<div class="container">
    <div class="row">
        <div id="sidebar" class="col-md-3 col-sm-3 col-lg-3">
            <nav id="toc" class="navbar" data-spy="affix" data-offset-top="230" data-toggle="toc"></nav>
        </div>
        <div class="col-md-9 col-sm-9 col-lg-9">
            
                <div class="sect1">
<h2 id="INTRODUCTION_PLUGINS">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide shall help you, the developer, to write your own virtual computer for emuStudio. From now on, every time
a 'virtual computer' will be mentioned, it should be always understood as a computer emulator written for emuStudio, if
it won&#8217;t be said otherwise.</p>
</div>
<div class="sect2">
<h3 id="what-is-emustudio">1.1. What is emuStudio</h3>
<div class="paragraph">
<p>From user&#8217;s point of view, emuStudio can be understood as an <strong>emulation platform</strong>, because it can run various emulators
in the same environment. It has a simple IDE, debugger and other features like automatic emulation, which makes emuStudio
quite powerful.</p>
</div>
<div class="paragraph">
<p>From developer&#8217;s point of view, it is also a <strong>framework</strong>, because it provides API and lifecycle management for virtual
computers. There are some contracts how things work, what developer can count with, and what is not defined. This
tutorial shall guide the developer through these waters, hopefully at the end there won&#8217;t be any serious problems with
writing custom virtual computers.</p>
</div>
<div class="sect3">
<h4 id="core-technologies">1.1.1. Core technologies</h4>
<div class="paragraph">
<p>During programming, there are some commonly used technologies, which are mandatory when relevant. These are the "core
technologies", which are listed in the following table:</p>
</div>
<table class="tableblock frame-topbot grid-all spread table table-striped table-condensed">
<caption class="title">Table 1. Core technologies used in emuStudio</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Technology</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Relevance</th>
<th class="tableblock halign-left valign-top">Link</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Asciidoctor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Documentation generator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Documentation module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://asciidoctor.org/" class="bare">http://asciidoctor.org/</a></p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Git</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version control system</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://git-scm.com/" class="bare">https://git-scm.com/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java 8 SE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Main programming language</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" class="bare">http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maven 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build lifecycle management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://maven.apache.org/download.cgi" class="bare">https://maven.apache.org/download.cgi</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SLF4J</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Facade for logger implementation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.slf4j.org/" class="bare">http://www.slf4j.org/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JFlex</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lexical analyzer generator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compilers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://jflex.de/" class="bare">http://jflex.de/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java CUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LR parser generator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compilers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www2.cs.tum.edu/projects/cup/" class="bare">http://www2.cs.tum.edu/projects/cup/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Edigen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disassembler generator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/sulir/edigen" class="bare">https://github.com/sulir/edigen</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">emuLib</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Plugin API and runtime library</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/vbmacher/emuLib" class="bare">https://github.com/vbmacher/emuLib</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JUnit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java unit testing framework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://junit.org/" class="bare">http://junit.org/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EasyMock</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mock library</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://easymock.org/" class="bare">http://easymock.org/</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
emuStudio uses Maven for the build lifecycle management. All dependencies and their versions are defined in
      the root <code>pom.xml</code> file. When you use a library or some technology which is listed there, please use the
      same version as it is used by emuStudio. You will avoid unexpected conflicts or behavior of your plug-ins.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="license">1.1.2. License</h4>
<div class="paragraph">
<p>emuStudio with all its modules, including emuLib, is a free software. It is released with GNU GPL 2 license.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="contributing">1.2. Contributing</h3>
<div class="paragraph">
<p>Anyone can contribute to emuStudio. The source code is available on GitHub, at <a href="https://github.com/vbmacher/emuStudio" class="bare">https://github.com/vbmacher/emuStudio</a>.
emuStudio repository contains the main module, plug-ins (predefined set of virtual computers), testing tools,
and CI (continuous integration) tools.</p>
</div>
<div class="paragraph">
<p>There are basically two options how you can contribute. Either you fix or enhance emuStudio itself (or plug-ins), or
you implement completely new computer which can be used with emuStudio. The latter does not really mean to contribute,
unless it is included in the original emuStudio repository.</p>
</div>
<div class="paragraph">
<p>However, adding new computers to standard emuStudio must be consulted with the author in advance. While I encourage
people writing their own computers, I assume they will be mostly students having only little experience
and/or fixed-time projects which will end when the student passes. This is perfectly fine, but those projects should
be rather kept in other places.</p>
</div>
<div class="paragraph">
<p>Also, in the future there might be something like a plug-in repository, and a user would download what he wants manually.
So far, it is not like that and it is too soon to consider this.</p>
</div>
<div class="sect3">
<h4 id="definition-of-done">1.2.1. Definition of DONE</h4>
<div class="paragraph">
<p>There are some requirements which need to be fulfilled before we can say that the contribution is "done" and can be
accepted or released. The list is very simple:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Code should be clean, conforming to the code style</p>
</li>
<li>
<p>Code must have proper unit tests, if applicable or possible</p>
</li>
<li>
<p>Documentation should be updated</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="git-workflow">1.2.2. Git workflow</h4>
<div class="paragraph">
<p>Since the whole project is using <code>git</code> as the version control system (VCS), it has many benefits used for specification
of a way how people can actually contribute.</p>
</div>
<div class="paragraph">
<p>emuStudio uses a much simplified version of the <a href="https://datasift.github.io/gitflow/IntroducingGitFlow.html">Git Flow model</a>.
Releasing of older versions due to "hot fixes" or maintenance is not supported. Fixing bugs and development of new features
are both done in the single branch, called <code>develop</code>. On GitHub the branch is marked as default.</p>
</div>
<div class="paragraph">
<p>When a new release is out, the last commit must be tagged with a new tag named <code>RELEASE-X</code>, where <code>X</code> is the released
version.</p>
</div>
<div class="paragraph">
<p>When contributing (fixing, new development), always derive new branch from the <code>develop</code> branch. In your branch, you
can do any number of well-formed commits. When you are ready, raise new pull-request back to the <code>develop</code> branch.</p>
</div>
<div class="paragraph">
<p>Example of the git workflow is as follows:</p>
</div>
<div class="paragraph">
<p>At first, fork emuStudio on GitHub. Then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>git clone https://github.com/your_name/emuStudio.git
git checkout -b fix-issue-143 origin/develop

.. fixing/implementing ..

git commit -a -m '[#143] 88-disk: implement interrupts'
git push</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can repeat this process several times. When you are finished with all commits, create a pull request to original
emuStudio repository, back to the <code>develop</code> branch.</p>
</div>
<div class="paragraph">
<p>The pull request will be seen by the author, which will make a review and either approve (and merge), comment or
rejects the pull request (with explanation).</p>
</div>
<div class="paragraph">
<p>As you could notice, commits should be well-formed - named with the issue number before the commit title, in square
brackets. Also, if it is related to specific plug-in or module, it should be written in the message, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>[#143] 88-disk: implement interrupts</code></pre>
</div>
</div>
<div class="paragraph">
<p>GitHub then automatically links the commit with the issue (a comment appears). For more information, see
<a href="https://help.github.com/articles/using-pull-requests/" class="bare">https://help.github.com/articles/using-pull-requests/</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="what-is-a-virtual-computer">1.3. What is a virtual computer</h3>
<div class="paragraph">
<p>Generally, a real computer can be decomposed into some cooperating components (still high-level), like CPU, bus, memory,
or devices. It is not far different from how it is in emuStudio. The core concept of a virtual computer is inspired by
the <a href="https://en.wikipedia.org/wiki/Von_Neumann_architecture">von Neumann model</a>. The model defines three types of core
components: CPU (control unit and arithmetic-logic unit), memory, and input/output devices. In emuStudio,
the virtual computer includes also these components, but the possibilities of interconnection and cooperation are not
bound to hardware limits or philosophy.</p>
</div>
<div class="paragraph">
<p>Each component of a virtual computer is a separate plug-in written in Java. A virtual computer is then just a set of
cooperating plug-ins which are loaded and initialized by emuStudio. The selection of plugins is handled externally, by
the user of emuStudio. The plugins list is extended with information about plug-in interconnection, which is specific
for each computer. Then we have something which is called <strong>abstract schema</strong>. But as was said, abstract schemas are
prepared by user, not plug-in developer.</p>
</div>
<div class="paragraph">
<p>For more information about how to create such a schema, please read the user manual. The whole process of loading and
initializing the plug-ins into working emulator is completely handled by emuStudio. Developer must hold to some
contracts, and principles of good object-oriented design, which are enough for ensuring that everything will work as
expected.</p>
</div>
<div class="paragraph">
<p>The following schema defines all plug-in types and their possible interconnections, as it is currently in emuStudio.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vbmacher.github.io/emuStudio/images/emustudio-plugins.svg" alt="emustudio plugins" width="498" height="214">
</div>
</div>
<div class="paragraph">
<p>As you can see, there are no restrictions about which plug-in can "see" or cooperate with another plug-in. For example,
a compiler can access all computer components, including CPU, devices and memory.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Most probably a compiler would want to access memory, in which case it would be able to load a compiled program
     directly there. But the reason why the compiler is allowed to access also other components is that the compiled
     program can contain either some information about initial states, or initial data which are needed to be preloaded
     into other components before program can be started (for example, content of abstract tapes in the case of RAM
     machine).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="plug-in-basics">1.4. Plug-in basics</h3>
<div class="paragraph">
<p>Each plug-in is a separate Java module, usually single jar file, placed in the proper directory. As it is necessary
to place the plug-in to proper location (<code>compilers/</code>, <code>cpu/</code>, <code>mem/</code>, and <code>devices/</code>), dependencies of both emuStudio
and all plug-ins should be included in <code>lib/</code> directory. The reason is to help ensuring that versions of shared
dependencies across plug-ins themselves and across emuStudio must be the same within single emuStudio distribution.</p>
</div>
<div class="paragraph">
<p>In emuStudio, plug-in source codes are located in <code>plugins/</code> subdirectory, then separated by plug-in type. For example:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/vbmacher/emuStudio/tree/branch-0_39/plugins" class="bare">https://github.com/vbmacher/emuStudio/tree/branch-0_39/plugins</a></p>
</div>
<div class="paragraph">
<p>In order to contribute to an existing plug-in, you can find the plug-in in some subdirectory. If you want to add a
new plug-in which should exist in the default emuStudio distribution, you would create new plug-in in that place as well.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Standard or "default" plug-ins force to use Maven and you must follow the standard which will be defined later.
      Also, before making any design changes or new plug-in development, please contact the emuStudio author.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Usually, your plug-ins will not be the standard part of default emuStudio distribution. In that case, you are not forced
to use Maven or any other technology, except of emuStudio API, contracts and the limits which might exist when involving
unknown third party dependencies. Also, you can use your own code style if you like.</p>
</div>
<div class="sect3">
<h4 id="plug-in-api">1.4.1. Plug-in API</h4>
<div class="paragraph">
<p>The basic idea of the development of the plug-in is to implement an API of that specific plug-in. This is actually only
thing which is required.</p>
</div>
<div class="paragraph">
<p>Plug-in API is stored in emuLib library (see <a href="#core-technologies">Core technologies</a>), so each plug-in must have emuLib as dependency.
This and following guides will show you some examples of how to implement a plug-in. For deeper details of all available
API, it is recommended to check the Javadoc.</p>
</div>
</div>
<div class="sect3">
<h4 id="third-party-dependencies">1.4.2. Third-party dependencies</h4>
<div class="paragraph">
<p>Each plug-in can depend on third-party libraries. It is recommended way how to avoid code duplication and reinventing
a wheel. If a plug-in depend on some third-party library, it is required to put the class path to the Manifest file
of the plug-in.</p>
</div>
<div class="paragraph">
<p>What is not required, however, is to define some default dependencies (listed below). emuStudio uses custom class-loader
for loading plug-ins, which handles the default dependencies automatically.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
emuLib
</td>
<td class="hdlist2">
<p>Plugin API and runtime library</p>
</td>
</tr>
<tr>
<td class="hdlist1">
slf4J
</td>
<td class="hdlist2">
<p>Facade for logger implementation</p>
</td>
</tr>
<tr>
<td class="hdlist1">
logback
</td>
<td class="hdlist2">
<p>Logger implementation, successor of log4j</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These dependencies should not be present in plug-in manifest files, they will be automatically loaded with emuStudio.
Please see emuStudio main POM file to determine the library versions.</p>
</div>
<div class="paragraph">
<p>In order to use other third-party dependencies, they must be mentioned in Manifest. The recommended way is to put the
dependencies in <code>/lib</code> subdirectory, and define relative path in Manifest from the root directory of where the emuStudio
is installed. For example, here is a Manifest file for RAM compiler plug-in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Manifest-Version: 1.0
Implementation-Title: RAM Compiler
Implementation-Version: 0.39-SNAPSHOT
Archiver-Version: Plexus Archiver
Built-By: vbmacher
Specification-Title: RAM Compiler
Implementation-Vendor-Id: net.sf.emustudio
Class-Path: mem/ram-mem.jar lib/java-cup-runtime-11b.jar
Created-By: Apache Maven 3.3.3
Build-Jdk: 1.8.0_65
Specification-Version: 0.39-SNAPSHOT</code></pre>
</div>
</div>
<div class="paragraph">
<p>The plug-in uses two non-default dependencies: RAM memory plug-in, and java-cup library. The first one is a memory
plug-in for emuStudio, so it is placed in <code>mem/</code> subdirectory, but java-cup library is completely third-party, and
non-default. The recommended place for storing these kind of libraries is <code>lib/</code> subdirectory.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cyclic dependencies are also supported.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="INTRODUCTION_BEHAVIORAL">1.5. Emulation lifecycle</h3>
<div class="paragraph">
<p>emuStudio is also a framework, which not only defines the API, but also the whole life cycle of plug-ins. It has the
control of all emulation processes, including CPU and all virtual devices. It proactively loads, instantiates and
initializes plug-ins. That way a plug-in developer can safely focus only on what the plug-in should do in the first place.</p>
</div>
<div class="paragraph">
<p>Behavior contracts define rules and assumptions which plug-in developer must hold to. emuStudio is assuming that
plug-ins "behave good", and if it is true, everything should work as expected. By ignoring the behavioral contracts
the emuStudio behavior is undefined; it can possibly corrupt the emulation process or crash whole emuStudio.</p>
</div>
<div class="paragraph">
<p>The list of some categories of behavioral contracts include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Order of operations being called by emuStudio (e.g. order of loading / initialization of plug-ins)</p>
</li>
<li>
<p>Rules of allowed / not allowed method calls in particular contexts</p>
</li>
<li>
<p>Specification of signature of constructors</p>
</li>
<li>
<p>Threading concerns</p>
</li>
<li>
<p>Other</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The behavioral contracts are described in particular Javadoc for emuLib and all modules to which it may concern.
The Javadoc contains special note which starts with capital <code>CONTRACT:</code>. The contract is mainly in the form of
explanation which other methods should not be called, or how particular thing should be implemented.</p>
</div>
<div class="sect3">
<h4 id="main-class">1.5.1. Main class</h4>
<div class="paragraph">
<p>Each plug-in must have exactly one "main class" in Java, which will be annotated with <code>emulib.annotations.PluginType</code>
annotation. This annotation provides several information, like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Title of the plug-in</p>
</li>
<li>
<p>Copyright notice and description of the plug-in</p>
</li>
<li>
<p>What type of the plug-in is (compiler, CPU, memory, device),</p>
</li>
<li>
<p>What version of emuLib it supports</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The class must also inherit from <code>emulib.plugins.Plugin</code> interface (not necessarily directly).</p>
</div>
</div>
<div class="sect3">
<h4 id="loading-and-initialization">1.5.2. Loading and initialization</h4>
<div class="paragraph">
<p>Setting up plug-ins is a two-phase process and it is done solely in emuStudio. emuStudio has custom class loader, into
which it loads all plug-ins (classes and resources) and "registers" them in JVM.</p>
</div>
<div class="sect4">
<h5 id="phase-1-loading">Phase 1 - Loading</h5>
<div class="paragraph">
<p>The plug-ins are loaded as a one bunch of extracted JARs mixed together, in a newly created class loader. The class
loader is immutable so further modification of plug-in loading (e.g. adding another component at run-time) is not
possible.</p>
</div>
<div class="paragraph">
<p>Dependencies explicitly specified in manifest files are recognized and loaded as well. With this, plug-ins can depend
on each other. However, in case of circular dependency, plug-ins loadin will fail.</p>
</div>
<div class="paragraph">
<p>The result of this phase is that all plug-in classes are loaded in memory and all main-classes instantiated. Each plug-in
main class must have a constructor with exactly two arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java">SamplePlugin<span style="color: #666666">(</span>Long pluginId<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ContextPool</code> can be used (in this phase) only for <strong>registering</strong> custom plug-in contexts, but not for their
obtaining. More information can be found in emuLib&#8217;s Javadoc.</p>
</div>
</div>
<div class="sect4">
<h5 id="INTRODUCTION_INITIALIZATION">Phase 2 - Initialization</h5>
<div class="paragraph">
<p>The initialization of plug-ins follows as the second phase. In this phase, plug-ins should ask from given <code>ContextPool</code>
in the previous phase of context(s) of other, already registered plug-ins.</p>
</div>
<div class="paragraph">
<p>The order in which plug-ins are initialized is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Compiler</p>
</li>
<li>
<p>CPU</p>
</li>
<li>
<p>Memory</p>
</li>
<li>
<p>Devices in the order as they are defined in the virtual computer configuration file</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When following this contract, it cannot happen that a plug-in will ask for context which is not registered.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="INTRODUCTION_NAMING">1.6. Naming conventions</h3>
<div class="paragraph">
<p>Plug-in names (jar file names) follow naming conventions. The names differ based on plug-in types. From the jar file
name it should be clear what plug-in we are talking about. Generally, the jar file should begin with some custom
abbreviation of the real world "model" optionally preceded with the manufacturer (e.g. intel-8080, lsi-adm-3A, etc.).
Then plug-in type follows, as it is shown in the following table:</p>
</div>
<table class="tableblock frame-topbot grid-all spread table table-striped table-condensed">
<caption class="title">Table 2. Naming conventions for plug-in jar files</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Plug-in type</th>
<th class="tableblock halign-left valign-top">Naming convention</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Device</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;optional_manufacturer&gt;-&lt;model_abbreviation&gt;-&lt;device_type&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>88-disk</code>, <code>adm3a-terminal</code></p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compiler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;language_abbreviation&gt;-compiler</code>, or <code>as-&lt;language_abbreviation&gt;</code> for assemblers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>as-8080</code>, <code>brainc-compiler</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;optional_manufacturer&gt;-&lt;model_abbreviation&gt;-cpu</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>8080-cpu</code>, <code>z80-cpu</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;model_or_main_features_abbreviation&gt;-mem</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>standard-mem</code>, <code>ram-mem</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Plug-in names can contain digits, small and capital letters (regex: <code>[a-zA-Z0-9]+</code>). Capital letters shall be used only
for the following reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Word separation (e.g. zilogZ80),</p>
</li>
<li>
<p>Acronyms (e.g. RAM, standing for "Random Access Machine")</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using naming conventions for development of official plug-ins is a must; for custom projects it is highly
      recommended. emuStudio does not use the naming convention for searching for plugins.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="coding-style">1.7. Coding Style</h3>
<div class="paragraph">
<p>Unified coding style is as important as being a team player. It is the commonly-accepted order, which puts the code
readability at the same level everywhere. It is as in a classical book - you don&#8217;t usually see multiple writing styles
or text organizations throughout the book. It is written as by only one author, even if it has more. The same purpose
has the code style, because the reader is always just one.</p>
</div>
<div class="paragraph">
<p>I encourage you to read a book called Clean Code from Robert Martin. You can find there many inspiring thoughts and
ideas how to write the code in a clean way.</p>
</div>
<div class="sect3">
<h4 id="license-information">1.7.1. License information</h4>
<div class="paragraph">
<p>Each file must start with a comment with the license information. Please read part "How to Apply These
Terms to Your New Programs" at link <a href="http://www.gnu.org/licenses/gpl.html" class="bare">http://www.gnu.org/licenses/gpl.html</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="indentation">1.7.2. Indentation</h4>
<div class="paragraph">
<p>I consider this section as very important, so as there is lots of time consuming debates about the "indentation problem".
Therefore I "codify" this to 4 spaces.</p>
</div>
</div>
<div class="sect3">
<h4 id="logging">1.7.3. Logging</h4>
<div class="paragraph">
<p>emuStudio is bundled with <a href="https://www.slf4j.org/">SLF4J logger API</a> which is bound with
<a href="http://logback.qos.ch/">logback logger</a>. In code, it is possible to use the logger, like in this example:</p>
</div>
<div class="listingblock">
<div class="title">Example of using logger</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.slf4j.Logger</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.slf4j.LoggerFactory</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">SomeClass</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">final</span> Logger LOGGER <span style="color: #666666">=</span> LoggerFactory<span style="color: #666666">.</span><span style="color: #7D9029">getLogger</span><span style="color: #666666">(</span>SomeClass<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>


    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">someMethod</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">info</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Information message...&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Logging can be very important for analysis of a problem some other user had. emuStudio is supposed for many users
so it&#8217;s reasonable to include logging.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is not recommended to log information during running emulation. Logging significantly lowers the performance
      down.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use-maven-if-you-can">1.8. Use Maven if you can</h3>
<div class="paragraph">
<p>Maven is a standard for Java projects today. It helps with the build process and manages dependencies in satisfying
and reusable way.</p>
</div>
<div class="paragraph">
<p>Each official emuStudio module (artifact) is available in custom Maven repository, including emuLib. In order to be able
to use them from Maven, put the following code into your <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span style="color: #008000; font-weight: bold">&lt;distributionManagement&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;repository&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;id&gt;</span>emustudio-repository<span style="color: #008000; font-weight: bold">&lt;/id&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;name&gt;</span>emuStudio Repository<span style="color: #008000; font-weight: bold">&lt;/name&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;url&gt;</span>sftp://web.sourceforge.net:/home/project-web/emustudio/htdocs/repository<span style="color: #008000; font-weight: bold">&lt;/url&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/repository&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/distributionManagement&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Development of official standard plug-ins require using Maven.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="documenting-plug-ins">1.9. Documenting plug-ins</h3>
<div class="paragraph">
<p>There are two types of documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>user documentation</p>
</li>
<li>
<p>developer&#8217;s documentation (not javadoc)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="user-documentation">1.9.1. User documentation</h4>
<div class="paragraph">
<p>User documentation is located at <code>doc/src/user-manual</code>.</p>
</div>
<div class="paragraph">
<p>Description of a plug-in usually should not be standalone, but put in a bigger document describing the
whole computer. Description of each computer should be put in a separate directory, e.g. <code>altair8800/</code>, <code>brainduck/</code>, etc.
The description should focus on the interactive part of the emulation, and do not describe what&#8217;s going under the hood
in much detail.</p>
</div>
<div class="paragraph">
<p>The description should start with some introduction:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How the computer is related to the computer history?</p>
</li>
<li>
<p>Is it abstract or real?</p>
</li>
<li>
<p>The purpose of the computer</p>
</li>
<li>
<p>Comparison of features which it has as the emulator for emuStudio with the features of real computer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, every plug-in should be described, starting from compiler - in the form of the "programming language" tutorial.</p>
</div>
<div class="paragraph">
<p>It is important - keep the information useful. Do not try hard to put any information if you think it is too small.
Some plug-ins are quite clear and don&#8217;t seem to interact much with user, which is OK. For example usually it&#8217;s the
CPU plug-in.</p>
</div>
<div class="paragraph">
<p>Programming examples should follow, if the plug-in allows programming. For example, both MITS 88-DISK and MITS 88-SIO
are programmable devices.</p>
</div>
<div class="paragraph">
<p>Then a very important section should be devoted to automatic emulation. More specifically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How the plug-in will behave if emuStudio will run in automatic emulation mode?</p>
</li>
<li>
<p>Where can user find output files if the output is redirected to a file?</p>
</li>
<li>
<p>What is the behavior if the automatic emulation is run more times in a row? Will the files be overridden or appended?</p>
</li>
<li>
<p>Can be output file names changed?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The last section should talk about debugging of the plug-in. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List of known bugs</p>
</li>
<li>
<p>How to report a bug</p>
</li>
<li>
<p>How to do some analysis when something does not work</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="developer-s-documentation">1.9.2. Developer&#8217;s documentation</h4>
<div class="paragraph">
<p>Developer documentation is optional, but suggested. It should be written in the form of Maven sites. The preferred
formatter is Markdown.</p>
</div>
<div class="paragraph">
<p>In this type of documentation, only technical details should be explained. Majority of them should be the "why"s instead
of "how"s.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="incorporating-a-plug-in-to-emustudio">1.10. Incorporating a plug-in to emuStudio</h3>
<div class="paragraph">
<p>The philosophy about releasing is to keep everything as automatic as possible. The main reason is that if it was manual,
it would take some time which can be spent on something better. Of course there will be always some manual steps, but
it is better to keep them minimal.</p>
</div>
<div class="paragraph">
<p>The submodule <code>release/</code> is used now to create emuStudio releases. It expects that emuStudio artifacts are either
installed in local Maven repository, or they will be downloaded from emuStudio repository.</p>
</div>
<div class="paragraph">
<p>The submodule uses <code>maven-assembly-plugin</code> is used, and <code>assembly.xml</code> file exists which describes which artifacts
and files should be placed in which directories.</p>
</div>
<div class="paragraph">
<p>The following artifacts can be included in the release:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Plug-in artifact (JAR file)</p>
</li>
<li>
<p>Plug-in examples</p>
</li>
<li>
<p>New computer configuration (if applicable)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="plug-in-artifact">1.10.1. Plug-in artifact</h4>
<div class="paragraph">
<p>The condition is ofcourse that the plug-in must be a submodule in the main emuStudio repository. As an example,
let&#8217;s use plug-in <code>plugins/compilers/as-ssem</code>. The point is to edit <code>release/assembly.xml</code> file, find the dependency
set for compilers (look for the line <code>&lt;outputDirectory&gt;/compilers&lt;/outputDirectory&gt;</code>) and add the plug-in in that
set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    &lt;dependencySet&gt;
      &lt;includes&gt;
        ...
        &lt;include&gt;net.sf.emustudio:as-ssem&lt;/include&gt;
      &lt;/includes&gt;
      ...
      &lt;outputDirectory&gt;/compilers&lt;/outputDirectory&gt;
    &lt;/dependencySet&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, for other types of plug-ins there exist corresponding sections which should be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="plug-in-examples">1.10.2. Plug-in examples</h4>
<div class="paragraph">
<p>Similarly as was said in the previous subsection, the file which should be edited is <code>release/assembly.xml</code>. Examples
section is located in the bottom part, in a <code>fileSet</code> section. Examples are usually bound with specific compiler - and
they are also physically placed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Compilation of compiler plug-ins does not create examples artifacts (maybe it should in the future). The assembly
      therefore points to relative path of the example files.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, example files for plug-in <code>as-8080</code> are stored in the following section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    &lt;fileSet&gt;
      &lt;directory&gt;../plugins/compilers/as-8080/examples&lt;/directory&gt;
      &lt;directoryMode&gt;&lt;/directoryMode&gt;
      &lt;includes&gt;
        &lt;include&gt;**/*.asm&lt;/include&gt;
        &lt;include&gt;**/*.inc&lt;/include&gt;
      &lt;/includes&gt;
      &lt;outputDirectory&gt;/examples/as-8080&lt;/outputDirectory&gt;
    &lt;/fileSet&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The subdirectories in target <code>examples/</code> directory are organized by compiler plug-in names, or machine names if
the examples are rather bound to the whole virtual computer (e.g. disk images, etc.). Examples for whole virtual
computers are usually not bound with specific plug-ins and should be placed directly in the <code>release/files/examples/</code>
directory.</p>
</div>
<div class="paragraph">
<p>All files in the <code>release/files</code> are automatically included in the release.</p>
</div>
</div>
<div class="sect3">
<h4 id="new-computer-configuration">1.10.3. New computer configuration</h4>
<div class="paragraph">
<p>All predefined computer configurations are placed in directory <code>release/files/config</code>. The only step needed to be
done here is to create a computer configuration file and place it there. The <code>maven-assembly-plugin</code> will take care
of it and the configuration will be included in the release automatically.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="what-to-do-next">1.11. What to do next</h3>
<div class="paragraph">
<p>What follows are tutorials for developing specific emuStudio plug-ins - compiler, CPU, memory or a device. Prepare
your fingers, you&#8217;ll write some code. Let&#8217;s start.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-a-compiler">2. Writing a compiler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial will guide you to how to create a compiler for emuStudio. It focuses on things around
emuStudio, emuLib and some common practices. It will not dig deep into the compiler theory, only what will be required
on the way.</p>
</div>
<div class="paragraph">
<p>In present days, general scheme of compiler&#8217;s work is parsing, semantic analysis, optimalization and code generation.
Quite tedious and error-prone work of parsing can be generated automatically with parser generators. All emuStudio
compilers use such tools; and they will be also used in this tutorial:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://jflex.de/">JFlex</a> for generating the lexical analyzer, or lexer for short,</p>
</li>
<li>
<p><a href="http://www2.cs.tum.edu/projects/cup/">Java cup</a> for generating LR(k) parsers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading on, please read the <a href="#INTRODUCTION_PLUGINS">Introduction</a> chapter. It provides the information
needed for setting up the development environment and explains how emuStudio plug-ins' lifecycle work.</p>
</div>
<div class="sect2">
<h3 id="COMPILER_GETTING_STARTED">2.1. Getting started</h3>
<div class="paragraph">
<p>In the context of the whole emulator, the compiler is usually an assembler which produces binary instructions for
the emulated CPU. However, it does not have to be assembler; it really can be any language compiler. The output of
the compiler is often loaded directly into emulated operating memory, so the program can be run in emuStudio in a
single click. This is one of the great features of emuStudio.</p>
</div>
<div class="paragraph">
<p>A compiler is a plug-in, which means that it requires to implement an API. The API for compilers is defined in the form
of Java interfaces and some classes in emuLib, in package <code>emulib.plugins.compiler</code>. This tutorial will guide
you with implementing the API and the whole compiler.</p>
</div>
</div>
<div class="sect2">
<h3 id="COMPILER_SSEM_ASM">2.2. Assembler for SSEM</h3>
<div class="paragraph">
<p>In this tutorial, we will implement an assembler for the world&#8217;s very first stored-program computer,
<a href="https://en.wikipedia.org/wiki/Manchester_Small-Scale_Experimental_Machine">SSEM</a>, nicknamed "Baby". It was a predecessor
of Manchester Mark 1 which led to Ferranti Mark 1, the world&#8217;s first commercially available general-purpose computer.</p>
</div>
<div class="paragraph">
<p>It it very simple computer, which can run only 7 instructions. The instructions table
follows (modified from <a href="https://en.wikipedia.org/wiki/Manchester_Small-Scale_Experimental_Machine#Programming">Wikipedia</a>):</p>
</div>
<table class="tableblock frame-topbot grid-all spread table table-striped table-condensed">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Binary code</th>
<th class="tableblock halign-left valign-top">Mnemonic</th>
<th class="tableblock halign-left valign-top">Action</th>
<th class="tableblock halign-left valign-top">Operation</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">111</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STP  / HLT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JMP S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">S(L) &#8594; CI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the instruction at the address obtained from the specified memory
                                                  address <code>S(L)</code> (absolute unconditional jump)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JRP / JPR / JMR S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CI + S(L) &#8594; CI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the instruction at the program counter (<code>CI</code>) plus the
                                                  relative value obtained from the specified memory address <code>S(L)</code>
                                                  (relative unconditional jump)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">010</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LDN S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-S(L) &#8594; A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Take the number from the specified memory address <code>S(L)</code>, negate it,
                                                  and load it into the accumulator</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STO S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A &#8594; S(L)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the number in the accumulator to the specified memory address <code>S(L)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">001 or 101</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SUB S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A - S(L) &#8594; A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subtract the number at the specified memory address <code>S(L)</code> from the
                                                  value in accumulator, and store the result in the accumulator</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">011</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CMP / SKN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">if A&lt;0 then CI+1&#8594;CI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Skip next instruction if the accumulator contains a negative value</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The instructions are stored in a memory, which had 32 cells. Each cell was 32 bits long, and each instruction fit into
exactly one cell. So each instruction has 32 bits. The bit representation was reversed, so the most and the least
significant bits were put on opposite sides. For example, value <code>3</code>, in common personal computers represented as <code>011</code>,
was in SSEM represented as <code>110</code>.</p>
</div>
<div class="paragraph">
<p>The instruction format is as follows:</p>
</div>
<table class="tableblock frame-topbot grid-all spread table table-striped table-condensed">
<caption class="title">Table 3. SSEM Instruction Format</caption>
<colgroup>
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3337%;">
</colgroup>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Value:</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2^0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2^31</p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Bit:</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">02</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">31</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Use:</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>where bits <code>LLLLL</code> denote a "line", which is basically the memory address - index of a memory cell. It can be understood
as instruction operand. Bits <code>III</code> specify the instruction opcode (3 bits are enough for 7 instructions).</p>
</div>
</div>
<div class="sect2">
<h3 id="language-specification">2.3. Language specification</h3>
<div class="paragraph">
<p>Each compiler is just a program which translates an input source code into output code. Usually, the input language is
more high level than the output language, and often offers some features, which are not supported by the output language.
For example, assembler source codes often support comments, various formats of number literals, labels, or macros. These
are features, which are not supported by the instruction set itself, and they must be translated to it by compiler.</p>
</div>
<div class="paragraph">
<p>SSEM assembler specification can be started with informal expressing, what it will know:</p>
</div>
<div class="sect3">
<h4 id="COMPILER_TOKEN_CATEGORIES">2.3.1. Token categories</h4>
<div class="paragraph">
<p>Tokens, parsed by lexical analyzer have assigned a so-called category. The category is useful mainly for syntax
highlighter in emuStudio editor. For example, reserved words are colored differently than e.g. numeric constants, or
comments.</p>
</div>
<div class="paragraph">
<p>The list of all categories can be seen in the following class:
<a href="https://github.com/vbmacher/emuLib/blob/branch-9_0/src/main/java/emulib/plugins/compiler/Token.java">Token.java</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="new-lines">2.3.2. New-lines</h4>
<div class="paragraph">
<p>New-line character (LF, CR, or CRLF) will be required as a delimiter of instructions, and as the last character.
Successive empty new-line characters will be ignored.</p>
</div>
</div>
<div class="sect3">
<h4 id="instructions">2.3.3. Instructions</h4>
<div class="paragraph">
<p>Assembler will support all forms of instructions shown in the table in section <a href="#COMPILER_SSEM_ASM">Assembler for SSEM</a>. All instructions must
start with a line number. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>01 LDN 20</pre>
</div>
</div>
<div class="paragraph">
<p>Instructions belong to token category called "reserved words".</p>
</div>
</div>
<div class="sect3">
<h4 id="literals-constants">2.3.4. Literals / constants</h4>
<div class="paragraph">
<p>Raw number constants can be defined in separate lines using special preprocessor keywords. The first one is <code>NUM xxx</code>,
where <code>xxx</code> is a number in either decimal or hexadecimal form. Hexadecimal format must start with prefix <code>0x</code>. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>00 NUM 0x20
01 NUM 1207943145</pre>
</div>
</div>
<div class="paragraph">
<p>Another keyword is <code>BNUM xxx</code>, where <code>xxx</code> can be only a binary number. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>01 BNUM 10011011111000101111110000111111</pre>
</div>
</div>
<div class="paragraph">
<p>It means that the number will be stored untouched to the memory in the format as it appears in the binary form.</p>
</div>
<div class="paragraph">
<p>There exists also a third keyword, <code>BINS xxx</code>, with the exact meaning as <code>BNUM</code>. The reason for its presence is to
be compatible with most of the programs <a href="http://www.cs.ubc.ca/~hilpert/e/SSEM/programs/noodle.html">found on internet</a>.</p>
</div>
<div class="paragraph">
<p>For all constants, the following rules hold. Only integral constants are supported, and the allowed range is from 0 - 31
(maximum is 2^5).</p>
</div>
<div class="paragraph">
<p>Word <code>NUM</code>, <code>BNUM</code> and <code>BINS</code> keywords belong to "preprocessor" category, but number constants to the category called
"literals".</p>
</div>
</div>
<div class="sect3">
<h4 id="comments">2.3.5. Comments</h4>
<div class="paragraph">
<p>Only one-line comments will be supported, but of various forms. Generally, comment will be everything starting with
some prefix until the end of the line. Comment prefixes are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Double-slash (<code>//</code>)</p>
</li>
<li>
<p>Semi-colon (<code>;</code>)</p>
</li>
<li>
<p>Double-dash (<code>--</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The token category of comments is "comments".</p>
</div>
</div>
<div class="sect3">
<h4 id="full-example">2.3.6. Full example</h4>
<div class="paragraph">
<p>For example, simple <code>5+3</code> addition can be implemented as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>0 LDN 7 // load negative X into the accumulator
1 SUB 8 // subtract Y from the value in the accumulator
2 STO 9 // store the sum at address 7
3 LDN 9 // A = -(-Sum)
4 STO 9 // store sum
5 HLT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>7 NUM 3 // X
8 NUM 5 // Y
9       // here will be the result</pre>
</div>
</div>
<div class="paragraph">
<p>The accumulator should now contain value <code>8</code>, as well as memory cell at index 9.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preparing-the-environment">2.4. Preparing the environment</h3>
<div class="paragraph">
<p>In order to start developing the compiler, create new Java project in your favorite IDE. In emuStudio, Maven is used for
dependencies management. If you&#8217;re not familiar with Maven, you can start
<a href="https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html">here</a>.</p>
</div>
<div class="paragraph">
<p>The compiler will be implemented as another standard emuStudio plug-in in standard path
<code>plugins/compilers/as-ssem</code>. It will inherit all Maven plug-in dependencies from the main POM file.</p>
</div>
<div class="paragraph">
<p>The directory structure is "dictated" by Maven, so it should look as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>src/
  main/
    java/
    resources/
test/
  java/
pom.xml</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note the naming of the plug-in. We are following the naming convention as described in the <a href="#INTRODUCTION_NAMING">Naming conventions</a>
      guide.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The POM file of the project looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>pom.xml</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span style="color: #BC7A00">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;project</span> <span style="color: #7D9029">xmlns=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
         <span style="color: #7D9029">xmlns:xsi=</span><span style="color: #BA2121">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span style="color: #7D9029">xsi:schemaLocation=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;parent&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emustudio-parent<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;version&gt;</span>0.39<span style="color: #008000; font-weight: bold">&lt;/version&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;relativePath&gt;</span>../../../pom.xml<span style="color: #008000; font-weight: bold">&lt;/relativePath&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/parent&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;modelVersion&gt;</span>4.0.0<span style="color: #008000; font-weight: bold">&lt;/modelVersion&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>as-ssem<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;name&gt;</span>SSEM Assembler<span style="color: #008000; font-weight: bold">&lt;/name&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;description&gt;</span>Assembler of SSEM processor language<span style="color: #008000; font-weight: bold">&lt;/description&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;build&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;finalName&gt;</span>as-ssem<span style="color: #008000; font-weight: bold">&lt;/finalName&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;plugins&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-jar-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;archive&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;manifest&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addClasspath&gt;</span>false<span style="color: #008000; font-weight: bold">&lt;/addClasspath&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;mainClass&gt;</span>net.sf.emustudio.ssem.assembler.Main<span style="color: #008000; font-weight: bold">&lt;/mainClass&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultImplementationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultImplementationEntries&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultSpecificationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultSpecificationEntries&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/manifest&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;manifestEntries&gt;</span>
              <span style="color: #408080; font-style: italic">&lt;!-- DO NOT REMOVE THESE DEPENDENCIES; COMMAND LINE THEN WON&#39;T WORK --&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;Class-Path&gt;</span>lib/java-cup-runtime-${javacup.version}.jar lib/emuLib-${emulib.version}.jar lib/slf4j-api-${slf4j.version}.jar<span style="color: #008000; font-weight: bold">&lt;/Class-Path&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/manifestEntries&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/archive&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-dependency-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>de.jflex<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>jflex-maven-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;executions&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;execution&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;goals&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;goal&gt;</span>generate<span style="color: #008000; font-weight: bold">&lt;/goal&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/goals&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/execution&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/executions&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>com.github.vbmacher<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>cup-maven-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;executions&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;execution&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;goals&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;goal&gt;</span>generate<span style="color: #008000; font-weight: bold">&lt;/goal&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/goals&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/execution&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/executions&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;className&gt;</span>ParserImpl<span style="color: #008000; font-weight: bold">&lt;/className&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;symbolsName&gt;</span>Symbols<span style="color: #008000; font-weight: bold">&lt;/symbolsName&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/plugins&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/build&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;dependencies&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.slf4j<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>slf4j-api<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emuLib<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>com.github.vbmacher<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>java-cup-runtime<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.easymock<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>easymock<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>cpu-testsuite<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;scope&gt;</span>test<span style="color: #008000; font-weight: bold">&lt;/scope&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/dependencies&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/project&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lexical-analyzer-lexer">2.5. Lexical analyzer (lexer)</h3>
<div class="paragraph">
<p>We will start with definition of the lexer specfile. It is a special file, which will be given to <a href="http://jflex.de/">JFlex</a>
during project compilation. Jflex will generate a Java class - the lexer - which will be used by the parser later, and
by emuStudio editor, too. The specification file has special place in the directory structure:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>src/
  main/
    jflex/
      lexer.jflex</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that the specfile is not put into resources directory. If it was so, then it would be included in the final
      JAR file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>JFlex will be called during compilation of the assembler by the
<a href="http://jflex.sourceforge.net/maven-jflex-plugin/generate-mojo.html">JFlex Maven plugin</a> (see the POM file above).
The content of the specfile is as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/jflex/ssem.jflex</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="flex">package net.sf.emustudio.ssem.assembler;

import emulib.plugins.compiler.LexicalAnalyzer;
import emulib.plugins.compiler.Token;
import emulib.runtime.NumberUtils;
import emulib.runtime.RadixUtils;

import java.io.IOException;
import java.io.Reader;
import java.util.Arrays;

%%

/* options */
%class LexerImpl
%cup
%public
%implements LexicalAnalyzer, Symbols
%line
%column
%char
%caseless
%unicode
%type TokenImpl

%{
    @Override
    public Token getSymbol() throws IOException {
        return next_token();
    }

    @Override
    public void reset(Reader in, int yyline, int yychar, int yycolumn) {
        yyreset(in);
        this.yyline = yyline;
        this.yychar = yychar;
        this.yycolumn = yycolumn;
    }

    @Override
    public void reset() {
        this.yyline = 0;
        this.yychar = 0;
        this.yycolumn = 0;
    }

    private TokenImpl token(int type, int category) {
        return new TokenImpl(type, category, yytext(), yyline, yycolumn, yychar);
    }

    private TokenImpl token(int type, int category, Object value) {
        return new TokenImpl(type, category, yytext(), yyline, yycolumn, yychar, value);
    }
%}

%eofval{
    return token(EOF, Token.TEOF);
%eofval}

comment = &quot;//&quot;[^\r\n]*
comment2 = &quot;--&quot;[^\r\n]*
comment3 = &quot;;&quot;[^\r\n]*
eol = \r|\n|\r\n
space = [ \t\f]+
number = \-?[0-9]+
hexnumber = \-?0x[0-9a-fA-F]+
binnumber = [01]+

%xstate BIN

%%

&lt;YYINITIAL&gt; {
    /* reserved words */
    &quot;jmp&quot; {
        return token(JMP, Token.RESERVED);
    }
    &quot;jrp&quot; {
        return token(JPR, Token.RESERVED);
    }
    &quot;jpr&quot; {
        return token(JPR, Token.RESERVED);
    }
    &quot;jmr&quot; {
        return token(JPR, Token.RESERVED);
    }
    &quot;ldn&quot; {
        return token(LDN, Token.RESERVED);
    }
    &quot;sto&quot; {
        return token(STO, Token.RESERVED);
    }
    &quot;sub&quot; {
        return token(SUB, Token.RESERVED);
    }
    &quot;cmp&quot; {
        return token(CMP, Token.RESERVED);
    }
    &quot;skn&quot; {
        return token(CMP, Token.RESERVED);
    }
    &quot;stp&quot; {
        return token(STP, Token.RESERVED);
    }
    &quot;hlt&quot; {
        return token(STP, Token.RESERVED);
    }

    /* special */
    &quot;start:&quot; {
        return token(START, Token.PREPROCESSOR);
    }
    &quot;num&quot; {
        return token(NUM, Token.PREPROCESSOR);
    }
    &quot;bnum&quot; {
        yybegin(BIN);
        return token(BNUM, Token.PREPROCESSOR);
    }
    &quot;bins&quot; {
        yybegin(BIN);
        return token(BNUM, Token.PREPROCESSOR);
    }

    /* comment */
    {comment} {
        return token(TCOMMENT, Token.COMMENT);
    }
    {comment2} {
        return token(TCOMMENT, Token.COMMENT);
    }
    {comment3} {
        return token(TCOMMENT, Token.COMMENT);
    }

    /* literals */
    {number} {
        int num = Integer.parseInt(yytext(), 10);
        return token(NUMBER, Token.LITERAL, num);
    }

    {hexnumber} {
        int num = Integer.decode(yytext());
        return token(NUMBER, Token.LITERAL, num);
    }
}

/* separators */
&lt;YYINITIAL, BIN&gt; {eol} {
    return token(SEPARATOR_EOL, Token.SEPARATOR);
}
&lt;YYINITIAL, BIN&gt; {space} { /* ignore white spaces */ }

&lt;BIN&gt; {

    {binnumber} {
        yybegin(YYINITIAL);

        byte[] numberArray = RadixUtils.convertToNumber(yytext(), 2, 4);
        int num = NumberUtils.reverseBits(
            NumberUtils.readInt(
                NumberUtils.toObjectArray(numberArray), NumberUtils.Strategy.LITTLE_ENDIAN
            ), 32
        );

        return token(NUMBER, Token.LITERAL, num);
    }

    [^] {
        yybegin(YYINITIAL);
    }

}

/* error fallback */
[^] {
    return token(ERROR_UNKNOWN_TOKEN, Token.ERROR);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can notice, the specfile uses special class named <code>TokenImpl</code>. We must implement this class by ourselves. It
holds the basic information about the parsed token, like offset, length, type, etc. There are several requirements
when implementing the class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It must extend <code>java_cup.runtime.Symbol</code> class, for JFlex - cup interoperability.</p>
</li>
<li>
<p>It must implement <code>emulib.plugins.compiler.Token</code> interface, for being able to use this class in emuStudio syntax
highlighter</p>
</li>
<li>
<p>It&#8217;s now a secret, but it would have to implement also special <code>Symbols</code> interface, which will be generated by
parser, described in section below.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Syntax highlighter in emuStudio represents the source code in a dynamic "lexical tree". It scans regularly required text
blocks in the editor and translates them into the symbolic representation - into tokens, which are arranged in a tree
structure. Tokens are parsed by the lexer, provided by us. And <code>Token</code> interface is the shared API known by our specific
lexer and general syntax highlighter in emuStudio.</p>
</div>
<div class="paragraph">
<p>Tokens are assigned into categories, as was already mentioned in section <a href="#COMPILER_TOKEN_CATEGORIES">Token categories</a>. Token categories have
assigned their specific editor style, like color or font.</p>
</div>
<div class="paragraph">
<p>The content of the <code>net.sf.emustudio.ssem.assembler.TokenImpl</code> class is as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/TokenImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.Token</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java_cup.runtime.ComplexSymbolFactory</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">TokenImpl</span> <span style="color: #008000; font-weight: bold">extends</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">ComplexSymbol</span> <span style="color: #008000; font-weight: bold">implements</span> Token<span style="color: #666666">,</span> Symbols <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">int</span> category<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">int</span> cchar<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">TokenImpl</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> id<span style="color: #666666">,</span> <span style="color: #B00040">int</span> category<span style="color: #666666">,</span> String text<span style="color: #666666">,</span> <span style="color: #B00040">int</span> line<span style="color: #666666">,</span> <span style="color: #B00040">int</span> column<span style="color: #666666">,</span> <span style="color: #B00040">int</span> cchar<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>
            text<span style="color: #666666">,</span> id<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">Location</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> column<span style="color: #666666">),</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">Location</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> column<span style="color: #666666">)</span>
        <span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">category</span> <span style="color: #666666">=</span> category<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">cchar</span> <span style="color: #666666">=</span> cchar<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">TokenImpl</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> id<span style="color: #666666">,</span> <span style="color: #B00040">int</span> category<span style="color: #666666">,</span> String text<span style="color: #666666">,</span> <span style="color: #B00040">int</span> line<span style="color: #666666">,</span> <span style="color: #B00040">int</span> column<span style="color: #666666">,</span> <span style="color: #B00040">int</span> cchar<span style="color: #666666">,</span> Object value<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>
            text<span style="color: #666666">,</span> id<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">Location</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> column<span style="color: #666666">),</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">.</span><span style="color: #7D9029">Location</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> column<span style="color: #666666">),</span> value
        <span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">category</span> <span style="color: #666666">=</span> category<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">cchar</span> <span style="color: #666666">=</span> cchar<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getID</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">sym</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getType</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> category<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getLine</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">getLeft</span><span style="color: #666666">().</span><span style="color: #7D9029">getLine</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getColumn</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">getLeft</span><span style="color: #666666">().</span><span style="color: #7D9029">getColumn</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getOffset</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> cchar<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getLength</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> getName<span style="color: #666666">().</span><span style="color: #7D9029">length</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getErrorString</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;Unknown token&quot;</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getText</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> getName<span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isInitialLexicalState</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">sym</span> <span style="color: #666666">!=</span> BNUM<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="COMPILER_GRAMMAR">2.6. Syntax analyzer (parser)</h3>
<div class="paragraph">
<p>Next, we define the grammar file. It is also a special file, which will be given to cup during project
compilation. Cup will generate Java classes - the parser - which we will use in our code. The specfile
has special place in the directory structure:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>src/
  main/
    cup/
      parser.cup</pre>
</div>
</div>
<div class="paragraph">
<p>Grammar type and form we use depends on the parsing algorithm we choose. In emuStudio, all compilers use
<a href="http://www2.cs.tum.edu/projects/cup/">Java cup</a> parser generator, which does bottom-up parsing, and supported grammars
are of type LALR.</p>
</div>
<div class="paragraph">
<p>The main difference between LL and LALR grammars is that in LALR you can freely use left-recursion, but not right
recursion. Otherwise you would get shift/reduce conflicts. For more information, see for example
<a href="https://lambda.uta.edu/cse5317/notes/node21.html">this site</a>.</p>
</div>
<div class="paragraph">
<p>The grammar specfile of SSEM assembler parser follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/cup/parser.cup</code></div>
<div class="content">
<pre class="pygments highlight"><code>package net.sf.emustudio.ssem.assembler;

import emulib.plugins.compiler.Message;
import emulib.plugins.compiler.Token;
import java_cup.runtime.ComplexSymbolFactory;
import java_cup.runtime.Symbol;
import net.sf.emustudio.ssem.assembler.tree.ASTnode;
import net.sf.emustudio.ssem.assembler.tree.Constant;
import net.sf.emustudio.ssem.assembler.tree.Instruction;
import net.sf.emustudio.ssem.assembler.tree.Program;

import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

parser code {:
    private LexerImpl lexer;
    private boolean syntaxErrors;
    private CompilerImpl compiler;

    public ParserImpl(LexerImpl lex, ComplexSymbolFactory csf, CompilerImpl compiler) {
        super(lex, csf);
        lexer = Objects.requireNonNull(lex);
        this.compiler = Objects.requireNonNull(compiler);
    }

    @Override
    public void report_fatal_error(String message, Object info) throws Exception {
        done_parsing();
        report_error(message, info);
        throw new Exception("Can\'t recover from previous error(s)");
    }

    @Override
    public void report_error(String messageText, Object current) {
        syntaxErrors = true;

        Token token = (Token)current;

        messageText += ":" + token.getErrorString() + " ('" + token.getText() + "')";

        List expectedTokenIds = expected_token_ids()
            .stream()
            .map(id -&gt; symbl_name_from_id(id.intValue()))
            .collect(Collectors.toList());

        if (!expectedTokenIds.isEmpty()) {
            messageText += "\nExpected tokens: " + expectedTokenIds;
        }

        Message message = new Message(
            Message.MessageType.TYPE_ERROR, messageText, token.getLine()+1, token.getColumn(), null, 0
        );

        if (compiler != null) {
            compiler.notifyOnMessage(message);
        } else {
            System.err.println(message.getFormattedMessage());
        }
    }

    public boolean hasSyntaxErrors() {
        return syntaxErrors;
    }

:};

terminal JMP, JPR, LDN, STO, SUB, CMP, STP, NUM, BNUM;
terminal SEPARATOR_EOL, TCOMMENT, ERROR_UNKNOWN_TOKEN;
terminal Integer NUMBER;
terminal START;

non terminal Program Program;
non terminal ASTnode Statement;
non terminal Instruction Instruction;
non terminal Constant Constant;
non terminal Comment;

start with Program;

Program ::= NUMBER:c Statement:s Program:p              {: if (s != null) p.statement(c, s); RESULT = p;  :}
    | NUMBER:c Comment SEPARATOR_EOL Program:p          {: RESULT = p; :}
    | Comment SEPARATOR_EOL Program:p                   {: RESULT = p; :}
    | START SEPARATOR_EOL Program:p                     {: p.nextLineStarts(); RESULT = p; :}
    | /* empty program */                               {: RESULT = new Program(); :}
    ;

Statement ::= Instruction:i Comment SEPARATOR_EOL       {: RESULT = i; :}
    | Constant:c Comment SEPARATOR_EOL                  {: RESULT = c; :}
    ;

Instruction ::= JMP NUMBER:line             {: RESULT = Instruction.jmp(line); :}
    | JPR NUMBER:line                       {: RESULT = Instruction.jrp(line); :}
    | LDN NUMBER:line                       {: RESULT = Instruction.ldn(line); :}
    | STO NUMBER:line                       {: RESULT = Instruction.sto(line); :}
    | SUB NUMBER:line                       {: RESULT = Instruction.sub(line); :}
    | CMP                                   {: RESULT = Instruction.cmp(); :}
    | STP                                   {: RESULT = Instruction.stp(); :}
    | error
    ;

Constant ::= NUM NUMBER:raw                 {: RESULT = new Constant(raw); :}
    | BNUM NUMBER:raw                       {: RESULT = new Constant(raw); :}
    ;

Comment ::= TCOMMENT
    | /* no comment*/
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The right sides - code snippets wrapped between <code>{:</code> and <code>:}</code> - is Java code which will be executed when particular rule
of the grammar is applied. Remember, that they will be applied in reverse - first will be applied the right-most rules.</p>
</div>
<div class="paragraph">
<p>There exist a special variable <code>RESULT</code>, which should return some Java object of type which the
non-terminal defines for it <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>For more information, especially about the <code>error</code> symbol, please read <a href="http://www2.cs.tum.edu/projects/cup/">cup</a>
documentation.</p>
</div>
</div>
<div class="sect2">
<h3 id="COMPILER_AST">2.7. Introducing AST</h3>
<div class="paragraph">
<p>The code won&#8217;t compile so far. The reason is that the parser strangely uses some undefined classes, such as <code>Program</code>,
<code>ASTnode</code>, <code>Instruction</code> and <code>Constant</code>. They are defined in the grammar file as follows (see above):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>non terminal Program Program;
non terminal ASTnode Statement;
non terminal Instruction Instruction;
non terminal Constant Constant;</pre>
</div>
</div>
<div class="paragraph">
<p>These classes are part of so-called abstract syntax tree, and they wait for our implementation. Abstract Syntax Tree
(or AST) is a "symbolic" representation of the parsed program source code. The parser creates one as a side-effect of
parsing. It is different from Parse Syntax Tree (PST), which represents a tree of true grammar derivations which were
"detected" by the parser for given source code of a program.</p>
</div>
<div class="paragraph">
<p>AST is something more artificial, ie. not all grammar rules need to be taken into account when representing the program.
For this reason, we define only some "nodes" of the derivation tree. In our case, it is <code>Program</code>, representing the
"root" of the tree, which has children - `Statement`s. Statements have `Instruction`s or `Constant`s as its children.</p>
</div>
<div class="paragraph">
<p>Do you remember those code snippets in the grammar specfile wrapped in <code>{: &#8230;&#8203; :}</code> ? This code snippets create the
AST, just follow them.</p>
</div>
<div class="paragraph">
<p>It&#8217;s now time to implement them. Since we know all nodes are just nodes of our AST, we should define common <code>ASTnode</code>
interface first:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/tree/ASTnode.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">interface</span> <span style="color: #0000FF; font-weight: bold">ASTnode</span> <span style="color: #666666">{</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">accept</span><span style="color: #666666">(</span>ASTvisitor visitor<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception<span style="color: #666666">;</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This interface will be useful when we will traverse the tree. For tree traversal it is very well-suited the
<a href="https://sourcemaking.com/design_patterns/visitor">Visitor pattern</a>. The idea of traversing a tree using visitor pattern
is to have the "visitor" object - which represents an object which wants to go through all nodes of the tree and do
something. The algorithm of visiting is based on a premise that each node of the AST implements the <code>accept()</code> method.
That way, each node is responsible for calling the visitor for each its children and itself.
So the effect is that the "visitor" will "get" the all tree node objects, when the <code>accept()</code> method is called on the
root of the tree.</p>
</div>
<div class="paragraph">
<p>We can now define the visitor interface as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/tree/ASTvisitor.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">interface</span> <span style="color: #0000FF; font-weight: bold">ASTvisitor</span> <span style="color: #666666">{</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">setCurrentLine</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">);</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Instruction instruction<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception<span style="color: #666666">;</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Constant constant<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception<span style="color: #666666">;</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The methods of the visitor will be implemented by some visitor, for example a code generator. However, we need to
finish implementation of the AST first.</p>
</div>
<div class="sect3">
<h4 id="program-node">2.7.1. 'Program' node</h4>
<div class="paragraph">
<p>The root node of the AST is the <code>Program</code> class. According to the grammar, it contains all the statements, which are
either <code>Instruction</code> or <code>Constant</code>. Notice how we implemented traversing of the node:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/tree/Program.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.HashMap</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Map</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Program</span> <span style="color: #008000; font-weight: bold">implements</span> ASTnode <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> Map<span style="color: #666666">&lt;</span>Integer<span style="color: #666666">,</span> ASTnode<span style="color: #666666">&gt;</span> nodes <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> HashMap<span style="color: #666666">&lt;&gt;();</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> startLine <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> previousLine <span style="color: #666666">=</span> <span style="color: #666666">0;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">statement</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">,</span> ASTnode node<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        previousLine <span style="color: #666666">=</span> line<span style="color: #666666">;</span>
        nodes<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> node<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">nextLineStarts</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">startLine</span> <span style="color: #666666">=</span> previousLine<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getStartLine</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> startLine<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">accept</span><span style="color: #666666">(</span>ASTvisitor visitor<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span>Map<span style="color: #666666">.</span><span style="color: #7D9029">Entry</span><span style="color: #666666">&lt;</span>Integer<span style="color: #666666">,</span> ASTnode<span style="color: #666666">&gt;</span> node <span style="color: #666666">:</span> nodes<span style="color: #666666">.</span><span style="color: #7D9029">entrySet</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
            visitor<span style="color: #666666">.</span><span style="color: #7D9029">setCurrentLine</span><span style="color: #666666">(</span>node<span style="color: #666666">.</span><span style="color: #7D9029">getKey</span><span style="color: #666666">());</span>
            node<span style="color: #666666">.</span><span style="color: #7D9029">getValue</span><span style="color: #666666">().</span><span style="color: #7D9029">accept</span><span style="color: #666666">(</span>visitor<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The important note is that how the statements are stored. They are in fact the children of the program node. For this
purpose a key-value map is used. Key has type <code>Integer</code> and it represents the line - or memory cell index, or address -
on which the statement will be located. That way we can write several instructions which lie on the same line, e.g.:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>01 LDN 15
01 STO 06</pre>
</div>
</div>
<div class="paragraph">
<p>which will be translated into two statements, but the program node will contain just the last one. The reason is that
they share the line - <code>01</code> - which is the key in the map of statements, so the first statement will be "overwritten"
by the second one.</p>
</div>
<div class="paragraph">
<p>It is for a debate if we want this behavior to happen. For simplicity, we allow it. Otherwise we would throw some
compiler exception.</p>
</div>
</div>
<div class="sect3">
<h4 id="instruction-node">2.7.2. 'Instruction' node</h4>
<div class="paragraph">
<p>Instruction node represents the instruction. If you remember, each instruction except <code>STP</code> and <code>CMP</code> has a parameter,
or better - operand - which is a "line" - index of a memory cell. It would be possible to represent specific
instructions by separate classes, but since the required operations would be shared, it would be much easier to have
just one class for all the instructions. Generally, instructions with same number and type of parameters are usually
implemented in one AST node.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the source code:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/tree/Instruction.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.CompileException</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Optional</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Instruction</span> <span style="color: #008000; font-weight: bold">implements</span> ASTnode <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> JMP <span style="color: #666666">=</span> <span style="color: #666666">0;</span> <span style="color: #408080; font-style: italic">// 000</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> JRP <span style="color: #666666">=</span> <span style="color: #666666">4;</span> <span style="color: #408080; font-style: italic">// 100</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> LDN <span style="color: #666666">=</span> <span style="color: #666666">2;</span> <span style="color: #408080; font-style: italic">// 010</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> STO <span style="color: #666666">=</span> <span style="color: #666666">6;</span> <span style="color: #408080; font-style: italic">// 110</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> SUB <span style="color: #666666">=</span> <span style="color: #666666">1;</span> <span style="color: #408080; font-style: italic">// 001</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> CMP <span style="color: #666666">=</span> <span style="color: #666666">3;</span> <span style="color: #408080; font-style: italic">// 011</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">byte</span> STP <span style="color: #666666">=</span> <span style="color: #666666">7;</span> <span style="color: #408080; font-style: italic">// 111</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> String<span style="color: #666666">[]</span> INSTRUCTION_STRING <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> String<span style="color: #666666">[]</span> <span style="color: #666666">{</span>
        <span style="color: #BA2121">&quot;JMP&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;SUB&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;LDN&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;CMP&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;JRP&quot;</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;STO&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;STP&quot;</span>
    <span style="color: #666666">};</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">int</span> opcode<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> Optional<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> operand<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #0000FF">Instruction</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> opcode<span style="color: #666666">,</span> <span style="color: #B00040">int</span> operand<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>operand <span style="color: #666666">&gt;</span> <span style="color: #666666">31</span> <span style="color: #666666">||</span> operand <span style="color: #666666">&lt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> CompileException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Instruction operand must be in range &lt;0,31&gt;!&quot;</span><span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">operand</span> <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">of</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)(</span>operand <span style="color: #666666">&amp;</span> <span style="color: #666666">0xFF));</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">opcode</span> <span style="color: #666666">=</span> opcode<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #0000FF">Instruction</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> opcode<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">operand</span> <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">empty</span><span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">opcode</span> <span style="color: #666666">=</span> opcode<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getOpcode</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> opcode<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> Optional<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> <span style="color: #0000FF">getOperand</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> operand<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">jmp</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>JMP<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">jrp</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>JRP<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">ldn</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>LDN<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">sto</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>STO<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">sub</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>SUB<span style="color: #666666">,</span> address<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">cmp</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>CMP<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> Instruction <span style="color: #0000FF">stp</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Instruction<span style="color: #666666">(</span>STP<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">accept</span><span style="color: #666666">(</span>ASTvisitor visitor<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
         visitor<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">equals</span><span style="color: #666666">(</span>Object o<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span> <span style="color: #666666">==</span> o<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>o <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">||</span> getClass<span style="color: #666666">()</span> <span style="color: #666666">!=</span> o<span style="color: #666666">.</span><span style="color: #7D9029">getClass</span><span style="color: #666666">())</span> <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>

        Instruction that <span style="color: #666666">=</span> <span style="color: #666666">(</span>Instruction<span style="color: #666666">)</span> o<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">return</span> opcode <span style="color: #666666">==</span> that<span style="color: #666666">.</span><span style="color: #7D9029">opcode</span> <span style="color: #666666">&amp;&amp;</span> operand<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span>that<span style="color: #666666">.</span><span style="color: #7D9029">operand</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">hashCode</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> result <span style="color: #666666">=</span> opcode<span style="color: #666666">;</span>
        result <span style="color: #666666">=</span> <span style="color: #666666">31</span> <span style="color: #666666">*</span> result <span style="color: #666666">+</span> operand<span style="color: #666666">.</span><span style="color: #7D9029">hashCode</span><span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">return</span> result<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">toString</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> INSTRUCTION_STRING<span style="color: #666666">[</span>opcode<span style="color: #666666">]</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; &quot;</span> <span style="color: #666666">+</span> operand<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the constructor is private. The implication is that it is just impossible to create some invalid <code>Instruction</code>
object. The only possible way how to define it is using static factory methods, which represent the instructions
themselves. These are called from the parser - check the grammar specfile in the section <a href="#COMPILER_GRAMMAR">Syntax analyzer (parser)</a>.</p>
</div>
<div class="paragraph">
<p>Also, note that we can compare instructions based on opcode and operand. This is allowed by custom implementations of
methods <code>hashCode()</code> and <code>equals()</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="constant-node">2.7.3. 'Constant' node</h4>
<div class="paragraph">
<p>Another kind of statement is a constant. The constant is just a number, and the node class is very simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Constant</span> <span style="color: #008000; font-weight: bold">implements</span> ASTnode <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">int</span> number<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">Constant</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> number<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">number</span> <span style="color: #666666">=</span> number<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">accept</span><span style="color: #666666">(</span>ASTvisitor visitor<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        visitor<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getNumber</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> number<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">equals</span><span style="color: #666666">(</span>Object o<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span> <span style="color: #666666">==</span> o<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>o <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">||</span> getClass<span style="color: #666666">()</span> <span style="color: #666666">!=</span> o<span style="color: #666666">.</span><span style="color: #7D9029">getClass</span><span style="color: #666666">())</span> <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>

        Constant constant <span style="color: #666666">=</span> <span style="color: #666666">(</span>Constant<span style="color: #666666">)</span> o<span style="color: #666666">;</span>

        <span style="color: #008000; font-weight: bold">return</span> number <span style="color: #666666">==</span> constant<span style="color: #666666">.</span><span style="color: #7D9029">number</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">hashCode</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> number<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comparing <code>Constant</code> instances is based on comparing the numbers they represent.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing">2.8. Testing</h3>
<div class="paragraph">
<p>It is very good practice to write automated tests. These will give us some level of confidence that what we did so far
is actually working. It is the earliest feedback we can get on our work, which consequently improves the speed of
creating sofware which actually works.</p>
</div>
<div class="paragraph">
<p>A unit test is just a normal class which contains test methods. A test method generally creates the testing object, does
the testing operation and finally check if the operation did what it should. Each test method should test just one thing
and should be short and clear. It is good practice to name test method according to the test case, possibly resulting
in a whole sentence, in camel case.</p>
</div>
<div class="paragraph">
<p>Java projects use some unit testing framework for that, e.g. JUnit or TestNG, which recognizes those classes
automatically and runs the test methods during the compilation of the project. If a test fails, the whole compilation
is stopped as failed.</p>
</div>
<div class="paragraph">
<p>For lexer and parser we create unit test classes, which will be placed here (following to Maven directory structure):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>src/
  test/
    java/
      net/
        sf/
          emustudio/
            ssem/
              assembler/
                LexerTest.java
                ParserTest.java</pre>
</div>
</div>
<div class="paragraph">
<p>The content of the test classes are as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/test/java/net/sf/emustudio/ssem/assembler/LexerTest.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.Token</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.Test</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.StringReader</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertEquals</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertFalse</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">LexerTest</span> <span style="color: #666666">{</span>

    LexerImpl <span style="color: #0000FF">lexer</span><span style="color: #666666">(</span>String tokens<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> LexerImpl<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> StringReader<span style="color: #666666">(</span>tokens<span style="color: #666666">));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testNumberUpperBoundary</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;31&quot;</span><span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(31,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">value</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testNumberLowerBoundary</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(0,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">value</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testNumber</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;22&quot;</span><span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(22,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">value</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">checkInstruction</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> id<span style="color: #666666">,</span> LexerImpl lexer<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">RESERVED</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>id<span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">checkInstructionWithOperand</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> id<span style="color: #666666">,</span> LexerImpl lexer<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        checkInstruction<span style="color: #666666">(</span>id<span style="color: #666666">,</span> lexer<span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionsWithOperand</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">JMP</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;jmp 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">JPR</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;jrp 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">JPR</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;jpr 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">JPR</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;jmr 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">LDN</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;ldn 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">STO</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;sto 12&quot;</span><span style="color: #666666">));</span>
        checkInstructionWithOperand<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">SUB</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;sub 12&quot;</span><span style="color: #666666">));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionsWithoutOperand</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        checkInstruction<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">CMP</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;cmp&quot;</span><span style="color: #666666">));</span>
        checkInstruction<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">CMP</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;skn&quot;</span><span style="color: #666666">));</span>
        checkInstruction<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">STP</span><span style="color: #666666">,</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;stp&quot;</span><span style="color: #666666">));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionInComment</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;// cmp&quot;</span><span style="color: #666666">);</span>
        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>

        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">TCOMMENT</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">COMMENT</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>

        token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">TEOF</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">EOF</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testBinaryNumber</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        LexerImpl lexer <span style="color: #666666">=</span> lexer<span style="color: #666666">(</span><span style="color: #BA2121">&quot;BNUM 10011011111000101111110000111111\n&quot;</span><span style="color: #666666">);</span>

        TokenImpl token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">PREPROCESSOR</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">BNUM</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
        assertFalse<span style="color: #666666">(</span>token<span style="color: #666666">.</span><span style="color: #7D9029">isInitialLexicalState</span><span style="color: #666666">());</span>

        token <span style="color: #666666">=</span> lexer<span style="color: #666666">.</span><span style="color: #7D9029">next_token</span><span style="color: #666666">();</span>
        assertEquals<span style="color: #666666">(</span>Token<span style="color: #666666">.</span><span style="color: #7D9029">LITERAL</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getType</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(</span>TokenImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER</span><span style="color: #666666">,</span> token<span style="color: #666666">.</span><span style="color: #7D9029">getID</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>src/test/java/net/sf/emustudio/ssem/assembler/ParserTest.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java_cup.runtime.ComplexSymbolFactory</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.ASTvisitor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Constant</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Instruction</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Program</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.Test</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.StringReader</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Arrays</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Deque</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.LinkedList</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertEquals</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertFalse</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertTrue</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.fail</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ParserTest</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> ParserImpl <span style="color: #0000FF">program</span><span style="color: #666666">(</span>String program<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> ParserImpl<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> LexerImpl<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> StringReader<span style="color: #666666">(</span>program<span style="color: #666666">)),</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructions</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span>
            <span style="color: #BA2121">&quot;0 cmp // comment\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;1 stp\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;2 jmp 22\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;3 jrp 0\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;4 ldn 31\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;5 sto 10\n&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;6 sub 15\n&quot;</span>
        <span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>

        Deque<span style="color: #666666">&lt;</span>Instruction<span style="color: #666666">&gt;</span> expectedInstructions <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> LinkedList<span style="color: #666666">&lt;&gt;(</span>Arrays<span style="color: #666666">.</span><span style="color: #7D9029">asList</span><span style="color: #666666">(</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">cmp</span><span style="color: #666666">(),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">stp</span><span style="color: #666666">(),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">jmp</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)22),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">jrp</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)0),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">ldn</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)31),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">sto</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)10),</span>
            Instruction<span style="color: #666666">.</span><span style="color: #7D9029">sub</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)15)</span>
        <span style="color: #666666">));</span>
        program<span style="color: #666666">.</span><span style="color: #7D9029">accept</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> ASTvisitor<span style="color: #666666">()</span> <span style="color: #666666">{</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setCurrentLine</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>

            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Instruction instruction<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
                assertEquals<span style="color: #666666">(</span>expectedInstructions<span style="color: #666666">.</span><span style="color: #7D9029">removeFirst</span><span style="color: #666666">(),</span> instruction<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Constant constant<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
                fail<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Didn&#39;t expect a constant&quot;</span><span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>
    <span style="color: #666666">}</span>


    <span style="color: #AA22FF">@Test</span><span style="color: #666666">(</span>expected <span style="color: #666666">=</span> Exception<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">)</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionWithoutEOL</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0 jmp 1&quot;</span><span style="color: #666666">);</span>

        parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testInstructionWithoutProperArgument</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0 jmp ffff\n&quot;</span><span style="color: #666666">);</span>

        parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">();</span>
        assertTrue<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testConstantIsTranslatedCorrectly</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span>
            <span style="color: #BA2121">&quot;0 NUM 5\n&quot;</span>
        <span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>

        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>
        assertConstant<span style="color: #666666">(</span>program<span style="color: #666666">,</span> <span style="color: #666666">5);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testHexadecimalConstant</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span>
            <span style="color: #BA2121">&quot;0 NUM -0x20\n&quot;</span>
        <span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>

        assertConstant<span style="color: #666666">(</span>program<span style="color: #666666">,</span> <span style="color: #666666">-32);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testStartingPointIsAccepted</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0 jmp 1\nstart:\n3 cmp\n&quot;</span><span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>
        assertEquals<span style="color: #666666">(3,</span> program<span style="color: #666666">.</span><span style="color: #7D9029">getStartLine</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testIndexOfLineThenCommentWorks</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        ParserImpl parser <span style="color: #666666">=</span> program<span style="color: #666666">(</span><span style="color: #BA2121">&quot;0 --comment\n&quot;</span><span style="color: #666666">);</span>

        Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
        assertFalse<span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">assertConstant</span><span style="color: #666666">(</span>Program program<span style="color: #666666">,</span> <span style="color: #B00040">int</span> value<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        program<span style="color: #666666">.</span><span style="color: #7D9029">accept</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> ASTvisitor<span style="color: #666666">()</span> <span style="color: #666666">{</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setCurrentLine</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>

            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Instruction instruction<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
                fail<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Didn&#39;t expect an instruction&quot;</span><span style="color: #666666">);</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Constant constant<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
                assertEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Constant<span style="color: #666666">(</span>value<span style="color: #666666">),</span> constant<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The tests of parser are based on comparing <code>Instruction</code> and <code>Constant</code> instances with JUnit&#8217;s <code>assertEquals()</code>
      method. This is possible only because of overriden <code>equals()</code> and <code>hashCode()</code> methods in the classes, since
      they are used directly by Java when it is comparing the instances.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="the-main-class">2.9. The main class</h3>
<div class="paragraph">
<p>The time has come for implementing the main plug-in class. It will be placed in a package
<code>net.sf.emustudio.ssem.assembler</code>, and the class will be named <code>CompilerImpl</code>.</p>
</div>
<div class="paragraph">
<p>There are several requirements (behavioral contracts) put on the compiler main class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It must implement <code>emulib.plugins.compiler.Compiler</code> interface. There already exists helper abstract class called
<code>emulib.plugins.compiler.AbstractCompiler</code>, which implements some fundamental and general methods. We will use that
class.</p>
</li>
<li>
<p>It must be annotated with <code>emulib.annotations.PluginType</code> annotation.</p>
</li>
<li>
<p>The constructor gets two arguments: unique plugin ID (<code>Long</code>) and <code>emulib.runtime.ContextPool</code> object. Both values
are created by emuStudio, and we will talk about them later.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now, the "skeleton" of the class follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/CompilerImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PLUGIN_TYPE</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PluginType</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.AbstractCompiler</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.LexicalAnalyzer</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.SourceFileExtension</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.ContextPool</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.Reader</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>

<span style="color: #AA22FF">@PluginType</span><span style="color: #666666">(</span>
    type <span style="color: #666666">=</span> PLUGIN_TYPE<span style="color: #666666">.</span><span style="color: #7D9029">COMPILER</span><span style="color: #666666">,</span>
    title <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;SSEM Assembler&quot;</span><span style="color: #666666">,</span>
    copyright <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;\u00A9 Copyright 2016, YourName&quot;</span><span style="color: #666666">,</span>
    description <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Assembler of SSEM processor language&quot;</span>
<span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CompilerImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCompiler <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">final</span> SourceFileExtension<span style="color: #666666">[]</span> SOURCE_FILE_EXTENSIONS <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> SourceFileExtension<span style="color: #666666">[]{</span>
        <span style="color: #008000; font-weight: bold">new</span> SourceFileExtension<span style="color: #666666">(</span><span style="color: #BA2121">&quot;ssem&quot;</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;SSEM source file&quot;</span><span style="color: #666666">)</span>
    <span style="color: #666666">};</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> ContextPool contextPool<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">CompilerImpl</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">contextPool</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>contextPool<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">compile</span><span style="color: #666666">(</span>String inputFileName<span style="color: #666666">,</span> String outputFileName<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #408080; font-style: italic">// TODO !!</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">compile</span><span style="color: #666666">(</span>String inputFileName<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        String outputFileName <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>inputFileName<span style="color: #666666">);</span>
        SourceFileExtension srcExtension <span style="color: #666666">=</span> SOURCE_FILE_EXTENSIONS<span style="color: #666666">[0];</span>

        <span style="color: #B00040">int</span> i <span style="color: #666666">=</span> inputFileName<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;.&quot;</span> <span style="color: #666666">+</span> srcExtension<span style="color: #666666">.</span><span style="color: #7D9029">getExtension</span><span style="color: #666666">());</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>i <span style="color: #666666">&gt;=</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
            outputFileName <span style="color: #666666">=</span> outputFileName<span style="color: #666666">.</span><span style="color: #7D9029">substring</span><span style="color: #666666">(0,</span> i<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> compile<span style="color: #666666">(</span>inputFileName<span style="color: #666666">,</span> outputFileName <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;.bin&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> LexicalAnalyzer <span style="color: #0000FF">getLexer</span><span style="color: #666666">(</span>Reader reader<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> LexerImpl<span style="color: #666666">(</span>reader<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> SourceFileExtension<span style="color: #666666">[]</span> <span style="color: #0000FF">getSourceSuffixList</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> SOURCE_FILE_EXTENSIONS<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">destroy</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">showSettings</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isShowSettingsSupported</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getVersion</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;1.0&quot;</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some things are obvious, some maybe not. For example, method <code>getLexer()</code> is called by emuStudio for the syntax
highlighter. It is very straightforward - just return new <code>LexerImpl()</code> which was generated by JFlex from our
specfile.</p>
</div>
<div class="paragraph">
<p>Method <code>compile(String)</code> might seem complex at first look. It is "ugly" Java code which tries to check if the given
file name ends with our supported file suffix, which is ".ssem". We chose it as the suffix of SSEM source code file.
We could chose ".asm" or other extension as well. Then, the "real" <code>compile()</code> method is called with the input file
and the output file name, which has suffix ".bin".</p>
</div>
<div class="paragraph">
<p>Method <code>getSourceSuffixList()</code> returns all supported extensions, and will be used in the file filter in the open file
dialog shown in emuStudio.</p>
</div>
<div class="paragraph">
<p>Compiler can have it&#8217;s own settings dialog (GUI window) which can be shown. This is reflected by the methods
<code>isShowSettingsSupported()</code> and <code>showSettings()</code>. Our assembler will not support the dialog.</p>
</div>
<div class="paragraph">
<p>The "real" <code>compile()</code> method is left to be done in the last section.</p>
</div>
</div>
<div class="sect2">
<h3 id="generating-code">2.10. Generating code</h3>
<div class="paragraph">
<p>So far, we have implemented a parser which creates our AST. Next operations which compilers do are semantic analysis,
optimization and code generation. These three phases are performed on the AST. The algorithms traverse the tree and
update some own internal state, or state of the AST based on visited nodes. Code generator at the end take the results,
and again - by traversing AST - generates the code.</p>
</div>
<div class="paragraph">
<p>In our case, we don&#8217;t need any semantic analysis, like type-checks or so, because we have simple machine instructions,
which do not require it. We could optimize them, but for the simplicity we will omit this step as well. We will rather
focus on the final step - code generation.</p>
</div>
<div class="paragraph">
<p>You might remember the section <a href="#COMPILER_AST">Introducing AST</a>, which talked about AST traversal. We already have <code>ASTnode</code> and <code>ASTvisitor</code>
interfaces. The traversal is already implemented, according to the Visitor pattern, by the nodes themselves. One thing
which is left to do is to implement the visitor itself - the code generator class.</p>
</div>
<div class="paragraph">
<p>For each encountered instruction, the code generator will generate a binary code. Our code generator will write the
binary representation into a file. However, it is generally better if I/O classes work with I/O abstractions
(streams, channels, etc.) rather than specific objects, e.g. files. Out code generator will be implemented in a
similar fashion. The code is as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/CodeGenerator.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.NumberUtils</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.NumberUtils.Strategy</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.ASTvisitor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Constant</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Instruction</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CodeGenerator</span> <span style="color: #008000; font-weight: bold">implements</span> ASTvisitor<span style="color: #666666">,</span> AutoCloseable <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> SeekableOutputStream writer<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> currentLine<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">CodeGenerator</span><span style="color: #666666">(</span>SeekableOutputStream writer<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">writer</span><span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>writer<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setCurrentLine</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">currentLine</span> <span style="color: #666666">=</span> line<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Instruction instruction<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> CompileException<span style="color: #666666">,</span> IOException <span style="color: #666666">{</span>
        <span style="color: #B00040">byte</span> address <span style="color: #666666">=</span> instruction<span style="color: #666666">.</span><span style="color: #7D9029">getOperand</span><span style="color: #666666">().</span><span style="color: #7D9029">orElse</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)0);</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>address <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span> <span style="color: #666666">||</span> address <span style="color: #666666">&gt;</span> <span style="color: #666666">31)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> CompileException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Operand must be between &lt;0, 31&gt;; it was &quot;</span> <span style="color: #666666">+</span> address<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>

        <span style="color: #408080; font-style: italic">// Instruction has 32 bits, i.e. 4 bytes</span>
        <span style="color: #B00040">int</span> addressSSEM <span style="color: #666666">=</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">reverseBits</span><span style="color: #666666">(</span>address<span style="color: #666666">,</span> <span style="color: #666666">8)</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">0xF8;</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">seek</span><span style="color: #666666">(4</span> <span style="color: #666666">*</span> currentLine<span style="color: #666666">);</span>

        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>addressSSEM<span style="color: #666666">);</span> <span style="color: #408080; font-style: italic">// address + 3 empty bits</span>

        <span style="color: #408080; font-style: italic">// next: 5 empty bits + 3 bit instruction</span>
        <span style="color: #B00040">int</span> opcode <span style="color: #666666">=</span> instruction<span style="color: #666666">.</span><span style="color: #7D9029">getOpcode</span><span style="color: #666666">()</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">7;</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>opcode<span style="color: #666666">);</span>

        <span style="color: #408080; font-style: italic">// 16 empty bits</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[2]);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">visit</span><span style="color: #666666">(</span>Constant constant<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> number <span style="color: #666666">=</span> constant<span style="color: #666666">.</span><span style="color: #7D9029">getNumber</span><span style="color: #666666">();</span>

        writer<span style="color: #666666">.</span><span style="color: #7D9029">seek</span><span style="color: #666666">(4</span> <span style="color: #666666">*</span> currentLine<span style="color: #666666">);</span>
        writeInt<span style="color: #666666">(</span>number<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">writeInt</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> value<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        Byte<span style="color: #666666">[]</span> word <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Byte<span style="color: #666666">[4];</span>
        NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">writeInt</span><span style="color: #666666">(</span>value<span style="color: #666666">,</span> word<span style="color: #666666">,</span> Strategy<span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">);</span>

        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>word<span style="color: #666666">[0]);</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>word<span style="color: #666666">[1]);</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>word<span style="color: #666666">[2]);</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>word<span style="color: #666666">[3]);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">close</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        writer<span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are several things to notice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Output code is written into class <code>SeekableOutputStream</code>. Wi will define this class later.</p>
</li>
<li>
<p><code>CodeGenerator</code> is a visitor, which has separate methods for code generation of <code>Constant</code> and <code>Instruction</code>.</p>
</li>
<li>
<p><code>CodeGenerator</code> can be "closed" - so it handles closing of the writer (our <code>SeekableOutputStream</code>).</p>
</li>
<li>
<p>Generated code is binary</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The code generation is not that complex. There is some complexity caused by a fact, that the binary representations
are reversed, when comparing to our present-time PCs/laptops.</p>
</div>
<div class="paragraph">
<p>The idea of generating code for instruction is to prepare 4 bytes, 32 bits, which are then written into the "writer"
as one <code>Integer</code>, which has also 32 bits. The instruction format is explained in section <a href="#COMPILER_SSEM_ASM">Assembler for SSEM</a>. First 5 bits from
the left represent the "line" - instruction operand. It must be reversed.
Then, bits 13,14,15 represent the instruction opcode. It does not have to be reversed here, since the instructions are
already encoded properly in the <code>Instruction</code> class. Last two bytes are just empty.</p>
</div>
<div class="paragraph">
<p>Code generation for constant is much easier - it&#8217;s just retrieving the value and writing it in the reversed fashion as
<code>Integer</code>.</p>
</div>
<div class="paragraph">
<p>Code generator uses a "seekable" output stream, which allows to seek in the output. It is a separate class, which is
actually an abstract class, extending <code>OutputStream</code>. The reason is easier testing:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/SeekableOutputStream.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.OutputStream</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">SeekableOutputStream</span> <span style="color: #008000; font-weight: bold">extends</span> OutputStream <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">seek</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> position<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException<span style="color: #666666">;</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and here&#8217;s the implementation:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/MemoryAndFileOutput.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.MemoryContext</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.jcip.annotations.NotThreadSafe</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.RandomAccessFile</span><span style="color: #666666">;</span>

<span style="color: #AA22FF">@NotThreadSafe</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryAndFileOutput</span> <span style="color: #008000; font-weight: bold">extends</span> SeekableOutputStream <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> RandomAccessFile file<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memoryContext<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> position <span style="color: #666666">=</span> <span style="color: #666666">0;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">MemoryAndFileOutput</span><span style="color: #666666">(</span>String filename<span style="color: #666666">,</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memoryContext<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">file</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> RandomAccessFile<span style="color: #666666">(</span>filename<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;rw&quot;</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memoryContext</span> <span style="color: #666666">=</span> memoryContext<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">write</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> b<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>memoryContext <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            memoryContext<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>position<span style="color: #666666">,</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)</span> <span style="color: #666666">(</span>b <span style="color: #666666">&amp;</span> <span style="color: #666666">0xFF));</span>
        <span style="color: #666666">}</span>
        file<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>b<span style="color: #666666">);</span>
        position<span style="color: #666666">++;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">seek</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> position<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">position</span> <span style="color: #666666">=</span> position<span style="color: #666666">;</span>
        file<span style="color: #666666">.</span><span style="color: #7D9029">seek</span><span style="color: #666666">(</span>position<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">close</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
            file<span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">finally</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The "seeking" capability is required, because, as you remember, it&#8217;s possible to write something like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>06 STO 05
05 LDN 06
07 STP</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s not quite common, but it&#8217;s possible.</p>
</div>
<div class="sect3">
<h4 id="testing-2">2.10.1. Testing</h4>
<div class="paragraph">
<p>As being our practice, we must test it.</p>
</div>
<div class="listingblock">
<div class="title"><code>src/test/java/net/sf/emustudio/ssem/assembler/CodeGeneratorTest.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler.tree.Instruction</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.After</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.Before</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.Test</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertArrayEquals</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CodeGeneratorTest</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> SeekableByteArrayOutputStream out<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> CodeGenerator codeGenerator<span style="color: #666666">;</span>

    <span style="color: #AA22FF">@Before</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setUp</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        out <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> SeekableByteArrayOutputStream<span style="color: #666666">(32);</span>
        codeGenerator <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> CodeGenerator<span style="color: #666666">(</span>out<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@After</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">tearDown</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testCMP</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">cmp</span><span style="color: #666666">());</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{0,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">CMP</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testSTP</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">stp</span><span style="color: #666666">());</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{0,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">STP</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testJMP</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">jmp</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)6));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{0x60,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">JMP</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testJRP</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">jrp</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)23));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{(</span><span style="color: #B00040">byte</span><span style="color: #666666">)0xE8,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">JRP</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testLDN</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">ldn</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)12));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{(</span><span style="color: #B00040">byte</span><span style="color: #666666">)0x30,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">LDN</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testSTO</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">sto</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)30));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{(</span><span style="color: #B00040">byte</span><span style="color: #666666">)0x78,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">STO</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testSUB</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        codeGenerator<span style="color: #666666">.</span><span style="color: #7D9029">visit</span><span style="color: #666666">(</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">sub</span><span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)18));</span>

        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #666666">{(</span><span style="color: #B00040">byte</span><span style="color: #666666">)0x48,</span>Instruction<span style="color: #666666">.</span><span style="color: #7D9029">SUB</span><span style="color: #666666">,0,0},</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">SeekableByteArrayOutputStream</span> <span style="color: #008000; font-weight: bold">extends</span> SeekableOutputStream <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> array<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> pos<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> length<span style="color: #666666">;</span>

        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">SeekableByteArrayOutputStream</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> count<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">array</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[</span>count<span style="color: #666666">];</span>
        <span style="color: #666666">}</span>

        <span style="color: #AA22FF">@Override</span>
        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">seek</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> position<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
            length <span style="color: #666666">=</span> Math<span style="color: #666666">.</span><span style="color: #7D9029">max</span><span style="color: #666666">(</span>position<span style="color: #666666">,</span> pos<span style="color: #666666">);</span>
            pos <span style="color: #666666">=</span> position<span style="color: #666666">;</span>
        <span style="color: #666666">}</span>

        <span style="color: #AA22FF">@Override</span>
        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">write</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> b<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> IOException <span style="color: #666666">{</span>
            array<span style="color: #666666">[</span>pos<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)</span>b<span style="color: #666666">;</span>
            pos<span style="color: #666666">++;</span>
            length <span style="color: #666666">=</span> Math<span style="color: #666666">.</span><span style="color: #7D9029">max</span><span style="color: #666666">(</span>pos<span style="color: #666666">,</span> length<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>

        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #0000FF">toArray</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> tmp <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[</span>length<span style="color: #666666">];</span>
            System<span style="color: #666666">.</span><span style="color: #7D9029">arraycopy</span><span style="color: #666666">(</span>array<span style="color: #666666">,</span> <span style="color: #666666">0,</span> tmp<span style="color: #666666">,</span> <span style="color: #666666">0,</span> length<span style="color: #666666">);</span>
            <span style="color: #008000; font-weight: bold">return</span> tmp<span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="finalizing">2.11. Finalizing</h3>
<div class="paragraph">
<p>We&#8217;re almost done now! What is missing so far is to finish implementation of the main <code>CompilerImpl.compile()</code>  method.
Let&#8217;s begin with it first.</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/CompilerImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CompilerImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCompiler <span style="color: #666666">{</span>

    <span style="color: #666666">...</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">compile</span><span style="color: #666666">(</span>String inputFileName<span style="color: #666666">,</span> String outputFileName<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        notifyCompileStart<span style="color: #666666">();</span>

        <span style="color: #B00040">int</span> errorCode <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">(</span>Reader reader <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> FileReader<span style="color: #666666">(</span>inputFileName<span style="color: #666666">))</span> <span style="color: #666666">{</span>
            MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory <span style="color: #666666">=</span> contextPool<span style="color: #666666">.</span><span style="color: #7D9029">getMemoryContext</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">,</span> MemoryContext<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

            <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">(</span>CodeGenerator codeGenerator <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> CodeGenerator<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> MemoryAndFileOutput<span style="color: #666666">(</span>outputFileName<span style="color: #666666">,</span> memory<span style="color: #666666">)))</span> <span style="color: #666666">{</span>
                LexerImpl lexer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> LexerImpl<span style="color: #666666">(</span>reader<span style="color: #666666">);</span>
                ParserImpl parser <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> ParserImpl<span style="color: #666666">(</span>lexer<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ComplexSymbolFactory<span style="color: #666666">(),</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>

                Program program <span style="color: #666666">=</span> <span style="color: #666666">(</span>Program<span style="color: #666666">)</span> parser<span style="color: #666666">.</span><span style="color: #7D9029">parse</span><span style="color: #666666">().</span><span style="color: #7D9029">value</span><span style="color: #666666">;</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>program <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> Exception<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Unexpected end of file&quot;</span><span style="color: #666666">);</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>parser<span style="color: #666666">.</span><span style="color: #7D9029">hasSyntaxErrors</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
                    <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> Exception<span style="color: #666666">(</span><span style="color: #BA2121">&quot;One or more errors has been found, cannot continue.&quot;</span><span style="color: #666666">);</span>
                <span style="color: #666666">}</span>

                program<span style="color: #666666">.</span><span style="color: #7D9029">accept</span><span style="color: #666666">(</span>codeGenerator<span style="color: #666666">);</span>
                programStart <span style="color: #666666">=</span> program<span style="color: #666666">.</span><span style="color: #7D9029">getStartLine</span><span style="color: #666666">()</span> <span style="color: #666666">*</span> <span style="color: #666666">4;</span>
                notifyInfo<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Compile was successful. Output: &quot;</span> <span style="color: #666666">+</span> outputFileName<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>Exception e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            errorCode <span style="color: #666666">=</span> <span style="color: #666666">1;</span>
            LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">error</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Compilation error.&quot;</span><span style="color: #666666">,</span> e<span style="color: #666666">);</span>
            notifyError<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Compilation error.&quot;</span><span style="color: #666666">);</span>

            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">finally</span> <span style="color: #666666">{</span>
            notifyCompileFinish<span style="color: #666666">(</span>errorCode<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>

        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As input, we have full path to the input file, and to the output file. It is good to use Java
<a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html">try-with-resources</a>
statement for opening the files. The same approach can be used for the code generator, because the class implements
<code>AutoCloseable</code> interface.</p>
</div>
<div class="paragraph">
<p>We want to notify emuStudio about compilation progress, as we have already done in the parser, when dealing with
parsing errors. For this purpose, <code>emulib.plugins.compiler.AbstractCompiler</code> class offers several methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>notifyCompileStart()</code>, which will inform emuStudio that the compilation has started,</p>
</li>
<li>
<p><code>notifyCompileFinish(errorCode)</code> will inform emuStudio that the compilation has finished, with given error code. <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup></p>
</li>
<li>
<p><code>notifyOnMessage()</code> - notifies emuStudio about some general message, it can be either error, info, warning.</p>
</li>
<li>
<p><code>notifyWarning()</code> - compiler warning</p>
</li>
<li>
<p><code>notifyError()</code> - compilation error</p>
</li>
<li>
<p><code>notifyInfo()</code> - informational message</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="command-line-interface-cli">2.12. Command-line interface (CLI)</h3>
<div class="paragraph">
<p>It might be sometimes useful to being able to run the compiler from the command line. We can add the implementation
in the <code>Main</code> class, as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/assembler/Main.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.assembler</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.Compiler</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.compiler.Message</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.ContextPool</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Main</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">main</span><span style="color: #666666">(</span>String<span style="color: #666666">...</span> args<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        String inputFile<span style="color: #666666">;</span>
        String outputFile <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>

        <span style="color: #B00040">int</span> i<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span>i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> args<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">;</span> i<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
            String arg <span style="color: #666666">=</span> args<span style="color: #666666">[</span>i<span style="color: #666666">].</span><span style="color: #7D9029">toLowerCase</span><span style="color: #666666">();</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">((</span>arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;--output&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">||</span> arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;-o&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">((</span>i <span style="color: #666666">+</span> <span style="color: #666666">1)</span> <span style="color: #666666">&lt;</span> args<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
                outputFile <span style="color: #666666">=</span> args<span style="color: #666666">[++</span>i<span style="color: #666666">];</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;--help&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">||</span> arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;-h&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
                printHelp<span style="color: #666666">();</span>
                <span style="color: #008000; font-weight: bold">return</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;--version&quot;</span><span style="color: #666666">)</span> <span style="color: #666666">||</span> arg<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;-v&quot;</span><span style="color: #666666">))</span> <span style="color: #666666">{</span>
                System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> CompilerImpl<span style="color: #666666">(0</span>L<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ContextPool<span style="color: #666666">()).</span><span style="color: #7D9029">getVersion</span><span style="color: #666666">());</span>
                <span style="color: #008000; font-weight: bold">return</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>i <span style="color: #666666">&gt;=</span> args<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            System<span style="color: #666666">.</span><span style="color: #7D9029">err</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Error: expected input file name&quot;</span><span style="color: #666666">);</span>
            <span style="color: #008000; font-weight: bold">return</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
        inputFile <span style="color: #666666">=</span> args<span style="color: #666666">[</span>i<span style="color: #666666">];</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>outputFile <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #B00040">int</span> index <span style="color: #666666">=</span> inputFile<span style="color: #666666">.</span><span style="color: #7D9029">lastIndexOf</span><span style="color: #666666">(</span><span style="color: #BA2121">&#39;.&#39;</span><span style="color: #666666">);</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>index <span style="color: #666666">!=</span> <span style="color: #666666">-1)</span> <span style="color: #666666">{</span>
                outputFile <span style="color: #666666">=</span> inputFile<span style="color: #666666">.</span><span style="color: #7D9029">substring</span><span style="color: #666666">(0,</span> index<span style="color: #666666">);</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
                outputFile <span style="color: #666666">=</span> inputFile<span style="color: #666666">;</span>
            <span style="color: #666666">}</span>
            outputFile <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;.bin&quot;</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>

        CompilerImpl compiler <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> CompilerImpl<span style="color: #666666">(0</span>L<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> ContextPool<span style="color: #666666">());</span>
        compiler<span style="color: #666666">.</span><span style="color: #7D9029">addCompilerListener</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Compiler<span style="color: #666666">.</span><span style="color: #7D9029">CompilerListener</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onStart</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onMessage</span><span style="color: #666666">(</span>Message message<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                System<span style="color: #666666">.</span><span style="color: #7D9029">err</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span>message<span style="color: #666666">.</span><span style="color: #7D9029">toString</span><span style="color: #666666">());</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onFinish</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> errorCode<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                System<span style="color: #666666">.</span><span style="color: #7D9029">err</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Compilation finished (error code: &quot;</span> <span style="color: #666666">+</span> errorCode <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;)&quot;</span><span style="color: #666666">);</span>

            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
            compiler<span style="color: #666666">.</span><span style="color: #7D9029">compile</span><span style="color: #666666">(</span>inputFile<span style="color: #666666">,</span> outputFile<span style="color: #666666">);</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>Exception e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            System<span style="color: #666666">.</span><span style="color: #7D9029">err</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span>e<span style="color: #666666">.</span><span style="color: #7D9029">getMessage</span><span style="color: #666666">());</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">printHelp</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Syntax: java -jar as-ssem.jar [-o outputFile] inputFile\nOptions:&quot;</span><span style="color: #666666">);</span>
        System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;\t--output, -o\tfile: name of the output file&quot;</span><span style="color: #666666">);</span>
        System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;\t--version, -v\t: print version&quot;</span><span style="color: #666666">);</span>
        System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;\t--help, -h\t: this help&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that was the very last thing, now you have SSEM compiler ready :)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MEMORY_HOWTO">3. Writing a memory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial will describe some basic knowledge about how to create an operating memory to be used in emuStudio.
In emuStudio, virtual computers usually conform to von-Neumann architecture. In this architecture, the memory is a
separate component. The tutorial focuses on how to use emuLib API in a memory for SSEM computer.</p>
</div>
<div class="sect2">
<h3 id="MEMORY_GETTING_STARTED">3.1. Getting started</h3>
<div class="paragraph">
<p>Before reading on, please read the <a href="#INTRODUCTION_PLUGINS">Introduction</a> chapter. It gives the information
needed for setting up the development environment and for basic understanding how the emuStudio/plug-ins lifecycle
work.</p>
</div>
<div class="paragraph">
<p>Within this tutorial, we will implement a main store of SSEM "Baby" machine, to conform with other tutorials for other
plug-ins. Before we start, here&#8217;s a few words about what purpose and capabilities memories in emuStudio can have.</p>
</div>
<div class="paragraph">
<p>In first stored-program computers, operating memory was accessible only by CPU. It means that all
data between the memory and other devices had to be transferred through CPU. When data from memory was required,
CPU "paused" the execution of instructions and accessed the memory in the meantime. This slowed down CPU and consequently
the whole program. Later, DMA (direct memory access) capability was introduced, which allowed devices
to directly access the memory, or be notified when the memory changes.</p>
</div>
<div class="paragraph">
<p>In emuStudio, you can connect the memory with devices, or even with a compiler. This is one example of the versatility
and power of emuStudio.</p>
</div>
<div class="paragraph">
<p>There are three main behavioral contracts which need to be taken into account, when creating memory plug-in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Memory can be connected with none, one or more plug-ins of any type</p>
</li>
<li>
<p>Memory plug-in is necessary for creating a virtual machine (emuStudio requires it)</p>
</li>
<li>
<p>Operations of memory can be extended using special class called "context"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The implication is that the memory can be shared across CPU and devices, and the communication can be optimized with
custom operations. The context class is a customization which extends default context behavior. This tutorial will
cover some basics in this topic.</p>
</div>
<div class="sect3">
<h4 id="ssem-memory">3.1.1. SSEM memory</h4>
<div class="paragraph">
<p>SSEM used the world&#8217;s first random-access memory called Williams or Williams-Kilburn tube
<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</sup>. The
used principle was the same as in standard Cathode-Ray-Tubes (CRTs). Original EDSAC computer (which introduced the
von Neumann architecture) did not have random-access memory.</p>
</div>
<div class="paragraph">
<p>The memory had 32 memory cells (called words), each had size of 32 bits. The memory could contain instructions and
data. So, one SSEM instruction perfectly fits in the single memory word.</p>
</div>
<div class="paragraph">
<p>Within this tutorial, we will hardcode the word size and memory size. But we&#8217;ll also implement a GUI for the memory,
which is often far more complicated than the emulated memory itself <sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</sup></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preparing-the-environment-2">3.2. Preparing the environment</h3>
<div class="paragraph">
<p>In order to start developing the memory, create new Java project. Here, Maven will be used for dependencies management.
The plug-in will be implemented as another standard emuStudio plug-in, so it will inherit Maven plug-in dependencies
from the main POM file.</p>
</div>
<div class="paragraph">
<p>The project should be located at <code>emuStudio/plugins/mem/ssem-mem</code>, and should contain the following structure:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>src/
  main/
    java/
    resources/
test/
  java/
pom.xml</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note the naming of the plug-in. It follows the naming convention as described in the <a href="#INTRODUCTION_NAMING">Naming conventions</a>
      guide.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The POM file of the project might look as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>ssem-mem/pom.xml</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span style="color: #008000; font-weight: bold">&lt;project</span> <span style="color: #7D9029">xmlns=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span style="color: #7D9029">xmlns:xsi=</span><span style="color: #BA2121">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span style="color: #7D9029">xsi:schemaLocation=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;modelVersion&gt;</span>4.0.0<span style="color: #008000; font-weight: bold">&lt;/modelVersion&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;parent&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emustudio-parent<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;version&gt;</span>0.39<span style="color: #008000; font-weight: bold">&lt;/version&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;relativePath&gt;</span>../../..<span style="color: #008000; font-weight: bold">&lt;/relativePath&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/parent&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>ssem-mem<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;packaging&gt;</span>jar<span style="color: #008000; font-weight: bold">&lt;/packaging&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;name&gt;</span>SSEM Memory<span style="color: #008000; font-weight: bold">&lt;/name&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;description&gt;</span>Operating memory (main store) for the SSEM computer<span style="color: #008000; font-weight: bold">&lt;/description&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;build&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;finalName&gt;</span>ssem-mem<span style="color: #008000; font-weight: bold">&lt;/finalName&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;plugins&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-jar-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;archive&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;manifest&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addClasspath&gt;</span>false<span style="color: #008000; font-weight: bold">&lt;/addClasspath&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultImplementationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultImplementationEntries&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultSpecificationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultSpecificationEntries&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/manifest&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/archive&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-dependency-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/plugins&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/build&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;dependencies&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emuLib<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.slf4j<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>slf4j-api<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.easymock<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>easymock<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/dependencies&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s start with the first Java class, the main plug-in class. Let&#8217;s put it to package
<code>net.sf.emustudio.ssem.memory</code>, and call it <code>MemoryImpl</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="MEMORY_BASIC_STUFF">3.3. The main class</h3>
<div class="paragraph">
<p>Go to the <code>MemoryImpl</code> class source. Extend the class from <code>emulib.plugins.memory.AbstractMemory</code> class.
The class extends from <code>Memory</code> interface and implements the most common methods, usable by all memories.</p>
</div>
<div class="paragraph">
<p>It is also necessary to annotate the class with <code>emulib.annotations.PluginType</code> annotation, which is required for every
main class of any emuStudio plug-in. The code snippet looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/memory/MemoryImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PLUGIN_TYPE</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PluginType</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.AbstractMemory</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.ContextPool</span><span style="color: #666666">;</span>

<span style="color: #AA22FF">@PluginType</span><span style="color: #666666">(</span>
        type <span style="color: #666666">=</span> PLUGIN_TYPE<span style="color: #666666">.</span><span style="color: #7D9029">MEMORY</span><span style="color: #666666">,</span>
        title <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;SSEM memory&quot;</span><span style="color: #666666">,</span>
        copyright <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;\u00A9 Copyright 2016, Peter Jakubo&quot;</span><span style="color: #666666">,</span>
        description <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Main store for SSEM machine&quot;</span>
<span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractMemory <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> Logger LOGGER <span style="color: #666666">=</span> LoggerFactory<span style="color: #666666">.</span><span style="color: #7D9029">getLogger</span><span style="color: #666666">(</span>MemoryImpl<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">MemoryImpl</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #408080; font-style: italic">// ... other methods ...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The constructor presented here is mandatory. This is one of the behavioral contracts, emuStudio expects
      that a plug-in will have a constructor with two arguments: <code>pluginID</code> (assigned by emuStudio), and a context
      pool, which is a storage or registrar of all plug-ins contexts.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="few-notes-on-ssem-memory">3.4. Few notes on SSEM memory</h3>
<div class="paragraph">
<p>When thinking about computer memory - what is it? During time, memory abstraction has evolved to an idea of memory
as a collection of cells, equally-sized, which are ordered sequentially. This is the simplest description, and I
would say that more-less all memories look like this. When emulating a computer memory in a programming language like
Java, it would be then just a plain array.</p>
</div>
<div class="paragraph">
<p>SSEM had 32 so-called "lines", which represented cells in memory. Each line, or a cell, was 4 bytes long. It is therefore
tempting to implement SSEM memory as array of integers, because <code>int</code> type has 4 bytes.</p>
</div>
<div class="paragraph">
<p>It is indeed possible, but we will face to an unsolvable problem when implementing CPU, if we want to use Edigen
<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnote_5" title="View footnote.">5</a>]</sup>.
Unfortunately, Edigen is so-far designed in a way that it expects the memory having cell size of a byte, not more.
Therefore, we will keep that also for SSEM memory emulation, but visually try to present it as having 4-byte cells. It
would require additional mathematics when working with memory (in the CPU tutorial you would find it as well), but
not having impact on performance.</p>
</div>
</div>
<div class="sect2">
<h3 id="memory-context">3.5. Memory context</h3>
<div class="paragraph">
<p>Abstracts are helping us to understand ideas and see how they can be composed into a whole. In this fashion, memory
main interface, presented in section <a href="#MEMORY_BASIC_STUFF">The main class</a>, is the communication point with emuStudio. The main module is
using methods in this interface. The communication with CPU and devices is done through another concept, which is called
a context. The contexts differ for various plug-ins; and they can be customized.</p>
</div>
<div class="paragraph">
<p>Plug-ins which provide a context, must register it to the <code>ContextPool</code>, given in a constructor in the main plugin class.
This registration should be performed as early as possible - in the constructor itself. After all plug-ins are
instantiated, emuStudio expects that all contexts are already registered.</p>
</div>
<div class="paragraph">
<p>The next step, generally true for all plug-ins, is calling of <code>Plugin.initialize()</code> method, in this case -
<code>Memory.initialize()</code>. The initialization can now use the context pool for different purpose - for obtaining contexts,
if it requires some. More on this topic can be found in the <a href="#INTRODUCTION_BEHAVIORAL">Emulation lifecycle</a> section.</p>
</div>
<div class="paragraph">
<p>So, in our case - we must create a memory context, which will be used by SSEM CPU and SSEM CRT display. We don&#8217;t need
special customized context, so we can comfortably extend from class <code>AbstractMemoryContext</code>, which will implement some
methods of the <code>MemoryContext</code> interface for us. We will call the class <code>MemoryContextImpl</code>:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/memory/impl/MemoryContextImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.impl</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.AbstractMemoryContext</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.jcip.annotations.ThreadSafe</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Arrays</span><span style="color: #666666">;</span>

<span style="color: #AA22FF">@ThreadSafe</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryContextImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractMemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">int</span> NUMBER_OF_CELLS <span style="color: #666666">=</span> <span style="color: #666666">32</span> <span style="color: #666666">*</span> <span style="color: #666666">4;</span>

    <span style="color: #408080; font-style: italic">// byte type is atomic in JVM memory model</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span>memory <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[</span>NUMBER_OF_CELLS<span style="color: #666666">];</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">clear</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        Arrays<span style="color: #666666">.</span><span style="color: #7D9029">fill</span><span style="color: #666666">(</span>memory<span style="color: #666666">,</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)0);</span>
        notifyMemoryChanged<span style="color: #666666">(-1);</span> <span style="color: #408080; font-style: italic">// notify that all memory has changed</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Class<span style="color: #666666">&lt;?&gt;</span> getDataType<span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> Byte<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Byte <span style="color: #0000FF">read</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> from<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> memory<span style="color: #666666">[</span>from<span style="color: #666666">];</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Byte<span style="color: #666666">[]</span> <span style="color: #0000FF">readWord</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> from<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> Byte<span style="color: #666666">[]</span> <span style="color: #666666">{</span> memory<span style="color: #666666">[</span>from<span style="color: #666666">],</span> memory<span style="color: #666666">[</span>from<span style="color: #666666">+1],</span> memory<span style="color: #666666">[</span>from<span style="color: #666666">+2],</span> memory<span style="color: #666666">[</span>from<span style="color: #666666">+3]</span> <span style="color: #666666">};</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">write</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> to<span style="color: #666666">,</span> Byte val<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        memory<span style="color: #666666">[</span>to<span style="color: #666666">]</span> <span style="color: #666666">=</span> val<span style="color: #666666">;</span>
        notifyMemoryChanged<span style="color: #666666">(</span>to<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">writeWord</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> to<span style="color: #666666">,</span> Byte<span style="color: #666666">[]</span> cells<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span> cell <span style="color: #666666">:</span> cells<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            memory<span style="color: #666666">[</span>to <span style="color: #666666">+</span> i<span style="color: #666666">]</span> <span style="color: #666666">=</span> cell<span style="color: #666666">;</span>
            notifyMemoryChanged<span style="color: #666666">(</span>to<span style="color: #666666">+</span>i<span style="color: #666666">);</span>
            i<span style="color: #666666">++;</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getSize</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, SSEM memory is indeed an array of bytes. This is the "core" idea of a memory. Ofcourse, it is possible
to use a <code>java.util.List</code> or another collection, but we should keep eye on performance. Array is the simplest structure
with access time O(1). Therefore, we chose array.</p>
</div>
<div class="paragraph">
<p>Also notice that the class <code>AbstractMemoryContext</code>, and also interface <code>MemoryContext</code> take a generic parameter
<code>T extends Number</code>. This parameter is saying of what type cell is. In our case, <code>T</code> is a <code>Byte</code>. Due unhappy Java
limitation, primitive types cannot be used in generics, so we can&#8217;t have something like <code>MemoryContext&lt;byte&gt;</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="gui">3.6. GUI</h3>
<div class="paragraph">
<p>Since emuStudio is interactive application, GUIs are a natural thing. Each memory plug-in should have its own GUI.
The supported features can be any, but keep in mind, that GUI control in Swing is done in separate thread, often
called "UI Thread". On the other hand, emulation itself is running in different, dedicated, thread, created in emuLib.</p>
</div>
<div class="paragraph">
<p>This means that the access to memory context should be synchronized. However, synchronization is very slow.
Much better approach is to use a non-blocking algorithm for locking, if we really require absolutely reliable
manipulation of memory cells in between threads. However, non-blocking algorithms are harder to implement good.
In our tutorial we will do a trade-off, which we can afford - since we have final array of bytes, we have the following
guarantees:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the array itself will be always valid and visible to all accessing threads. Meaning - reading is always safe.</p>
</li>
<li>
<p>we expect our host CPU can write a byte at once; therefore it is atomic. This does not have to hold for all CPUs - don&#8217;t
worry, all x86 CPUs have it.</p>
</li>
<li>
<p>According to <a href="https://docs.oracle.com/javase/specs/jls/se7/html/jls-17.html#jls-17.6">Java Language Specification, Chapter 17.6</a>:</p>
<div class="literalblock">
<div class="content">
<pre>two threads that update adjacent elements of a byte array separately must not interfere or interact and do not need
synchronization to ensure sequential consistency.</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>I consider these guarantees as good enough to leave the synchronization be. I guess the probability of modifying
the same memory cells from both running emulation and by the user in GUI, is very small. What&#8217;s more, you shouldn&#8217;t
modify memory cells at all when the emulation is running.</p>
</div>
<div class="paragraph">
<p>Now back to our GUI. It would be good if the GUI is looking good, so it&#8217;s up to you how you&#8217;ll draw the main form. It
can be a class extending from a <code>javax.swing.JFrame</code> or <code>javax.swing.JDialog</code>. The look might be as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vbmacher.github.io/emuStudio/docdevel/emulator_tutorial/images//ssem-memory.png" alt="SSEM Memory GUI sample look">
</div>
</div>
<div class="paragraph">
<p>So, we will need a custom memory model, a custom memory table - which will have a row header (the very first, gray-colored
column) and column header (the very first, gray-colored row).</p>
</div>
<div class="paragraph">
<p>As you can see in the picture, a row represents single SSEM memory cell - 32 scattered bits, and the last few columns
show both the number the bits represent, and a raw ASCII value of the 4-byte sequence of data.</p>
</div>
<div class="paragraph">
<p>Also, we would like to let user edit the cells manually - just by pointing to a bit, and pressing either 1 or 0 - possibly
a DELETE key, committing the change immediately. We want to allow editing also for the value itself, and for the data column
as well.</p>
</div>
<div class="paragraph">
<p>In addition, movement around cells should be possible with arrow keys.</p>
</div>
<div class="paragraph">
<p>For those "specifications", we will need to customize standard <code>javax.swing.JTable</code>, create custom memory model, cell
editor, cell renderer and introduce row header renderer.</p>
</div>
<div class="paragraph">
<p>The source code of the main GUI class is here:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/memory/gui/MemoryGUI.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.Memory</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.MemoryContext</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JDialog</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryGUI</span> <span style="color: #008000; font-weight: bold">extends</span> JDialog <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryTableModel tableModel<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryListenerImpl</span> <span style="color: #008000; font-weight: bold">implements</span> Memory<span style="color: #666666">.</span><span style="color: #7D9029">MemoryListener</span> <span style="color: #666666">{</span>

        <span style="color: #AA22FF">@Override</span>
        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">memoryChanged</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> memoryPosition<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            tableModel<span style="color: #666666">.</span><span style="color: #7D9029">dataChangedAt</span><span style="color: #666666">(</span>memoryPosition<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>

        <span style="color: #AA22FF">@Override</span>
        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">memorySizeChanged</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            tableModel<span style="color: #666666">.</span><span style="color: #7D9029">fireTableDataChanged</span><span style="color: #666666">();</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">MemoryGUI</span><span style="color: #666666">(</span>MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        initComponents<span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setLocationRelativeTo</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">);</span>

        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">tableModel</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryTableModel<span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
        MemoryTable memoryTable <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryTable<span style="color: #666666">(</span>tableModel<span style="color: #666666">,</span> scrollPane<span style="color: #666666">);</span>
        memoryTable<span style="color: #666666">.</span><span style="color: #7D9029">setup</span><span style="color: #666666">();</span>
        scrollPane<span style="color: #666666">.</span><span style="color: #7D9029">setViewportView</span><span style="color: #666666">(</span>memoryTable<span style="color: #666666">);</span>

        memory<span style="color: #666666">.</span><span style="color: #7D9029">addMemoryListener</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> MemoryListenerImpl<span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic">     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The</span>
<span style="color: #408080; font-style: italic">     * content of this method is always regenerated by the Form Editor.</span>
<span style="color: #408080; font-style: italic">     */</span>
    <span style="color: #AA22FF">@SuppressWarnings</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;unchecked&quot;</span><span style="color: #666666">)</span>
    <span style="color: #408080; font-style: italic">// &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;Generated Code&quot;&gt;//GEN-BEGIN:initComponents</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initComponents</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

        scrollPane <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JScrollPane</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JToolBar</span> jToolBar1 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JToolBar</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JButton</span> btnClear <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JButton</span><span style="color: #666666">();</span>

        setDefaultCloseOperation<span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">WindowConstants</span><span style="color: #666666">.</span><span style="color: #7D9029">DISPOSE_ON_CLOSE</span><span style="color: #666666">);</span>
        setTitle<span style="color: #666666">(</span><span style="color: #BA2121">&quot;SSEM Memory (Williams-Killburn Tube)&quot;</span><span style="color: #666666">);</span>

        jToolBar1<span style="color: #666666">.</span><span style="color: #7D9029">setFloatable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        jToolBar1<span style="color: #666666">.</span><span style="color: #7D9029">setRollover</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">);</span>

        btnClear<span style="color: #666666">.</span><span style="color: #7D9029">setIcon</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">ImageIcon</span><span style="color: #666666">(</span>getClass<span style="color: #666666">().</span><span style="color: #7D9029">getResource</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;/net/sf/emustudio/ssem/memory/gui/clear.png&quot;</span><span style="color: #666666">)));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        btnClear<span style="color: #666666">.</span><span style="color: #7D9029">setFocusable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        btnClear<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalTextPosition</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">SwingConstants</span><span style="color: #666666">.</span><span style="color: #7D9029">CENTER</span><span style="color: #666666">);</span>
        btnClear<span style="color: #666666">.</span><span style="color: #7D9029">setVerticalTextPosition</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">SwingConstants</span><span style="color: #666666">.</span><span style="color: #7D9029">BOTTOM</span><span style="color: #666666">);</span>
        btnClear<span style="color: #666666">.</span><span style="color: #7D9029">addActionListener</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">event</span><span style="color: #666666">.</span><span style="color: #7D9029">ActionListener</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">actionPerformed</span><span style="color: #666666">(</span>java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">event</span><span style="color: #666666">.</span><span style="color: #7D9029">ActionEvent</span> evt<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                btnClearActionPerformed<span style="color: #666666">(</span>evt<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>
        jToolBar1<span style="color: #666666">.</span><span style="color: #7D9029">add</span><span style="color: #666666">(</span>btnClear<span style="color: #666666">);</span>

        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span> layout <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">(</span>getContentPane<span style="color: #666666">());</span>
        getContentPane<span style="color: #666666">().</span><span style="color: #7D9029">setLayout</span><span style="color: #666666">(</span>layout<span style="color: #666666">);</span>
        layout<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalGroup</span><span style="color: #666666">(</span>
            layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>scrollPane<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">965,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jToolBar1<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">)</span>
        <span style="color: #666666">);</span>
        layout<span style="color: #666666">.</span><span style="color: #7D9029">setVerticalGroup</span><span style="color: #666666">(</span>
            layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">TRAILING</span><span style="color: #666666">,</span> layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jToolBar1<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">32,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>scrollPane<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">455,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">))</span>
        <span style="color: #666666">);</span>

        pack<span style="color: #666666">();</span>
    <span style="color: #666666">}</span><span style="color: #408080; font-style: italic">// &lt;/editor-fold&gt;//GEN-END:initComponents</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">btnClearActionPerformed</span><span style="color: #666666">(</span>java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">event</span><span style="color: #666666">.</span><span style="color: #7D9029">ActionEvent</span> evt<span style="color: #666666">)</span> <span style="color: #666666">{</span><span style="color: #408080; font-style: italic">//GEN-FIRST:event_btnClearActionPerformed</span>
        tableModel<span style="color: #666666">.</span><span style="color: #7D9029">clear</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span><span style="color: #408080; font-style: italic">//GEN-LAST:event_btnClearActionPerformed</span>

    <span style="color: #408080; font-style: italic">// Variables declaration - do not modify//GEN-BEGIN:variables</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JScrollPane</span> scrollPane<span style="color: #666666">;</span>
    <span style="color: #408080; font-style: italic">// End of variables declaration//GEN-END:variables</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in the constructor we create a memory listener, which implements <code>Memory.MemoryListener</code> interface. The
listener will receive events about external memory changes - in our case, from CPU emulator. Our reaction is - as
supposed to be - reflect the change in the memory GUI.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The caller thread of listener methods is the one who calls <code>Memory.write()</code> on the other end. In our case, it
      can be either the emulator dedicated thread, as described above, or the user itself, doing changes in the UI
      thread.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also, we use custom memory table, which extends from <code>javax.swing.table.JTable</code>. We will describe it now.</p>
</div>
<div class="sect3">
<h4 id="memory-table">3.6.1. Memory table</h4>
<div class="paragraph">
<p>Since we want "special" behavior, like custom cell renderer, custom row header, custom cell editor and custom widths
of some columns, it will be good to wrap it up in a custom <code>JTable</code>. The code looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/memory/gui/MemoryTable.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.event.ActionEvent</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.event.KeyEvent</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.AbstractAction</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.ActionMap</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.InputMap</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JScrollPane</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JTable</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.KeyStroke</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.ListSelectionModel</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.table.TableColumn</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.CHAR_HEIGHT</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.COLUMN_WIDTH</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.DEFAULT_FONT</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryTable</span> <span style="color: #008000; font-weight: bold">extends</span> JTable <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryTableModel model<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> CellRenderer cellRenderer<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> JScrollPane scrollPane<span style="color: #666666">;</span>

    MemoryTable<span style="color: #666666">(</span>MemoryTableModel model<span style="color: #666666">,</span> JScrollPane scrollPane<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">scrollPane</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>scrollPane<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">model</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>model<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">cellRenderer</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> CellRenderer<span style="color: #666666">(</span>model<span style="color: #666666">);</span>

        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setModel</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">model</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span>DEFAULT_FONT<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setCellSelectionEnabled</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setFocusCycleRoot</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setSelectionMode</span><span style="color: #666666">(</span>ListSelectionModel<span style="color: #666666">.</span><span style="color: #7D9029">SINGLE_SELECTION</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">getTableHeader</span><span style="color: #666666">().</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span>DEFAULT_FONT<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setup</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        cellRenderer<span style="color: #666666">.</span><span style="color: #7D9029">setup</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
        setDefaultRenderer<span style="color: #666666">(</span>Object<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">,</span> cellRenderer<span style="color: #666666">);</span>
        scrollPane<span style="color: #666666">.</span><span style="color: #7D9029">setRowHeaderView</span><span style="color: #666666">(</span>cellRenderer<span style="color: #666666">.</span><span style="color: #7D9029">getRowHeader</span><span style="color: #666666">());</span>

        CellEditor editor <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> CellEditor<span style="color: #666666">();</span>
        editor<span style="color: #666666">.</span><span style="color: #7D9029">setup</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>

        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> columnModel<span style="color: #666666">.</span><span style="color: #7D9029">getColumnCount</span><span style="color: #666666">();</span> i<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
            TableColumn col <span style="color: #666666">=</span> columnModel<span style="color: #666666">.</span><span style="color: #7D9029">getColumn</span><span style="color: #666666">(</span>i<span style="color: #666666">);</span>
            col<span style="color: #666666">.</span><span style="color: #7D9029">setPreferredWidth</span><span style="color: #666666">(</span>COLUMN_WIDTH<span style="color: #666666">[</span>i<span style="color: #666666">]);</span>
            col<span style="color: #666666">.</span><span style="color: #7D9029">setCellEditor</span><span style="color: #666666">(</span>editor<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        setRowHeight<span style="color: #666666">(</span>getRowHeight<span style="color: #666666">()</span> <span style="color: #666666">+</span> CHAR_HEIGHT<span style="color: #666666">);</span>

        InputMap im <span style="color: #666666">=</span> getInputMap<span style="color: #666666">(</span>JTable<span style="color: #666666">.</span><span style="color: #7D9029">WHEN_FOCUSED</span><span style="color: #666666">);</span>
        ActionMap am <span style="color: #666666">=</span> getActionMap<span style="color: #666666">();</span>
        im<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>KeyStroke<span style="color: #666666">.</span><span style="color: #7D9029">getKeyStroke</span><span style="color: #666666">(</span>KeyEvent<span style="color: #666666">.</span><span style="color: #7D9029">VK_DELETE</span><span style="color: #666666">,</span> <span style="color: #666666">0),</span> <span style="color: #BA2121">&quot;delete&quot;</span><span style="color: #666666">);</span>
        am<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;delete&quot;</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> AbstractAction<span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">actionPerformed</span><span style="color: #666666">(</span>ActionEvent listener<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #B00040">int</span> row <span style="color: #666666">=</span> getSelectedRow<span style="color: #666666">();</span>
                <span style="color: #B00040">int</span> col <span style="color: #666666">=</span> getSelectedColumn<span style="color: #666666">();</span>

                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>row <span style="color: #666666">!=</span> <span style="color: #666666">-1</span> <span style="color: #666666">&amp;&amp;</span> col <span style="color: #666666">!=</span> <span style="color: #666666">-1)</span> <span style="color: #666666">{</span>
                    model<span style="color: #666666">.</span><span style="color: #7D9029">setValueAt</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">,</span> row<span style="color: #666666">,</span> col<span style="color: #666666">);</span>
                <span style="color: #666666">}</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>

    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, particular sub-components of the table will be implemented and described in more detail.</p>
</div>
</div>
<div class="sect3">
<h4 id="memory-table-model">3.6.2. Memory table model</h4>
<div class="paragraph">
<p>Memory model is the "back-end" of the memory GUI. It means, the model provide data which should be shown in the GUI.
You can think of any Swing component as a combination of a "view" and "model" subcomponents. The "view" subcomponent
"asks" the model about which data should be shown. By default, almost all Swing components use some default models,
accessible directly from the Swing component. Consequently, the components allow to set custom models as well, which
is our case.</p>
</div>
<div class="paragraph">
<p>For a table, the model must implement <code>javax.swing.table.TableModel</code> interface. As it is often a custom, Java implements
some general methods in an abstract class called <code>javax.swing.table.AbstractTableModel</code> we can extend from.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The description of the table model can be found <a href="http://docs.oracle.com/javase/tutorial/uiswing/components/table.html#data">at this link</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The model must provide data for every row and column. So here, we must do some math to compute bits and also transform
the data to hex value, and raw ASCII value. The class is called <code>MemoryTableModel</code> and it&#8217;s source code is here:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/memory/gui/MemoryTableModel.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.MemoryContext</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.NumberUtils</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.NumberUtils.Strategy</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.RadixUtils</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.slf4j.Logger</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.slf4j.LoggerFactory</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.table.AbstractTableModel</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryTableModel</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractTableModel <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> Logger LOGGER <span style="color: #666666">=</span> LoggerFactory<span style="color: #666666">.</span><span style="color: #7D9029">getLogger</span><span style="color: #666666">(</span>MemoryTableModel<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

    <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">int</span> COLUMN_HEX_VALUE <span style="color: #666666">=</span> <span style="color: #666666">32;</span>
    <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">int</span> COLUMN_RAW_VALUE <span style="color: #666666">=</span> <span style="color: #666666">33;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">int</span> ROW_COUNT <span style="color: #666666">=</span> <span style="color: #666666">32;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">int</span> COLUMN_COUNT <span style="color: #666666">=</span> <span style="color: #666666">2</span> <span style="color: #666666">+</span> <span style="color: #666666">32;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">;</span>

    MemoryTableModel<span style="color: #666666">(</span>MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memory</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getRowCount</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> ROW_COUNT<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getColumnCount</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> COLUMN_COUNT<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic">     * Determine if a column index points at a bit which is part of the 3 bits in a memory cell representing a SSEM</span>
<span style="color: #408080; font-style: italic">     * instruction.</span>
<span style="color: #408080; font-style: italic">     *</span>
<span style="color: #408080; font-style: italic">     * @param column column in the memory table</span>
<span style="color: #408080; font-style: italic">     * @return true if the column represents a SSEM instruction bit</span>
<span style="color: #408080; font-style: italic">     */</span>
    <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isBitInstruction</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> column<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> column <span style="color: #666666">&gt;=</span> <span style="color: #666666">13</span> <span style="color: #666666">&amp;&amp;</span> column <span style="color: #666666">&lt;=</span> <span style="color: #666666">15;</span>
    <span style="color: #666666">}</span>

    <span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic">     * Determine if a column index points at a bit which is part of the 5 bits in a memory cell representing a &quot;line&quot;,</span>
<span style="color: #408080; font-style: italic">     * or address part of the memory cell.</span>
<span style="color: #408080; font-style: italic">     *</span>
<span style="color: #408080; font-style: italic">     * @param column column in the memory table</span>
<span style="color: #408080; font-style: italic">     * @return true if the column represents a line bit</span>
<span style="color: #408080; font-style: italic">     */</span>
    <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isBitLine</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> column<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> column <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #666666">&amp;&amp;</span> column <span style="color: #666666">&lt;</span> <span style="color: #666666">5;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getColumnName</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> columnIndex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">switch</span> <span style="color: #666666">(</span>columnIndex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">case</span> COLUMN_HEX_VALUE<span style="color: #666666">:</span>
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;Value (hex)&quot;</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> COLUMN_RAW_VALUE<span style="color: #666666">:</span>
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;Raw&quot;</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>isBitLine<span style="color: #666666">(</span>columnIndex<span style="color: #666666">))</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;L&quot;</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>isBitInstruction<span style="color: #666666">(</span>columnIndex<span style="color: #666666">))</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;I&quot;</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #0000FF">readLineBits</span><span style="color: #666666">(</span>Byte<span style="color: #666666">[]</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> lineBits <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">byte</span><span style="color: #666666">[32];</span>

        <span style="color: #B00040">int</span> j <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span> b <span style="color: #666666">:</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">7;</span> i <span style="color: #666666">&gt;=</span> <span style="color: #666666">0;</span> i<span style="color: #666666">--)</span> <span style="color: #666666">{</span>
                lineBits<span style="color: #666666">[</span>j<span style="color: #666666">++]</span> <span style="color: #666666">=</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)((</span>b <span style="color: #666666">&gt;&gt;&gt;</span> i<span style="color: #666666">)</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">1);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> lineBits<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Object <span style="color: #0000FF">getValueAt</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> rowIndex<span style="color: #666666">,</span> <span style="color: #B00040">int</span> columnIndex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
            Byte<span style="color: #666666">[]</span> row <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>rowIndex <span style="color: #666666">*</span> <span style="color: #666666">4);</span>
            <span style="color: #B00040">int</span> value <span style="color: #666666">=</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">readInt</span><span style="color: #666666">(</span>row<span style="color: #666666">,</span> Strategy<span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">);</span>

            <span style="color: #008000; font-weight: bold">switch</span> <span style="color: #666666">(</span>columnIndex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">case</span> COLUMN_HEX_VALUE<span style="color: #666666">:</span>
                    <span style="color: #008000; font-weight: bold">return</span> RadixUtils<span style="color: #666666">.</span><span style="color: #7D9029">formatDwordHexString</span><span style="color: #666666">(</span>value<span style="color: #666666">).</span><span style="color: #7D9029">toUpperCase</span><span style="color: #666666">();</span>
                <span style="color: #008000; font-weight: bold">case</span> COLUMN_RAW_VALUE<span style="color: #666666">:</span>
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span> <span style="color: #666666">+</span> <span style="color: #666666">(</span><span style="color: #B00040">char</span><span style="color: #666666">)((</span>value <span style="color: #666666">&gt;&gt;&gt;</span> <span style="color: #666666">24)</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">0xFF)</span> <span style="color: #666666">+</span> <span style="color: #666666">(</span><span style="color: #B00040">char</span><span style="color: #666666">)((</span>value <span style="color: #666666">&gt;&gt;&gt;</span> <span style="color: #666666">16)</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">0xFF)</span>
                            <span style="color: #666666">+</span> <span style="color: #666666">(</span><span style="color: #B00040">char</span><span style="color: #666666">)((</span>value <span style="color: #666666">&gt;&gt;&gt;</span> <span style="color: #666666">8)</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">0xFF)</span> <span style="color: #666666">+</span> <span style="color: #666666">(</span><span style="color: #B00040">char</span><span style="color: #666666">)(</span>value <span style="color: #666666">&amp;</span> <span style="color: #666666">0xFF);</span>
                <span style="color: #008000; font-weight: bold">default</span><span style="color: #666666">:</span>
                    <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> lineBits <span style="color: #666666">=</span> readLineBits<span style="color: #666666">(</span>row<span style="color: #666666">);</span>
                    <span style="color: #008000; font-weight: bold">return</span> lineBits<span style="color: #666666">[</span>columnIndex<span style="color: #666666">];</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>Exception e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">debug</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;[line={}] Could not read value from memory&quot;</span><span style="color: #666666">,</span> rowIndex<span style="color: #666666">,</span> e<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setValueAt</span><span style="color: #666666">(</span>Object aValue<span style="color: #666666">,</span> <span style="color: #B00040">int</span> rowIndex<span style="color: #666666">,</span> <span style="color: #B00040">int</span> columnIndex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>isCellEditable<span style="color: #666666">(</span>rowIndex<span style="color: #666666">,</span> columnIndex<span style="color: #666666">))</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
                Byte<span style="color: #666666">[]</span> row <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>rowIndex <span style="color: #666666">*</span> <span style="color: #666666">4);</span>
                String str <span style="color: #666666">=</span> String<span style="color: #666666">.</span><span style="color: #7D9029">valueOf</span><span style="color: #666666">(</span>aValue<span style="color: #666666">);</span>

                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>columnIndex <span style="color: #666666">==</span> COLUMN_HEX_VALUE<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    writeHex<span style="color: #666666">(</span>str<span style="color: #666666">,</span> row<span style="color: #666666">);</span>
                <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>columnIndex <span style="color: #666666">==</span> COLUMN_RAW_VALUE<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    writeChar<span style="color: #666666">((</span>String<span style="color: #666666">)</span>aValue<span style="color: #666666">,</span> row<span style="color: #666666">);</span>
                <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>columnIndex <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #666666">&amp;&amp;</span> columnIndex <span style="color: #666666">&lt;</span> <span style="color: #666666">33)</span> <span style="color: #666666">{</span>
                    writeBit<span style="color: #666666">(</span>str<span style="color: #666666">,</span> columnIndex<span style="color: #666666">,</span> row<span style="color: #666666">);</span>
                <span style="color: #666666">}</span>
                memory<span style="color: #666666">.</span><span style="color: #7D9029">writeWord</span><span style="color: #666666">(</span>rowIndex <span style="color: #666666">*</span> <span style="color: #666666">4,</span> row<span style="color: #666666">);</span>

                fireTableCellUpdated<span style="color: #666666">(</span>rowIndex<span style="color: #666666">,</span> columnIndex<span style="color: #666666">);</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>Exception e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">debug</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;[line={}, value={}] Could not set value to memory&quot;</span><span style="color: #666666">,</span> rowIndex<span style="color: #666666">,</span> aValue<span style="color: #666666">,</span> e<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">writeHex</span><span style="color: #666666">(</span>String aValue<span style="color: #666666">,</span> Byte<span style="color: #666666">[]</span> row<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> value <span style="color: #666666">=</span> Integer<span style="color: #666666">.</span><span style="color: #7D9029">decode</span><span style="color: #666666">(</span>aValue<span style="color: #666666">);</span>
        NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">writeInt</span><span style="color: #666666">(</span>value<span style="color: #666666">,</span> row<span style="color: #666666">,</span> Strategy<span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">writeChar</span><span style="color: #666666">(</span>String aValue<span style="color: #666666">,</span> Byte<span style="color: #666666">[]</span> row<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">3;</span>
        <span style="color: #B00040">int</span> value <span style="color: #666666">=</span> <span style="color: #666666">0;</span>

        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">char</span> c <span style="color: #666666">:</span> aValue<span style="color: #666666">.</span><span style="color: #7D9029">toCharArray</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
            value <span style="color: #666666">|=</span> <span style="color: #666666">((</span>c <span style="color: #666666">&amp;</span> <span style="color: #666666">0xFF)</span> <span style="color: #666666">&lt;&lt;</span> <span style="color: #666666">(</span>i<span style="color: #666666">*8));</span>
            i <span style="color: #666666">-=</span> <span style="color: #666666">1;</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>i <span style="color: #666666">&lt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">writeInt</span><span style="color: #666666">(</span>value<span style="color: #666666">,</span> row<span style="color: #666666">,</span> Strategy<span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">writeBit</span><span style="color: #666666">(</span>String aValue<span style="color: #666666">,</span> <span style="color: #B00040">int</span> columnIndex<span style="color: #666666">,</span> Byte<span style="color: #666666">[]</span> row<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> value<span style="color: #666666">;</span>
        value <span style="color: #666666">=</span> Integer<span style="color: #666666">.</span><span style="color: #7D9029">parseInt</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span> <span style="color: #666666">+</span> aValue<span style="color: #666666">,</span> <span style="color: #666666">2);</span>

        <span style="color: #B00040">int</span> byteIndex <span style="color: #666666">=</span> columnIndex <span style="color: #666666">/</span> <span style="color: #666666">8;</span>
        <span style="color: #B00040">int</span> bitIndex <span style="color: #666666">=</span> <span style="color: #666666">7</span> <span style="color: #666666">-</span> columnIndex <span style="color: #666666">%</span> <span style="color: #666666">8;</span>

        <span style="color: #B00040">int</span> bitMask <span style="color: #666666">=</span> <span style="color: #666666">~(1</span> <span style="color: #666666">&lt;&lt;</span> bitIndex<span style="color: #666666">);</span>
        <span style="color: #B00040">int</span> bitValue <span style="color: #666666">=</span> <span style="color: #666666">(</span>value <span style="color: #666666">&lt;&lt;</span> bitIndex<span style="color: #666666">);</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">((</span>value <span style="color: #666666">&amp;</span> <span style="color: #666666">1)</span> <span style="color: #666666">!=</span> value<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">error</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;[line={}, bit={}, value={}] Could not set bit value. Expected 0 or 1&quot;</span><span style="color: #666666">,</span> byteIndex<span style="color: #666666">,</span> bitIndex<span style="color: #666666">,</span> value<span style="color: #666666">);</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
            row<span style="color: #666666">[</span>byteIndex<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)(</span>row<span style="color: #666666">[</span>byteIndex<span style="color: #666666">]</span> <span style="color: #666666">&amp;</span> bitMask <span style="color: #666666">|</span> bitValue<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>


    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isCellEditable</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> rowIndex<span style="color: #666666">,</span> <span style="color: #B00040">int</span> columnIndex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> columnIndex <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #666666">&amp;&amp;</span> columnIndex <span style="color: #666666">&lt;=</span> <span style="color: #666666">33;</span>
    <span style="color: #666666">}</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">dataChangedAt</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> address<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> COLUMN_COUNT<span style="color: #666666">;</span> i<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
            fireTableCellUpdated<span style="color: #666666">(</span>address<span style="color: #666666">,</span> i<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">clear</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        memory<span style="color: #666666">.</span><span style="color: #7D9029">clear</span><span style="color: #666666">();</span>
        fireTableDataChanged<span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="row-header-renderer">3.6.3. Row header renderer</h4>
<div class="paragraph">
<p>Programming a GUI in Java Swing can be tricky. If we want something non-standard, the way of customization can be
very non-obvious = painful. This is the case when we want to do a "header"-like column in a <code>JTable</code>. Long story
short - this trick lies in a use of <code>JScrollPane</code>. This component implements a viewport, something as a virtual screen,
allowing to put there some other components, and make visible only a part of this screen. Besides, it has a feature
which is called a "row header". It has a <a href="https://docs.oracle.com/javase/8/docs/api/javax/swing/JScrollPane.html#setRowHeaderView-java.awt.Component-">dedicated method</a>
for setting up a custom row header:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>JScrollPane.setRowHeaderView(Component view)</pre>
</div>
</div>
<div class="paragraph">
<p>The trick is to set a <code>javax.swing.JList</code> as a component for the row header. So we end up with the following class:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/memory/gui/RowHeaderRenderer.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JLabel</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JList</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JTable</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.ListCellRenderer</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.UIManager</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.table.JTableHeader</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.Component</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.Dimension</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.CHAR_HEIGHT</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.CHAR_WIDTH</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.DEFAULT_FONT</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">RowHeaderRenderer</span> <span style="color: #008000; font-weight: bold">extends</span> JLabel <span style="color: #008000; font-weight: bold">implements</span> ListCellRenderer <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">int</span> NO_COLUMN_WIDTH <span style="color: #666666">=</span> CHAR_WIDTH <span style="color: #666666">*</span> <span style="color: #666666">4;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> height<span style="color: #666666">;</span>

    RowHeaderRenderer<span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setOpaque</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setBorder</span><span style="color: #666666">(</span>UIManager<span style="color: #666666">.</span><span style="color: #7D9029">getBorder</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;TableHeader.cellBorder&quot;</span><span style="color: #666666">));</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>CENTER<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span>DEFAULT_FONT<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setup</span><span style="color: #666666">(</span>JTable table<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        JTableHeader header <span style="color: #666666">=</span> table<span style="color: #666666">.</span><span style="color: #7D9029">getTableHeader</span><span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">height</span> <span style="color: #666666">=</span> header<span style="color: #666666">.</span><span style="color: #7D9029">getPreferredSize</span><span style="color: #666666">().</span><span style="color: #7D9029">height</span> <span style="color: #666666">+</span> CHAR_HEIGHT<span style="color: #666666">;</span>
        setForeground<span style="color: #666666">(</span>header<span style="color: #666666">.</span><span style="color: #7D9029">getForeground</span><span style="color: #666666">());</span>
        setBackground<span style="color: #666666">(</span>header<span style="color: #666666">.</span><span style="color: #7D9029">getBackground</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Component <span style="color: #0000FF">getListCellRendererComponent</span><span style="color: #666666">(</span>JList list<span style="color: #666666">,</span> Object value<span style="color: #666666">,</span> <span style="color: #B00040">int</span> index<span style="color: #666666">,</span> <span style="color: #B00040">boolean</span> isSelected<span style="color: #666666">,</span> <span style="color: #B00040">boolean</span> cellHasFocus<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        setPreferredSize<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Dimension<span style="color: #666666">(</span>NO_COLUMN_WIDTH<span style="color: #666666">,</span> height<span style="color: #666666">));</span>
        setText<span style="color: #666666">((</span>value <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">?</span> <span style="color: #BA2121">&quot;&quot;</span> <span style="color: #666666">:</span> value<span style="color: #666666">.</span><span style="color: #7D9029">toString</span><span style="color: #666666">());</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cell-renderer-editor">3.6.4. Cell renderer + editor</h4>
<div class="paragraph">
<p>The last two things we need is to display text using different fonts on certain cells. For example, we want that line
and instruction bits have bold font, and others plain one. But - it is generally more readable if the data are shown
in some monospaced font variant. These customizations are "big enough" to require custom class - a cell renderer.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Official tutorial and description of custom renderers can be found
      <a href="http://docs.oracle.com/javase/tutorial/uiswing/components/table.html#renderer">at this link</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The cell renderer code looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/memory/gui/CellRenderer.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.Color</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.Component</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JLabel</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JList</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JTable</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.table.TableCellRenderer</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.BOLD_FONT</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.CHAR_HEIGHT</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.COLOR_CELL_BACK</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.COLOR_CELL_BACK_MOD2</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.COLOR_FORE</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.COLOR_FORE_UNIMPORTANT</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.DEFAULT_FONT</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CellRenderer</span> <span style="color: #008000; font-weight: bold">extends</span> JLabel <span style="color: #008000; font-weight: bold">implements</span> TableCellRenderer <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> JList rowHeader<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> String<span style="color: #666666">[]</span> rowNames<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> RowHeaderRenderer rowHeaderRenderer<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">private</span> Color selectionForeground<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> Color selectionBackground<span style="color: #666666">;</span>

    CellRenderer<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">final</span> MemoryTableModel model<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">rowHeaderRenderer</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> RowHeaderRenderer<span style="color: #666666">();</span>

        rowNames <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> String<span style="color: #666666">[</span>model<span style="color: #666666">.</span><span style="color: #7D9029">getColumnCount</span><span style="color: #666666">()];</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> rowNames<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">;</span> i<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
            rowNames<span style="color: #666666">[</span>i<span style="color: #666666">]</span> <span style="color: #666666">=</span> String<span style="color: #666666">.</span><span style="color: #7D9029">format</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;%02X&quot;</span><span style="color: #666666">,</span> i<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        rowHeader <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> JList<span style="color: #666666">(</span>rowNames<span style="color: #666666">);</span>
        rowHeader<span style="color: #666666">.</span><span style="color: #7D9029">setCellRenderer</span><span style="color: #666666">(</span>rowHeaderRenderer<span style="color: #666666">);</span>

        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setOpaque</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span>DEFAULT_FONT<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>CENTER<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setup</span><span style="color: #666666">(</span>JTable table<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        rowHeader<span style="color: #666666">.</span><span style="color: #7D9029">setFixedCellHeight</span><span style="color: #666666">(</span>table<span style="color: #666666">.</span><span style="color: #7D9029">getRowHeight</span><span style="color: #666666">()</span> <span style="color: #666666">+</span> CHAR_HEIGHT<span style="color: #666666">);</span>
        rowHeaderRenderer<span style="color: #666666">.</span><span style="color: #7D9029">setup</span><span style="color: #666666">(</span>table<span style="color: #666666">);</span>

        selectionBackground <span style="color: #666666">=</span> table<span style="color: #666666">.</span><span style="color: #7D9029">getSelectionBackground</span><span style="color: #666666">();</span>
        selectionForeground <span style="color: #666666">=</span> table<span style="color: #666666">.</span><span style="color: #7D9029">getSelectionForeground</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> JList <span style="color: #0000FF">getRowHeader</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> rowHeader<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Component <span style="color: #0000FF">getTableCellRendererComponent</span><span style="color: #666666">(</span>JTable table<span style="color: #666666">,</span> Object value<span style="color: #666666">,</span> <span style="color: #B00040">boolean</span> isSelected<span style="color: #666666">,</span> <span style="color: #B00040">boolean</span> hasFocus<span style="color: #666666">,</span> <span style="color: #B00040">int</span> row<span style="color: #666666">,</span> <span style="color: #B00040">int</span> column<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>isSelected<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            setBackground<span style="color: #666666">(</span>selectionBackground<span style="color: #666666">);</span>
            setForeground<span style="color: #666666">(</span>selectionForeground<span style="color: #666666">);</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
            Color back <span style="color: #666666">=</span> <span style="color: #666666">((</span>row <span style="color: #666666">%</span> <span style="color: #666666">2)</span> <span style="color: #666666">==</span> <span style="color: #666666">0)</span> <span style="color: #666666">?</span> COLOR_CELL_BACK <span style="color: #666666">:</span> COLOR_CELL_BACK_MOD2<span style="color: #666666">;</span>
            Color front <span style="color: #666666">=</span> COLOR_FORE_UNIMPORTANT<span style="color: #666666">;</span>

            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>MemoryTableModel<span style="color: #666666">.</span><span style="color: #7D9029">isBitInstruction</span><span style="color: #666666">(</span>column<span style="color: #666666">)</span> <span style="color: #666666">||</span> MemoryTableModel<span style="color: #666666">.</span><span style="color: #7D9029">isBitLine</span><span style="color: #666666">(</span>column<span style="color: #666666">))</span> <span style="color: #666666">{</span>
                setFont<span style="color: #666666">(</span>BOLD_FONT<span style="color: #666666">);</span>
                front <span style="color: #666666">=</span> COLOR_FORE<span style="color: #666666">;</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
                setFont<span style="color: #666666">(</span>DEFAULT_FONT<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>

            setBackground<span style="color: #666666">(</span>back<span style="color: #666666">);</span>
            setForeground<span style="color: #666666">(</span>front<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        setText<span style="color: #666666">(</span>value<span style="color: #666666">.</span><span style="color: #7D9029">toString</span><span style="color: #666666">());</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, if we want to let user edit a value in a table, we must provide the editor as a Swing component. The
"cell editor" is in fact plain <code>javax.swing.JTextField</code> with some customizations. However if we want to use it,
we must wrap it in a separate class, which needs to extend <code>AbstractCellEditor</code> and implement <code>TableCellEditor</code>.</p>
</div>
<div class="paragraph">
<p>Our customizations involve accommodating the width of the text field, and preparing the initial value when the
editor shows up. User can activate the editor by double-clicking on a cell. The source code of the cell editor is
as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/memory/gui/CellEditor.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.Component</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.FontMetrics</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.AbstractCellEditor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JTable</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JTextField</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.table.TableCellEditor</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.CHAR_HEIGHT</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.COLUMN_WIDTH</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.Constants.DEFAULT_FONT</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.MemoryTableModel.COLUMN_HEX_VALUE</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.gui.MemoryTableModel.COLUMN_RAW_VALUE</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CellEditor</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCellEditor <span style="color: #008000; font-weight: bold">implements</span> TableCellEditor <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> JTextField editComponent <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> JTextField<span style="color: #666666">();</span>
    <span style="color: #008000; font-weight: bold">private</span> FontMetrics fontMetrics<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setComponentSize</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> columnIndex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>fontMetrics <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            editComponent<span style="color: #666666">.</span><span style="color: #7D9029">setSize</span><span style="color: #666666">(</span>COLUMN_WIDTH<span style="color: #666666">[</span>columnIndex<span style="color: #666666">],</span> fontMetrics<span style="color: #666666">.</span><span style="color: #7D9029">getHeight</span><span style="color: #666666">()</span> <span style="color: #666666">+</span> CHAR_HEIGHT<span style="color: #666666">);</span>
            editComponent<span style="color: #666666">.</span><span style="color: #7D9029">setBorder</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setup</span><span style="color: #666666">(</span>JTable table<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        fontMetrics <span style="color: #666666">=</span> table<span style="color: #666666">.</span><span style="color: #7D9029">getFontMetrics</span><span style="color: #666666">(</span>DEFAULT_FONT<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Component <span style="color: #0000FF">getTableCellEditorComponent</span><span style="color: #666666">(</span>JTable table<span style="color: #666666">,</span> Object value<span style="color: #666666">,</span> <span style="color: #B00040">boolean</span> isSelected<span style="color: #666666">,</span> <span style="color: #B00040">int</span> rowIndex<span style="color: #666666">,</span> <span style="color: #B00040">int</span> columnIndex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(!</span>isSelected<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
        setComponentSize<span style="color: #666666">(</span>columnIndex<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">switch</span> <span style="color: #666666">(</span>columnIndex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">case</span> COLUMN_RAW_VALUE<span style="color: #666666">:</span>
                editComponent<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> COLUMN_HEX_VALUE<span style="color: #666666">:</span>
                editComponent<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0x&quot;</span><span style="color: #666666">+</span> String<span style="color: #666666">.</span><span style="color: #7D9029">valueOf</span><span style="color: #666666">(</span>value<span style="color: #666666">));</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">default</span><span style="color: #666666">:</span>
                editComponent<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>String<span style="color: #666666">.</span><span style="color: #7D9029">valueOf</span><span style="color: #666666">(</span>value<span style="color: #666666">));</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> editComponent<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Object <span style="color: #0000FF">getCellEditorValue</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> editComponent<span style="color: #666666">.</span><span style="color: #7D9029">getText</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wrapping-it-up">3.7. Wrapping it up</h3>
<div class="paragraph">
<p>The final step is to finish the class <code>MemoryImpl</code>. We need to enable the use our GUI in emuStudio. The
<code>emulib.plugins.Memory</code> interface has a method named <code>showSettings</code> which is called when user clicks on the memory
icon in the debug tool bar in emuStudio emulation panel. This method is responsible for showing the GUI of memory,
and will be called repeatedly, always when a user clicks on the mentioned icon.</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/memory/MemoryImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractMemory <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> Logger LOGGER <span style="color: #666666">=</span> LoggerFactory<span style="color: #666666">.</span><span style="color: #7D9029">getLogger</span><span style="color: #666666">(</span>MemoryImpl<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryContextImpl memContext <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>
    <span style="color: #008000; font-weight: bold">private</span> MemoryGUI memoryGUI<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">MemoryImpl</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
            contextPool<span style="color: #666666">.</span><span style="color: #7D9029">register</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">,</span> memContext<span style="color: #666666">,</span> MemoryContext<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>AlreadyRegisteredException <span style="color: #666666">|</span> InvalidContextException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            StaticDialogs<span style="color: #666666">.</span><span style="color: #7D9029">showErrorMessage</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Could not register SSEM memory&quot;</span><span style="color: #666666">,</span> getTitle<span style="color: #666666">());</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getVersion</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;1.0.0&quot;</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settings<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(!</span>Boolean<span style="color: #666666">.</span><span style="color: #7D9029">parseBoolean</span><span style="color: #666666">(</span>settings<span style="color: #666666">.</span><span style="color: #7D9029">readSetting</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">,</span> SettingsManager<span style="color: #666666">.</span><span style="color: #7D9029">NO_GUI</span><span style="color: #666666">)))</span> <span style="color: #666666">{</span>
            memoryGUI <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryGUI<span style="color: #666666">(</span>memContext<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">destroy</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getSize</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> MemoryContextImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER_OF_CELLS</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isShowSettingsSupported</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">showSettings</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>memoryGUI <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            memoryGUI<span style="color: #666666">.</span><span style="color: #7D9029">setVisible</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from the code, there are several things to notice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In constructor, we will register new instance of our memory context. Since we do not have custom context, the
interface, passed as the second argument to call <code>contextPool.register()</code> will be plain <code>MemoryContext.class</code>.
If we had custom context, it would require to be defined in separate interface which will extend the standard
<code>MemoryContext</code>, and annotated with <code>@emulib.annotations.ContextType</code> annotation.</p>
</li>
<li>
<p>In the <code>initialize()</code> method, we determine if we run in a "non-GUI" mode. We use a <code>SettingsManager</code> object for
this purpose, which is an API for reading/writing plugin settings - key/value pairs from the computer configuration
file. The "non-GUI", also called "headless" mode, means that the user who run emuStudio did not want GUI to be
available. This is often useful when performing automatic emulation. See the user manual for more details. For us,
developers, it means that we need to <strong>ignore</strong> all requests for showing GUI. Therefore, we create the GUI only if
we are NOT in the "non-GUI" mode.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="testing-3">3.8. Testing</h3>
<div class="paragraph">
<p>It is not only a good practice, but often a safety net to perform automatic tests. They can save a lot of debugging time
when something just does not work. Usually, tests should test the most important things - we usually don&#8217;t test setters
or getters. In case of GUI, it also does not matter much for our case.</p>
</div>
<div class="paragraph">
<p>What should be tested is the context itself - since it&#8217;s the core part of the memory, and also some interaction with
the main plugin class. For example, the automated unit test of the memory context can look as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/test/java/net/sf/emustudio/ssem/memory/impl/MemoryContextImplTest.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.memory.impl</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.Memory</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.junit.Test</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.easymock.EasyMock.createMock</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.easymock.EasyMock.eq</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.easymock.EasyMock.expectLastCall</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.easymock.EasyMock.replay</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.easymock.EasyMock.verify</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertArrayEquals</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">org.junit.Assert.assertEquals</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MemoryContextImplTest</span> <span style="color: #666666">{</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testAfterClearObserversAreNotified</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        MemoryContextImpl context <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>

        Memory<span style="color: #666666">.</span><span style="color: #7D9029">MemoryListener</span> listener <span style="color: #666666">=</span> createMock<span style="color: #666666">(</span>Memory<span style="color: #666666">.</span><span style="color: #7D9029">MemoryListener</span><span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
        listener<span style="color: #666666">.</span><span style="color: #7D9029">memoryChanged</span><span style="color: #666666">(</span>eq<span style="color: #666666">(-1));</span>
        expectLastCall<span style="color: #666666">().</span><span style="color: #7D9029">once</span><span style="color: #666666">();</span>
        replay<span style="color: #666666">(</span>listener<span style="color: #666666">);</span>

        context<span style="color: #666666">.</span><span style="color: #7D9029">addMemoryListener</span><span style="color: #666666">(</span>listener<span style="color: #666666">);</span>
        context<span style="color: #666666">.</span><span style="color: #7D9029">clear</span><span style="color: #666666">();</span>

        verify<span style="color: #666666">(</span>listener<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testReadWithoutWritReturnsZero</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        MemoryContextImpl context <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>

        assertEquals<span style="color: #666666">(0</span>L<span style="color: #666666">,</span> <span style="color: #666666">(</span><span style="color: #B00040">long</span><span style="color: #666666">)</span>context<span style="color: #666666">.</span><span style="color: #7D9029">read</span><span style="color: #666666">(10));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span><span style="color: #666666">(</span>expected <span style="color: #666666">=</span> IndexOutOfBoundsException<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">)</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testReadAtInvalidLocationThrows</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        MemoryContextImpl context <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>

        context<span style="color: #666666">.</span><span style="color: #7D9029">read</span><span style="color: #666666">(-1);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testAfterReadNoObserversAreNotified</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        MemoryContextImpl context <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>

        Memory<span style="color: #666666">.</span><span style="color: #7D9029">MemoryListener</span> listener <span style="color: #666666">=</span> createMock<span style="color: #666666">(</span>Memory<span style="color: #666666">.</span><span style="color: #7D9029">MemoryListener</span><span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
        replay<span style="color: #666666">(</span>listener<span style="color: #666666">);</span>

        context<span style="color: #666666">.</span><span style="color: #7D9029">addMemoryListener</span><span style="color: #666666">(</span>listener<span style="color: #666666">);</span>
        context<span style="color: #666666">.</span><span style="color: #7D9029">read</span><span style="color: #666666">(10);</span>

        verify<span style="color: #666666">(</span>listener<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testAfterWriteObserversAreNotified</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        MemoryContextImpl context <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>

        Memory<span style="color: #666666">.</span><span style="color: #7D9029">MemoryListener</span> listener <span style="color: #666666">=</span> createMock<span style="color: #666666">(</span>Memory<span style="color: #666666">.</span><span style="color: #7D9029">MemoryListener</span><span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
        listener<span style="color: #666666">.</span><span style="color: #7D9029">memoryChanged</span><span style="color: #666666">(</span>eq<span style="color: #666666">(10));</span>
        expectLastCall<span style="color: #666666">().</span><span style="color: #7D9029">once</span><span style="color: #666666">();</span>
        replay<span style="color: #666666">(</span>listener<span style="color: #666666">);</span>

        context<span style="color: #666666">.</span><span style="color: #7D9029">addMemoryListener</span><span style="color: #666666">(</span>listener<span style="color: #666666">);</span>
        context<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(10,</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)134);</span>

        verify<span style="color: #666666">(</span>listener<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testWriteReallyWritesCorrectValueAtCorrectLocation</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        MemoryContextImpl context <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>

        context<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(10,</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)134);</span>
        assertEquals<span style="color: #666666">((</span><span style="color: #B00040">byte</span><span style="color: #666666">)134,</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)</span>context<span style="color: #666666">.</span><span style="color: #7D9029">read</span><span style="color: #666666">(10));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span><span style="color: #666666">(</span>expected <span style="color: #666666">=</span> IndexOutOfBoundsException<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">)</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testWriteAtInvalidLocationThrows</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        MemoryContextImpl context <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>

        context<span style="color: #666666">.</span><span style="color: #7D9029">write</span><span style="color: #666666">(-1,</span> <span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">)134);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testGetSizeReturnsNumberOfCells</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        MemoryContextImpl context <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>

        assertEquals<span style="color: #666666">(</span>MemoryContextImpl<span style="color: #666666">.</span><span style="color: #7D9029">NUMBER_OF_CELLS</span><span style="color: #666666">,</span> context<span style="color: #666666">.</span><span style="color: #7D9029">getSize</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testClassTypeIsByte</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        assertEquals<span style="color: #666666">(</span>Byte<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">().</span><span style="color: #7D9029">getDataType</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testReadWordIsSupported</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        assertArrayEquals<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Byte<span style="color: #666666">[]</span> <span style="color: #666666">{0,0,0,0},</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">().</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(0));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Test</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">testWriteWordIsSupported</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        MemoryContextImpl mem <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> MemoryContextImpl<span style="color: #666666">();</span>

        Byte<span style="color: #666666">[]</span> row <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Byte<span style="color: #666666">[]</span> <span style="color: #666666">{1,2,3,4};</span>
        mem<span style="color: #666666">.</span><span style="color: #7D9029">writeWord</span><span style="color: #666666">(0,</span> row<span style="color: #666666">);</span>

        assertArrayEquals<span style="color: #666666">(</span>row<span style="color: #666666">,</span> mem<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(0));</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CPU_HOWTO">4. Writing a CPU</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial will describe some basic knowledge about how to create a CPU to be used in emuStudio. The tutorial
does not aim to explain emulation techniques in much detail, nor it is exhaustive. This is left for the programmer.
The tutorial focuses on how to use emuLib API in a CPU project so it can be used in emuStudio.</p>
</div>
<div class="sect2">
<h3 id="CPU_GETTING_STARTED">4.1. Getting started</h3>
<div class="paragraph">
<p>Before reading on, please read the <a href="#INTRODUCTION_PLUGINS">Introduction</a> chapter. It gives the information
needed for setting up the development environment and for basic understanding how the emuStudio/plug-ins lifecycle
work.</p>
</div>
<div class="paragraph">
<p>A CPU is just another plug-in, which means that it is "enough" to implement some API. The CPU
API can be found in <code>emulib.plugins.cpu</code> project package.</p>
</div>
<div class="paragraph">
<p>CPU is supposed to be the core of the emulator in the similar way as the real CPU is core to the computer.
The term "emulation technique" is usually used when we talk about CPU emulation. This tutorial will not cover
the techniques in much detail. Furthermore, only instruction interpretation will be used for its simplicity.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More information about emulation techniques can be found for example at
      <a href="http://www.xsim.com/papers/Bario.2001.emubook.pdf">this link</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this tutorial, a simple CPU will be implemented for the world&#8217;s very first stored-program computer,
<a href="https://en.wikipedia.org/wiki/Manchester_Small-Scale_Experimental_Machine">SSEM</a>, nicknamed
"Baby". It was a predecessor of Manchester Mark 1 which led to Ferranti Mark 1, the world&#8217;s first commercially available
general-purpose computer.</p>
</div>
</div>
<div class="sect2">
<h3 id="CPU_WHAT_CPU_DOES">4.2. What emuStudio&#8217;s CPU can do</h3>
<div class="paragraph">
<p>CPU emulators in emuStudio are not just plain emulators. Besides, they must cooperate with emuStudio and provide
capabilities allowing debugging and some visualization.</p>
</div>
<div class="paragraph">
<p>The CPU must, besides the emulation "engine", implement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Disassembler</p>
</li>
<li>
<p>Java Swing GUI panel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Disassembler will be used by emuStudio for creating the list of instructions in the debugger panel. The visualization
of CPU registers, possibly current frequency and run state must be implemented by the CPU plug-in. For that purpose
the plug-in must provide the GUI panel to CPU.</p>
</div>
<div class="paragraph">
<p>Both the disassembler and GUI panel should be instantiated only once. emuStudio will ask for them also only once, during
the process of loading of the virtual computer.</p>
</div>
<div class="paragraph">
<p>For developing disassembler, there is good news. There exist a tool which can generate emuStudio disassembler from
a specification file. It is called Edigen, a short for "emulator disassembler generator". We will use this tool also
in this tutorial. For more information, see the projects at:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/sulir/edigen" class="bare">https://github.com/sulir/edigen</a></p>
</li>
<li>
<p>and <a href="https://github.com/sulir/edigen-maven-plugin" class="bare">https://github.com/sulir/edigen-maven-plugin</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="preparing-the-environment-3">4.3. Preparing the environment</h3>
<div class="paragraph">
<p>We will use Maven for managing the source code and dependencies.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are new to Maven, please read
      <a href="https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html">Maven in 5 minutes</a> tutorial.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The project should be located in <code>emuStudio/plugins/cpu/ssem-cpu</code>.
In order to create the initial project structure, run <code>mvn archetype:generate</code> in that directory.</p>
</div>
<div class="paragraph">
<p>The following structure should now exist:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>src/
  main/
    java/
    resources/
test/
  java/
pom.xml</pre>
</div>
</div>
<div class="paragraph">
<p>We will start with the <code>pom.xml</code> file, which follows.</p>
</div>
<div class="listingblock">
<div class="title"><code>pom.xml</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span style="color: #008000; font-weight: bold">&lt;project</span> <span style="color: #7D9029">xmlns=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span style="color: #7D9029">xmlns:xsi=</span><span style="color: #BA2121">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span style="color: #7D9029">xsi:schemaLocation=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;modelVersion&gt;</span>4.0.0<span style="color: #008000; font-weight: bold">&lt;/modelVersion&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;parent&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emustudio-parent<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;version&gt;</span>0.39<span style="color: #008000; font-weight: bold">&lt;/version&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;relativePath&gt;</span>../../..<span style="color: #008000; font-weight: bold">&lt;/relativePath&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/parent&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>ssem-cpu<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;packaging&gt;</span>jar<span style="color: #008000; font-weight: bold">&lt;/packaging&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;name&gt;</span>SSEM CPU emulator<span style="color: #008000; font-weight: bold">&lt;/name&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;description&gt;</span>Java-based SSEM CPU emulator<span style="color: #008000; font-weight: bold">&lt;/description&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;build&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;finalName&gt;</span>ssem-cpu<span style="color: #008000; font-weight: bold">&lt;/finalName&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;plugins&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-jar-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;archive&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;manifest&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addClasspath&gt;</span>false<span style="color: #008000; font-weight: bold">&lt;/addClasspath&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultImplementationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultImplementationEntries&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultSpecificationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultSpecificationEntries&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/manifest&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/archive&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-dependency-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>com.github.sulir<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>edigen-maven-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;decoderName&gt;</span>net.sf.emustudio.ssem.DecoderImpl<span style="color: #008000; font-weight: bold">&lt;/decoderName&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;disassemblerName&gt;</span>net.sf.emustudio.ssem.DisassemblerImpl<span style="color: #008000; font-weight: bold">&lt;/disassemblerName&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;executions&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;execution&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;goals&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;goal&gt;</span>generate<span style="color: #008000; font-weight: bold">&lt;/goal&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/goals&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/execution&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/executions&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/plugins&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/build&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;dependencies&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>cpu-testsuite<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.slf4j<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>slf4j-api<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.slf4j<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>slf4j-nop<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;scope&gt;</span>test<span style="color: #008000; font-weight: bold">&lt;/scope&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emuLib<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.easymock<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>easymock<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>cpu-testsuite<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;scope&gt;</span>test<span style="color: #008000; font-weight: bold">&lt;/scope&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/dependencies&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/project&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-main-class-2">4.4. The main class</h3>
<div class="paragraph">
<p>We will start with implementing the main class of the CPU. It provides the main communication point - the API - used by
emuStudio main module. The main module can pass requests for starting or stopping the emulation, or it can request
for the disassembler or the GUI panel.</p>
</div>
<div class="paragraph">
<p>We will start with small snippet of code which will be extended throughout the tutorial. The first snippet looks
as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #AA22FF">@PluginType</span><span style="color: #666666">(</span>
    type <span style="color: #666666">=</span> PLUGIN_TYPE<span style="color: #666666">.</span><span style="color: #7D9029">CPU</span><span style="color: #666666">,</span>
    title <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;SSEM CPU&quot;</span><span style="color: #666666">,</span>
    copyright <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;\u00A9 Copyright 2017, Your Name&quot;</span><span style="color: #666666">,</span>
    description <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Emulator of SSEM CPU&quot;</span>
<span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">CpuImpl</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">destroyInternal</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">protected</span> RunState <span style="color: #0000FF">stepInternal</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> JPanel <span style="color: #0000FF">getStatusPanel</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getInstructionPosition</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">0;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">setInstructionPosition</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> i<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Disassembler <span style="color: #0000FF">getDisassembler</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>

    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getVersion</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;1.0.0&quot;</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> RunState <span style="color: #0000FF">call</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, there is a lot of methods which needs attention. Note two methods especially - <code>getStatusPanel()</code>
and <code>getDisassembler()</code>. Those two methods will return the components, mentioned first in section <a href="#CPU_WHAT_CPU_DOES">What emuStudio&#8217;s CPU can do</a>.</p>
</div>
<div class="paragraph">
<p>Also note that the class extends from <code>AbstractCPU</code>. The <code>AbstractCPU</code> class lies in emuLib library. It implements
some fundamental methods required by <code>CPU</code> interface. For example, managing breakpoints and controlling the
high-level emulation lifecycle in a thread-safe way. Generally speaking, the class eliminates lots of repeated
boiler-plate code needed to be done in every CPU plug-in.</p>
</div>
</div>
<div class="sect2">
<h3 id="CPU_BEHAVIORAL_CONTRACTS">4.5. Behavioral contracts</h3>
<div class="sect3">
<h4 id="load-and-initialization">4.5.1. Load and initialization</h4>
<div class="paragraph">
<p>Loading the virtual computer starts with creating separate class loader derived from the one emuStudio is using,
so each plug-in can see everything what emuStudio can see, roughly speaking. There can be loaded only one computer
in emuStudio.</p>
</div>
<div class="paragraph">
<p>The CPU plug-in JAR file is loaded using the class loader as a second in order.</p>
</div>
<div class="paragraph">
<p>The loading process follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>JAR content is searched for a main class. Main class must be annotated with <code>@PluginType(type = PLUGIN_TYPE.CPU)</code>
annotation and it does not matter in which package it resists.</p>
</li>
<li>
<p>There must be just one main class in the JAR. If there are more classes annotated with mentioned annotation, the
first found will be used; however the search order is non-deterministic.</p>
</li>
<li>
<p>The main class must implement <code>emulib.plugins.cpu.CPU</code> interface (in any depth of inheritance).</p>
</li>
<li>
<p>Plug-in is instantiated by calling the main class constructor. The constructor must be public and must have two
parameters of type: <code>java.lang.Long</code> (as the first) and <code>emulib.runtime.ContextPool</code> (as the second). The first
parameter represents a unique plug-in ID assigned by emuLib. This ID can then be used to access configuration
of the emulated computer. The second parameter is a context pool object. It is a pool of plugin contexts, runtime
entities intended for the plug-in intercommunication. In the constructor, the CPU should initialize its context to
the context pool. However; it must not retrieve the contexts of other plugins now, because they are not present at
this point, except compiler.</p>
</li>
<li>
<p>Plug-in is initialized by calling method <code>emulib.plugins.Plugin.initialize(SettingsManager settingsManager)</code> from
the main thread of emuStudio (not UI thread). This method is intended for all the initialization which could not be
performed in the constructor, such as reading plug-in settings, or retrieving contexts of other plug-in(s) from
the context pool.</p>
</li>
<li>
<p>Specifically for CPU, emuStudio calls <code>getDisassembler()</code> and <code>getStatusPanel()</code> methods in unspecified order.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After those steps, the CPU plug-in is ready. Further work of the CPU is event-based. emuStudio will handle UI events
and control the plug-in by calling appropriate methods of the main class instance. CPU emulators are run in
different thread than UI thread, so all method calls come from the same "controller" thread.</p>
</div>
<div class="paragraph">
<p>In case of automatic emulation, the emulation control is performed only in the main thread.</p>
</div>
</div>
<div class="sect3">
<h4 id="emulation-lifecycle">4.5.2. Emulation lifecycle</h4>
<div class="paragraph">
<p>As it was described in section "Emulation lifecycle" in the user manual of the main module, the emulation "life"
is a state machine. This state machine manages a state, called "current state". It then reacts on events from the
outside world and transitions the current state to another state, following the rules. The state transition can, and
in this case does - cause side-effects. It means that except the simple changing the state, it performs some actions.</p>
</div>
<div class="paragraph">
<p>For example, you know that there is a button above the debug window, a green-filled arrow, when clicked on it
the emulation will be executed. Besides, there are more buttons, for example "step emulation", which will do execute
just one CPU instruction. The clicks on the buttons are the "outside world" events, which will be propagated to
the state machine of emuStudio.</p>
</div>
<div class="paragraph">
<p>The state machine can be seen in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vbmacher.github.io/emuStudio/images/run-states.svg" alt="run states" width="335" height="300">
</div>
</div>
<div class="paragraph">
<p>The states of the state machine are encoded into an enum in emuLib:</p>
</div>
<div class="listingblock">
<div class="title"><code>emulib.plugins.cpu.CPU.RunState</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">enum</span> RunState <span style="color: #666666">{</span>
    STATE_STOPPED_NORMAL<span style="color: #666666">(</span><span style="color: #BA2121">&quot;stopped&quot;</span><span style="color: #666666">),</span>
    STATE_STOPPED_BREAK<span style="color: #666666">(</span><span style="color: #BA2121">&quot;breakpoint&quot;</span><span style="color: #666666">),</span>
    STATE_STOPPED_ADDR_FALLOUT<span style="color: #666666">(</span><span style="color: #BA2121">&quot;stopped (address fallout)&quot;</span><span style="color: #666666">),</span>
    STATE_STOPPED_BAD_INSTR<span style="color: #666666">(</span><span style="color: #BA2121">&quot;stopped (instruction fallout)&quot;</span><span style="color: #666666">),</span>
    STATE_RUNNING<span style="color: #666666">(</span><span style="color: #BA2121">&quot;running&quot;</span><span style="color: #666666">);</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The initial state is <code>breakpoint</code>. This is a behavioral contract which all CPUs must fulfil.</p>
</div>
<div class="paragraph">
<p>The <code>AbstractCPU</code> class implements the state machine by implementing fundamental methods of the <code>CPU</code> interface:</p>
</div>
<div class="listingblock">
<div class="title"><code>emulib.plugins.cpu.CPU</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">interface</span> <span style="color: #0000FF; font-weight: bold">CPU</span> <span style="color: #008000; font-weight: bold">extends</span> Plugin <span style="color: #666666">{</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">step</span><span style="color: #666666">();</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">execute</span><span style="color: #666666">();</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">pause</span><span style="color: #666666">();</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">stop</span><span style="color: #666666">();</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">reset</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> memoryLocation<span style="color: #666666">);</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The CPU plug-in developer can benefit from using <code>AbstractCPU</code> which implements most of the methods in a thread-safe
way. It is the required to implement only the following methods, which do not have to be synchronized:</p>
</div>
<div class="listingblock">
<div class="title"><code>emulib.plugins.cpu.AbstractCPU</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #AA22FF">@ThreadSafe</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AbstractCPU</span> <span style="color: #008000; font-weight: bold">implements</span> CPU<span style="color: #666666">,</span> Callable<span style="color: #666666">&lt;</span>RunState<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #008000; font-weight: bold">abstract</span> RunState <span style="color: #0000FF">stepInternal</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">resetInternal</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> var1<span style="color: #666666">);</span>

    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">destroyInternal</span><span style="color: #666666">();</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="cpu-emulation-modes">CPU emulation modes</h5>
<div class="paragraph">
<p>The CPU can work in two modes while performing the emulation: "step" mode or "run" mode. The modes are disjunct - only one
of them can be active in time.</p>
</div>
<div class="sect5">
<h6 id="step-mode">"Step" mode</h6>
<div class="paragraph">
<p>In the "step" mode, the CPU emulates instructions in "steps", one-by-one. One instruction should be emulated by calling
<code>step()</code> method. After the emulation of the instruction is finished, the CPU run state should be returned back to
<code>STATE_STOPPED_BREAK</code>.</p>
</div>
<div class="paragraph">
<p>In case of error, the run state should change to <code>STATE_STOPPED_(how)</code>, where <code>(how)</code> is the general root cause of the
error (e.g. <code>BAD_INSTR</code> or <code>ADDR_FALLOUT</code>).</p>
</div>
<div class="paragraph">
<p>In this mode, it is not required to emulate the instruction in a performance-optimized manner.</p>
</div>
</div>
<div class="sect5">
<h6 id="run-mode">"Run" mode</h6>
<div class="paragraph">
<p>In the "run" mode, the CPU should emulate instructions infinitely until either some CPU-halt instruction is encountered
or user stops the emulation by external GUI event. Within this mode the developer is encouraged to use some good
emulation technique, which can focus on performance. The code paths which will be run by JVM in this mode should be
optimized for performance.</p>
</div>
<div class="paragraph">
<p>Furthermore, emuStudio will stop disassembling instructions and also other performance-consuming tasks to unburden the
CPU and other virtual components from various requests causing slow down of the general emulation performance.</p>
</div>
<div class="paragraph">
<p>When the emulation is finished, either by the external event (clicking on the "stop" button) or by some instruction,
the run state should be set accordingly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if the stop is "normal" or "expected", the run state should be <code>STATE_STOPPED_NORMAL</code></p>
</li>
<li>
<p>if the stop is caused by trying to read/write from nonexistant location in memory, the run state should be <code>STOPPED_ADDR_FALLOUT</code></p>
</li>
<li>
<p>if the stop is caused by trying to execute unknown instruction, the run state should be <code>STOPPED_BAD_INSTR</code></p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="final-notes">Final notes</h6>
<div class="paragraph">
<p>The described modes are reflected in methods of <code>AbstractCPU</code> class. The <code>call()</code> method represents the "run" mode, and
<code>stepInternal()</code> method, represents the "step" mode.</p>
</div>
<div class="paragraph">
<p>The contract which needs attention is threading. Execution of mentioned methods is done always by emuStudio.
It has dedicated one thread for this purpose. The methods are never executed from the UI thread, but from the dedicated
thread, using a work-queue for the upcoming events.</p>
</div>
<div class="paragraph">
<p>This means that CPU emulation control will not block UI, even if the execution takes longer time.
However, all the other methods from the CPU interface are (possibly) executed from the UI thread, so they should be
implemented in a responsive manner; they can block.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="CPU_SSEM_ARCHITECTURE">4.6. Architecture</h3>
<div class="paragraph">
<p>SSEM is one of the first implementations of the von-Neumann design of a computer. It contained control unit,
arithmetic-logic unit and I/O subsystem (CRT display). More information about the real architecture can be found
at <a href="http://www.cs.ubc.ca/~hilpert/e/SSEM/">this link</a>.</p>
</div>
<div class="paragraph">
<p>The architecture of our SSEM CPU emulator will look as follows (below is Display and Memory just to show how it
is connected overally):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vbmacher.github.io/emuStudio/images/ssem-scheme.svg" alt="ssem scheme" width="402" height="301">
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-main-class-3">4.7. The main class</h3>
<div class="paragraph">
<p>The fundamental steps when building a CPU involves the initialization and destruction code. After reading the
<a href="#CPU_BEHAVIORAL_CONTRACTS">Behavioral contracts</a>, you should be aware of how the code should look like.</p>
</div>
<div class="paragraph">
<p>The initialization code is represented by the constructor and the <code>initialize()</code> method.</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> ContextPool contextPool<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">CpuImpl</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">contextPool</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>contextPool<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        <span style="color: #408080; font-style: italic">// TODO</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will leave the other methods unimplemented for now.</p>
</div>
<div class="paragraph">
<p>While getting to the initialization part, what the CPU needs in order to operate? Especially, our SSEM "CPU". It
requires memory. The I/O subsystem, as can be seen at the picture under <a href="#CPU_SSEM_ARCHITECTURE">Architecture</a> section, will not be
implemented in this tutorial. There is dedicated separate tutorial for the CRT display.</p>
</div>
<div class="paragraph">
<p>The first step of the initialization is getting the memory from the context pool:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> MemoryContext<span style="color: #666666">&lt;</span>Integer<span style="color: #666666">&gt;</span> memory<span style="color: #666666">;</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        memory <span style="color: #666666">=</span> contextPool<span style="color: #666666">.</span><span style="color: #7D9029">getMemoryContext</span><span style="color: #666666">(</span>getPluginID<span style="color: #666666">(),</span> MemoryContext<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we see what the context pool is used for. It is a "storage" of communication objects which plug-ins provide
(contexts). Other plug-ins, which are connected with the one they want to communicate with, ask for the context.
There exist many specific contexts - for CPU, for compilers, memories or devices.</p>
</div>
<div class="paragraph">
<p>What&#8217;s more, the context can be extended with another, custom methods. In this case, the context class should be
passed as the second argument when calling <code>get&#8230;&#8203;Context()</code>. In our case, we expect the standard <code>MemoryContext</code>
interface, so we pass <code>MemoryContext.class</code> as the second argument.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The question you might have is why not to get the memory in the constructor? To answer this question, please
      read the document "Introduction for writing virtual computers", section "Loading and initialization".
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What now? We need to implement three fundamental components - GUI panel, disassembler and the emulator engine itself.
We can start with the interesting stuff right away.</p>
</div>
</div>
<div class="sect2">
<h3 id="emulator-engine">4.8. Emulator engine</h3>
<div class="paragraph">
<p>Emulator engine is the core of the emulator. As we all probably know, the CPU interprets some binary-encoded "commands"
- instructions - which are stored in memory. Basic von-Neumann CPUs work sequentially. Execution of one instruction
involves four basic steps: fetch, decode and execute, and store, executed in order.</p>
</div>
<div class="paragraph">
<p>Implementation of these steps in a programming language like Java does not have to be so explicit. It is often true
that the steps will overlap and mix up in the emulation algorithm; they really don&#8217;t have to be explicitly distinguished.
The aim of the emulator is to preserve external behavior (output or the effect), not the internal behavior. This is
different for the case of a simulator, which tries to mimic both internal and external behavior.</p>
</div>
<div class="paragraph">
<p>Emulator "looks" like real computer, "behaves" like the real one, but inside it is normal program which was written
using any programming style; it can use various variables, methods and other language features.</p>
</div>
<div class="paragraph">
<p>The pseudo-algorithm for executing one instruction can look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>step() {
  // fetch phase
  instruction = memory.read(current_instruction);
  current_instruction = current_instruction + 1;

  // decode phase
  line = parseLine(instruction);
  opcode = parseOpcode(instruction);

  // execute phase
  switch (opcode) {
    case 0: // JMP
      ...
    case 4: // JPR
      ...
    ...
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>And what CPU does when it runs? It executes these steps in the infinite loop, until it is stopped either internally or
by the external event. The main CPU emulation algorithm just described is called "interpretation", and it can look as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>run() {
  while (!stopped) {
    step();
  }
}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Java, besides interpretation it is possible to write also a threaded dispatch algorithm, which requires Java
      relection or lambdas. Threaded dispatch stores the execution implementation of each instruction in a separate
      method. Then, there is a dispatch table (array of method references), which maps the methods by opcode. Then,
      after the decoding of the opcode, the instruction is executed just by indexing that table and executing the method it
      references to. This algorithm is generally faster than interpretation, and it is still simple enough to be
      implemented.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our emulator engine will be constructed as a separate class. Besides the emulation methods it will contain the
variables representing CPU registers - <code>CI</code> (current instruction) and <code>Acc</code> (accumulator). In SSEM, both are 32-bit
values.</p>
</div>
<div class="paragraph">
<p>The class looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/EmulatorEngine.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EmulatorEngine</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">volatile</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> currentRunState<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">volatile</span> <span style="color: #B00040">int</span> Acc<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">volatile</span> <span style="color: #B00040">int</span> CI<span style="color: #666666">;</span>

    EmulatorEngine<span style="color: #666666">(</span>MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memory</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">reset</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> startingPos<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        Acc <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
        CI <span style="color: #666666">=</span> startingPos<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> <span style="color: #0000FF">step</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        Byte<span style="color: #666666">[]</span> instruction <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>CI<span style="color: #666666">);</span>
        CI <span style="color: #666666">+=</span> <span style="color: #666666">4;</span>

        <span style="color: #B00040">int</span> line <span style="color: #666666">=</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">reverseBits</span><span style="color: #666666">(</span>instruction<span style="color: #666666">[0],</span> <span style="color: #666666">8)</span> <span style="color: #666666">*</span> <span style="color: #666666">4;</span>
        <span style="color: #B00040">int</span> opcode <span style="color: #666666">=</span> instruction<span style="color: #666666">[1]</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">7;</span>

        <span style="color: #008000; font-weight: bold">switch</span> <span style="color: #666666">(</span>opcode<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">0:</span> <span style="color: #408080; font-style: italic">// JMP</span>
                <span style="color: #B00040">int</span> oldCi <span style="color: #666666">=</span> CI <span style="color: #666666">-</span> <span style="color: #666666">4;</span>
                CI <span style="color: #666666">=</span> <span style="color: #666666">4</span> <span style="color: #666666">*</span> readInt<span style="color: #666666">(</span>line<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>CI <span style="color: #666666">==</span> oldCi<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    <span style="color: #408080; font-style: italic">// endless loop detected;</span>
                    <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_NORMAL</span><span style="color: #666666">;</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">4:</span> <span style="color: #408080; font-style: italic">// JPR</span>
                CI <span style="color: #666666">=</span> CI <span style="color: #666666">+</span> <span style="color: #666666">4</span> <span style="color: #666666">*</span> readInt<span style="color: #666666">(</span>line<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">2:</span> <span style="color: #408080; font-style: italic">// LDN</span>
                Acc <span style="color: #666666">=</span> <span style="color: #666666">-</span>readInt<span style="color: #666666">(</span>line<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">6:</span> <span style="color: #408080; font-style: italic">// STO</span>
                writeInt<span style="color: #666666">(</span>line<span style="color: #666666">,</span> Acc<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">1:</span> <span style="color: #408080; font-style: italic">// SUB</span>
                Acc <span style="color: #666666">=</span> Acc <span style="color: #666666">-</span> readInt<span style="color: #666666">(</span>line<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">3:</span> <span style="color: #408080; font-style: italic">// CMP / SKN</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>Acc <span style="color: #666666">&lt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
                    CI <span style="color: #666666">+=</span> <span style="color: #666666">4;</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">7:</span> <span style="color: #408080; font-style: italic">// STP / HLT</span>
                <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_NORMAL</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">default</span><span style="color: #666666">:</span>
                <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BAD_INSTR</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BREAK</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">readInt</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        Byte<span style="color: #666666">[]</span> word <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>line<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">return</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">readInt</span><span style="color: #666666">(</span>word<span style="color: #666666">,</span> Strategy<span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">writeInt</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">,</span> <span style="color: #B00040">int</span> value<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        Byte<span style="color: #666666">[]</span> word <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Byte<span style="color: #666666">[4];</span>
        NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">writeInt</span><span style="color: #666666">(</span>value<span style="color: #666666">,</span> word<span style="color: #666666">,</span> Strategy<span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">);</span>
        memory<span style="color: #666666">.</span><span style="color: #7D9029">writeWord</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> word<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> <span style="color: #0000FF">run</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> currentRunState <span style="color: #666666">=</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BREAK</span><span style="color: #666666">;</span>

        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">(!</span>Thread<span style="color: #666666">.</span><span style="color: #7D9029">currentThread</span><span style="color: #666666">().</span><span style="color: #7D9029">isInterrupted</span><span style="color: #666666">()</span> <span style="color: #666666">&amp;&amp;</span> currentRunState <span style="color: #666666">==</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BREAK</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
                currentRunState <span style="color: #666666">=</span> step<span style="color: #666666">();</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>IllegalArgumentException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>e<span style="color: #666666">.</span><span style="color: #7D9029">getCause</span><span style="color: #666666">()</span> <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">&amp;&amp;</span> e<span style="color: #666666">.</span><span style="color: #7D9029">getCause</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">instanceof</span> IndexOutOfBoundsException<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_ADDR_FALLOUT</span><span style="color: #666666">;</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BAD_INSTR</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>IndexOutOfBoundsException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_ADDR_FALLOUT</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> currentRunState<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pretty short, huh? Method <code>step()</code> and <code>run()</code> return <code>CPU.RunState</code> enum, which is used by emuStudio to determine
if the emulator is still running or in what state it is. The <code>step()</code> method is the most fundamental regarding the
instruction emulation, but it is so easy that we&#8217;ll rather talk about the <code>run()</code> method.</p>
</div>
<div class="paragraph">
<p>The <code>run()</code> method begins with the already described cycle. However, the conditions of determining if the CPU should
be running can look complex at the first sight. However, we are checking just two conditions - if the current run state
has changed (look at the <code>step()</code> method - it can change there), or if the current thread is interrupted. It can
interrupt by external condition, e.g. when somebody quits the emulator during CPU emulation.</p>
</div>
<div class="paragraph">
<p>Then, there are many catches. They are quite required because of many possible situations which can happen - when the
CPU gets to the end of the memory, what it should do? It does nothing, so the memory will throw some variant of
<code>IndexOutOfBoundsException</code>. For this purpose, CPU state contains one which is called <code>STATE_STOPPED_ADDR_FALLOUT</code>,
meaning "address fallout", like if the address "fell out" of allowed range.</p>
</div>
<div class="paragraph">
<p>And the last bad thing which can happen is when the memory at the current instruction position contains some unknown
data, not recognized by CPU. For this situation, we have <code>STATE_STOPPED_BAD_INSTR</code> state.</p>
</div>
<div class="paragraph">
<p>That&#8217;s pretty it. We will now extend the engine to support breakpoints and controlling the speed.</p>
</div>
<div class="sect3">
<h4 id="breakpoints-support">4.8.1. Breakpoints support</h4>
<div class="paragraph">
<p>Since emuStudio is mainly intended for students, as they should get in touch with emulated computers and how they work,
it should allow sometimes to pause the emulation at a point she wants. This capability is also useful when
our program written for the emulated computer does not work and we want to know what happens after executing specific
instruction. We can set a "breakpoint" to that instruction, a flag saying that CPU should pause itself when it
encounters the instruction.</p>
</div>
<div class="paragraph">
<p>Breakpoint is in fact an address - memory location, at which the CPU should pause its execution. It is used only when
CPU is running. Breakpoints are usually stored in a set. The class <code>emulib.plugins.cpu.AbstractCPU</code> has already this
set as a protected member (called <code>breakpoints</code>) and implements all the breakpoints enabling/disabling. What is still
left to do for us is to check if at specific address (current instruction position) the breakpoint is set, and if yes,
somehow "pause" the CPU.</p>
</div>
<div class="paragraph">
<p>We implement this in the <code>run()</code> method, right before instruction execution:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/EmulatorEngine.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EmulatorEngine</span> <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> CPU cpu<span style="color: #666666">;</span>

    EmulatorEngine<span style="color: #666666">(</span>MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">,</span> CPU cpu<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memory</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">cpu</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>cpu<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> <span style="color: #0000FF">run</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">(...)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>cpu<span style="color: #666666">.</span><span style="color: #7D9029">isBreakpointSet</span><span style="color: #666666">(</span>CI<span style="color: #666666">))</span> <span style="color: #666666">{</span>
                    <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BREAK</span><span style="color: #666666">;</span>
                <span style="color: #666666">}</span>
                currentRunState <span style="color: #666666">=</span> step<span style="color: #666666">();</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(...)</span> <span style="color: #666666">{</span>
              <span style="color: #666666">...</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> currentRunState<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the engine requires also the CPU main object, needed for checking if the breakpoint is set at current
instruction location, denoted by the <code>CI</code> register. If the breakpoint is set, the resulting state is <code>STATE_STOPPED_BREAK</code>, and
emuStudio will take care about the pausing and updating the GUI.</p>
</div>
</div>
<div class="sect3">
<h4 id="preserving-the-speed">4.8.2. Preserving the speed</h4>
<div class="paragraph">
<p>Every real computer runs at some speed, usually talking just about only CPU speed. Baby "CPU" could perform about 700
instructions per second. How we should achieve that? The simplest method would be something like that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>run() {
    while (!stopped) {
        start = measureTime();
        ... perform 700 instructions ...
        end = measureTime();

        to_wait = 1.second - (end - start);
        if (to_wait &gt; 0) {
            wait_time(to_wait);
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>So perform 700 instructions, then wait until one second elapses, and go again. What&#8217;s wrong about this solution?
That the algorithm is not "smooth". 700 instructions will be performed at full blast, and then there will be something
like a "break", and the situation will repeat. Real CPU certainly didn&#8217;t work like that and we can do better.</p>
</div>
<div class="paragraph">
<p>If we know how long it takes to execute each instruction, if our host CPU is faster than CPU of SSEM (which is I
suppose :), we can "wait" after each instruction the time difference, so we will artificially slow down to SSEM speed.</p>
</div>
<div class="paragraph">
<p>In reality, every instruction is performed in some number of machine "cycles". We can imagine the machine cycle
as a time of elementary phase when performing the instruction. Based on this information which is
usually available, can be build a technique for preserving speed even better.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Description of the speed-preservation technique can be seen e.g. at
      <a href="http://emustudio.sourceforge.net/downloads/2010-cse.pdf">this link</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I don&#8217;t quite know the speed of particular SSEM instructions, and besides the algorithm is quite complex. More achievable
is a bit different approach, but still quite interesting.</p>
</div>
<div class="paragraph">
<p>Waiting after each instruction requires computing the time difference, checking it and if it is &gt; 0, wait the amount
of time, by calling some Java method. However, we don&#8217;t know how long each instruction will take, but we can estimate
it by measuring.</p>
</div>
<div class="paragraph">
<p>We will execute as many instructions as we can in a second, and by simple math we can then compute how long we should
"wait", in average, so at the end we will execute 700 instructions in a second, in average. Once again, the steps are
as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Measure how many instructions will be executed in 1 second, we will label the number as N.</p>
</li>
<li>
<p>The goal is to achieve 700 instructions per second. It is assumed N &gt; 700. In the first step, we need 1 / N * 700
seconds to pass and we know that 700 instructions will be then executed. We will label this as M = 1 / N * 700. It
will be a constant, after the measurement.</p>
</li>
<li>
<p>Then, we need to wait 1 / M seconds after each instruction, and 700 instructions per second is achieved.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The measurement will not be very accurate, since perfect or almost perfect measuring of method execution in Java has
some rules, like warming up JVM before measurement, etc.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For time measurement it is necessary to use <code>System.nanoTime()</code> method instead of <code>System.currentTimeMillis()</code>.
      The reason is that the latter is corrected time-to-time by operating system because of errors caused by not
      really accurate timer in your computer. Then, the time difference can give invalid values, sometimes even
      negative ones. The <code>System.nanoTime()</code> is not corrected, so time difference works well.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The algorithm will work in the following steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1. Measure average instruction time
2. Compute how much CPU should wait after executing each instruction
3. Wait after each instruction for the computed time</pre>
</div>
</div>
<div class="paragraph">
<p>The third step will be performed only if the time we should wait is greater than zero. It means that the host computer
is faster than Baby computer (which is expected).</p>
</div>
<div class="paragraph">
<p>The algorithm can be implemented as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EmulatorEngine</span> <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">volatile</span> <span style="color: #B00040">long</span> averageInstructionNanos<span style="color: #666666">;</span>

    CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> <span style="color: #0000FF">run</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>averageInstructionNanos <span style="color: #666666">==</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
            measureAverageInstructionNanos<span style="color: #666666">();</span>
        <span style="color: #666666">}</span>
        <span style="color: #B00040">long</span> waitNanos <span style="color: #666666">=</span> TimeUnit<span style="color: #666666">.</span><span style="color: #7D9029">SECONDS</span><span style="color: #666666">.</span><span style="color: #7D9029">toNanos</span><span style="color: #666666">(1)</span> <span style="color: #666666">/</span> averageInstructionNanos<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">(...)</span> <span style="color: #666666">{</span>
            <span style="color: #666666">...</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>waitNanos <span style="color: #666666">&gt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
                LockSupport<span style="color: #666666">.</span><span style="color: #7D9029">parkNanos</span><span style="color: #666666">(</span>waitNanos<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> currentRunState<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Quite simple, so far. We will measure the instruction speed just once, on the first call of the <code>run()</code> method. The
measured value will be reused for later executions and will not slow down the whole emulator.</p>
</div>
<div class="paragraph">
<p>However, how we should measure the average time which is taken by the instruction execution?
Well, if we want to be at least somehow accurate, we should emulate the <code>step()</code> method several times, and then compute
the average. However, we can&#8217;t. The reason is that <code>step()</code> method uses real memory and CPU registers. We should use
kind of "fake" the <code>step()</code> method which will not change the emulator state or memory. But the fake step should implement
instruction with the average "complexity", which we will do just with some estimation or better - feeling. The
algorithm can look as follows (there&#8217;s lot to improve ofcourse):</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/EmulatorEngine.java</code></div>
<div class="content">
<pre>public class EmulatorEngine {
    final static int INSTRUCTIONS_PER_SECOND = 700;
    private final static int MEMORY_CELLS = 32 * 4;
    ...

    private void fakeStep() {
        Byte[] instruction = memory.readWord(CI);

        int line = NumberUtils.reverseBits(instruction[0], 8);
        int opcode = instruction[1] &amp; 3;
        CI = (CI + 4) % MEMORY_CELLS;


        switch (opcode) {
            case 0: break;
            case 1: break;
            case 2: break;
            case 3: break;
            case 4: break;
            case 6: break;
            case 7: break;
        }

        Acc -= memory.read(line % MEMORY_CELLS);
    }


    private void measureAverageInstructionNanos() {
        int oldCI = CI;
        int oldAcc = Acc;

        long start = System.nanoTime();
        for (int i = 0; i &lt; INSTRUCTIONS_PER_SECOND; i++) {
            fakeStep();
        }
        long elapsed = System.nanoTime() - start;

        averageInstructionNanos = elapsed / INSTRUCTIONS_PER_SECOND;

        CI = oldCI;
        Acc = oldAcc;
    }

    ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>At first, we will save the registers (emulator state). Then, we will execute the fake step for 700 times and then
compute the average time. At the end we restore the state, and that&#8217;s it. As you might notice, we tried to use
real things in this "fake" step method like real memory (but just for reading), and emulator registers, which we backed
up and then restored.</p>
</div>
<div class="paragraph">
<p>That&#8217;s about it! If we had disassembler and GUI, the emulator is now ready - we have just implemented the core of the CPU.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="disassembler">4.9. Disassembler</h3>
<div class="paragraph">
<p>Disassembler is not needed for the emulation itself. It is needed for emuStudio to be able to visually show the
instructions. Instructions are encoded in a binary form and reside in memory. Disassembler "disassembles" - decodes the
instructions and transforms them into a string representation which can be easily shown on screen.</p>
</div>
<div class="paragraph">
<p>Decoding binary instructions for disassembler can be a bit different from decoding used in the emulator. For example,
instructions binary code can use constants which can be used directly in the emulator, but which must be translated
in the disassembler. Also, decoding code is usually mixed up with emulator code for performance reasons, so it&#8217;s
hard to reuse it. For these reasons, the programmer often need to implement the decoding part again and duplicate the
work a bit. But not in emuStudio.</p>
</div>
<div class="paragraph">
<p>Fortunately, there exist a project called Edigen (<a href="https://github.com/sulir/edigen" class="bare">https://github.com/sulir/edigen</a>), a disassembler generator. It works
similarly as a parser generator: developer writes a specification file with all the instructions of the CPU. Then, Edigen
(either from the command line or from Maven) generates disassembler and decoder source code, using predefined templates.
These generally do not need any further attention from the developer and can be used right away.</p>
</div>
<div class="paragraph">
<p>SSEM CPU specification file should be put in <code>ssem-cpu/src/main/edigen/cpu.eds</code>, and it looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>ssem-cpu/src/main/edigen/cpu.eds</code></div>
<div class="content">
<pre class="pygments highlight"><code>instruction = "JMP": line(5)     ignore8(8) 000 ignore16(16) |
              "JPR": line(5)     ignore8(8) 100 ignore16(16) |
              "LDN": line(5)     ignore8(8) 010 ignore16(16) |
              "STO": line(5)     ignore8(8) 110 ignore16(16) |
              "SUB": line(5)     ignore8(8) 001 ignore16(16) |
              "CMP": 00000       ignore8(8) 011 ignore16(16) |
              "STP": 00000       ignore8(8) 111 ignore16(16);

line = arg: arg(8);

ignore5 = arg: arg(5);

ignore8 = arg: arg(8);

ignore16 = arg: arg(16);

%%

"%s %X" = instruction line(bit_reverse) ignore8 ignore16;
"%s" = instruction ignore8 ignore16;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The specification file might look a bit cryptic at first sight, but it&#8217;s quite easy. The content is divided into two
sections, separated with two <code>%%</code> chars on a separate line. The first section contains rules which are used for parsing
the instruction binary codes and assign labels to the codes. The second section specifies the disassembled string
formats for particular rules.</p>
</div>
<div class="paragraph">
<p>There can exist multiple rules, and rules can include another rules. If the rule includes the same rule recursively,
it means it&#8217;s a constant. In that case, in the parenthesis after the rule inclusion must be a number of bits
which the constant takes.</p>
</div>
<div class="sect3">
<h4 id="using-generated-disassembler">4.9.1. Using generated disassembler</h4>
<div class="paragraph">
<p>When you look into our <code>pom.xml</code> file, you can find a section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">...
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>edigen<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>edigen-maven-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;decoderName&gt;</span>net.sf.emustudio.ssem.DecoderImpl<span style="color: #008000; font-weight: bold">&lt;/decoderName&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;disassemblerName&gt;</span>net.sf.emustudio.ssem.DisassemblerImpl<span style="color: #008000; font-weight: bold">&lt;/disassemblerName&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;executions&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;execution&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;goals&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;goal&gt;</span>generate<span style="color: #008000; font-weight: bold">&lt;/goal&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/goals&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/execution&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/executions&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The disassembler will be generated in the class <code>net.sf.emustudio.ssem.DisassemblerImpl</code>. The class already implements
the interface <code>emulib.plugins.cpu.Disassembler</code>, which is exactly what method <code>CPU.getDisassembler()</code> returns.
Disassembler is an independent component so it also uses the memory from where it reads the instructions. Therefore,
disassembler can be initialized <em>after</em> the memory. Now we are ready to do full initialization of the emulator, with
the engine as well as disassembler. The code looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">private</span> EmulatorEngine engine<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> Disassembler disasm<span style="color: #666666">;</span>

    <span style="color: #666666">...</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        memory <span style="color: #666666">=</span> contextPool<span style="color: #666666">.</span><span style="color: #7D9029">getMemoryContext</span><span style="color: #666666">(</span>getPluginID<span style="color: #666666">(),</span> MemoryContext<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
        Decoder decoder <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> DecoderImpl<span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
        disasm <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> DisassemblerImpl<span style="color: #666666">(</span>memory<span style="color: #666666">,</span> decoder<span style="color: #666666">);</span>
        engine <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> EmulatorEngine<span style="color: #666666">(</span>memory<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Disassembler <span style="color: #0000FF">getDisassembler</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> disasm<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> RunState <span style="color: #0000FF">call</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">run</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">protected</span> RunState <span style="color: #0000FF">stepInternal</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">step</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">resetInternal</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> startPos<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        engine<span style="color: #666666">.</span><span style="color: #7D9029">reset</span><span style="color: #666666">(</span>startPos<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getInstructionPosition</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">CI</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">setInstructionPosition</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> i<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> memSize <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">getSize</span><span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>i <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span> <span style="color: #666666">||</span> i <span style="color: #666666">&gt;=</span> memSize<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> IllegalArgumentException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Instruction position can be in &lt;0,&quot;</span> <span style="color: #666666">+</span> memSize<span style="color: #666666">/4</span> <span style="color: #666666">+</span><span style="color: #BA2121">&quot;&gt;, but was: &quot;</span> <span style="color: #666666">+</span> i<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        engine<span style="color: #666666">.</span><span style="color: #7D9029">CI</span> <span style="color: #666666">=</span> i<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are approaching the end of our road. The last thing to do is to implement a status panel GUI of the CPU.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="status-panel">4.10. Status panel</h3>
<div class="paragraph">
<p>The status panel is a Java Swing panel (class extending <code>java.swing.JPanel</code>). The GUI can be "drawn" in any favorite
IDE, like NetBeans or IntelliJ IDEA. The status panel should show the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CPU run state</p>
</li>
<li>
<p>Internal state: registers or possibly portion of memory</p>
</li>
<li>
<p>Optionally, speed (running frequency)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The status panel is the interaction point between CPU and the user. With it, the user can be allowed to modify or
view the internal status of the CPU emulator. This is very handy when learning or checking how it works, what the
registers' values really are (and compare them with those shown on a display), etc.</p>
</div>
<div class="paragraph">
<p>SSEM CPU status panel will look as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vbmacher.github.io/emuStudio/docdevel/emulator_tutorial/images//cpu-status-panel.png" alt="SSEM CPU Status panel GUI">
</div>
</div>
<div class="paragraph">
<p>The class code is:</p>
</div>
<div class="listingblock">
<div class="title"><code>ssem-cpu/src/main/java/net/sf/emustudio/ssem/cpu/CpuPanel.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.cpu</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.cpu.CPU</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.MemoryContext</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.NumberUtils</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import static</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.RadixUtils.formatBinaryString</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuPanel</span> <span style="color: #008000; font-weight: bold">extends</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JPanel</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> EmulatorEngine engine<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> Updater updater<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">;</span>

    CpuPanel<span style="color: #666666">(</span>CPU cpu<span style="color: #666666">,</span> EmulatorEngine engine<span style="color: #666666">,</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">engine</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>engine<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memory</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">updater</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Updater<span style="color: #666666">();</span>

        initComponents<span style="color: #666666">();</span>
        cpu<span style="color: #666666">.</span><span style="color: #7D9029">addCPUListener</span><span style="color: #666666">(</span>updater<span style="color: #666666">);</span>
        lblSpeed<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>String<span style="color: #666666">.</span><span style="color: #7D9029">valueOf</span><span style="color: #666666">(</span>EmulatorEngine<span style="color: #666666">.</span><span style="color: #7D9029">INSTRUCTIONS_PER_SECOND</span><span style="color: #666666">));</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Updater</span> <span style="color: #008000; font-weight: bold">implements</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">CPUListener</span> <span style="color: #666666">{</span>

        <span style="color: #AA22FF">@Override</span>
        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">runStateChanged</span><span style="color: #666666">(</span>CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> rs<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            lblRunState<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>rs<span style="color: #666666">.</span><span style="color: #7D9029">toString</span><span style="color: #666666">().</span><span style="color: #7D9029">toUpperCase</span><span style="color: #666666">());</span>
        <span style="color: #666666">}</span>

        <span style="color: #AA22FF">@Override</span>
        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">internalStateChanged</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #B00040">int</span> acc <span style="color: #666666">=</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">Acc</span><span style="color: #666666">;</span>
            <span style="color: #B00040">int</span> ci <span style="color: #666666">=</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">CI</span><span style="color: #666666">;</span>

            Byte<span style="color: #666666">[]</span> mCI <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>ci<span style="color: #666666">);</span>
            <span style="color: #B00040">int</span> line <span style="color: #666666">=</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">reverseBits</span><span style="color: #666666">(</span>mCI<span style="color: #666666">[0],</span> <span style="color: #666666">8);</span>
            Byte<span style="color: #666666">[]</span> mLine <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>line <span style="color: #666666">*</span> <span style="color: #666666">4);</span>

            txtA<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>String<span style="color: #666666">.</span><span style="color: #7D9029">format</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;%08x&quot;</span><span style="color: #666666">,</span> acc<span style="color: #666666">));</span>
            txtCI<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>String<span style="color: #666666">.</span><span style="color: #7D9029">format</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;%08x&quot;</span><span style="color: #666666">,</span> ci <span style="color: #666666">/</span> <span style="color: #666666">4));</span>
            txtMCI<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>String<span style="color: #666666">.</span><span style="color: #7D9029">format</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;%08x&quot;</span><span style="color: #666666">,</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">readInt</span><span style="color: #666666">(</span>mCI<span style="color: #666666">,</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">Strategy</span><span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">)));</span>
            txtLine<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>String<span style="color: #666666">.</span><span style="color: #7D9029">format</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;%02x&quot;</span><span style="color: #666666">,</span> line<span style="color: #666666">));</span>
            txtMLine<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>String<span style="color: #666666">.</span><span style="color: #7D9029">format</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;%08x&quot;</span><span style="color: #666666">,</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">readInt</span><span style="color: #666666">(</span>mLine<span style="color: #666666">,</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">Strategy</span><span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">)));</span>

            txtBinA<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>formatBinary<span style="color: #666666">(</span>acc<span style="color: #666666">));</span>
            txtBinCI<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>formatBinary<span style="color: #666666">(</span>ci<span style="color: #666666">));</span>
            txtBinMCI<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>formatBinary<span style="color: #666666">(</span>NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">readInt</span><span style="color: #666666">(</span>mCI<span style="color: #666666">,</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">Strategy</span><span style="color: #666666">.</span><span style="color: #7D9029">BIG_ENDIAN</span><span style="color: #666666">)));</span>
            txtBinLine<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>formatBinary<span style="color: #666666">(</span>line<span style="color: #666666">,</span> <span style="color: #666666">8));</span>
            txtBinMLine<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span>formatBinary<span style="color: #666666">(</span>NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">readInt</span><span style="color: #666666">(</span>mLine<span style="color: #666666">,</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">Strategy</span><span style="color: #666666">.</span><span style="color: #7D9029">BIG_ENDIAN</span><span style="color: #666666">)));</span>
        <span style="color: #666666">}</span>

        <span style="color: #008000; font-weight: bold">private</span> String <span style="color: #0000FF">formatBinary</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> number<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">return</span> formatBinary<span style="color: #666666">(</span>number<span style="color: #666666">,</span> <span style="color: #666666">32);</span>
        <span style="color: #666666">}</span>

        <span style="color: #008000; font-weight: bold">private</span> String <span style="color: #0000FF">formatBinary</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> number<span style="color: #666666">,</span> <span style="color: #B00040">int</span> length<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">return</span> formatBinaryString<span style="color: #666666">(</span>number<span style="color: #666666">,</span> length<span style="color: #666666">,</span> <span style="color: #666666">4,</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">);</span>
        <span style="color: #666666">}</span>

    <span style="color: #666666">}</span>

    <span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic">     * This method is called from within the constructor to initialize the form.</span>
<span style="color: #408080; font-style: italic">     * WARNING: Do NOT modify this code. The content of this method is always</span>
<span style="color: #408080; font-style: italic">     * regenerated by the Form Editor.</span>
<span style="color: #408080; font-style: italic">     */</span>
    <span style="color: #AA22FF">@SuppressWarnings</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;unchecked&quot;</span><span style="color: #666666">)</span>
    <span style="color: #408080; font-style: italic">// &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;Generated Code&quot;&gt;//GEN-BEGIN:initComponents</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initComponents</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JPanel</span> jPanel1 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JPanel</span><span style="color: #666666">();</span>
        lblRunState <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span> jLabel7 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span><span style="color: #666666">();</span>
        lblSpeed <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JPanel</span> jPanel2 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JPanel</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span> jLabel2 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span> jLabel3 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span><span style="color: #666666">();</span>
        txtCI <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>
        txtA <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>
        txtBinA <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>
        txtBinCI <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JPanel</span> jPanel3 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JPanel</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span> jLabel4 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span> jLabel5 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span><span style="color: #666666">();</span>
        txtMLine <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>
        txtMCI <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>
        txtBinMCI <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>
        txtBinMLine <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>
        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span> jLabel6 <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span><span style="color: #666666">();</span>
        txtLine <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>
        txtBinLine <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">();</span>

        jPanel1<span style="color: #666666">.</span><span style="color: #7D9029">setBorder</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">BorderFactory</span><span style="color: #666666">.</span><span style="color: #7D9029">createTitledBorder</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Run control&quot;</span><span style="color: #666666">));</span>

        lblRunState<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">18));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        lblRunState<span style="color: #666666">.</span><span style="color: #7D9029">setForeground</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Color</span><span style="color: #666666">(0,</span> <span style="color: #666666">153,</span> <span style="color: #666666">0));</span>
        lblRunState<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;BREAKPOINT&quot;</span><span style="color: #666666">);</span>

        jLabel7<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span>jLabel7<span style="color: #666666">.</span><span style="color: #7D9029">getFont</span><span style="color: #666666">().</span><span style="color: #7D9029">deriveFont</span><span style="color: #666666">(</span>jLabel7<span style="color: #666666">.</span><span style="color: #7D9029">getFont</span><span style="color: #666666">().</span><span style="color: #7D9029">getStyle</span><span style="color: #666666">()</span> <span style="color: #666666">|</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">.</span><span style="color: #7D9029">BOLD</span><span style="color: #666666">));</span>
        jLabel7<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;ins/s&quot;</span><span style="color: #666666">);</span>

        lblSpeed<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        lblSpeed<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">);</span>
        lblSpeed<span style="color: #666666">.</span><span style="color: #7D9029">setToolTipText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Speed&quot;</span><span style="color: #666666">);</span>

        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span> jPanel1Layout <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">(</span>jPanel1<span style="color: #666666">);</span>
        jPanel1<span style="color: #666666">.</span><span style="color: #7D9029">setLayout</span><span style="color: #666666">(</span>jPanel1Layout<span style="color: #666666">);</span>
        jPanel1Layout<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalGroup</span><span style="color: #666666">(</span>
            jPanel1Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel1Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>lblRunState<span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>lblSpeed<span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel7<span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">())</span>
        <span style="color: #666666">);</span>
        jPanel1Layout<span style="color: #666666">.</span><span style="color: #7D9029">setVerticalGroup</span><span style="color: #666666">(</span>
            jPanel1Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel1Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel1Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">BASELINE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>lblRunState<span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel7<span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>lblSpeed<span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">))</span>
        <span style="color: #666666">);</span>

        jPanel2<span style="color: #666666">.</span><span style="color: #7D9029">setBorder</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">BorderFactory</span><span style="color: #666666">.</span><span style="color: #7D9029">createTitledBorder</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Registers&quot;</span><span style="color: #666666">));</span>

        jLabel2<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        jLabel2<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;A&quot;</span><span style="color: #666666">);</span>
        jLabel2<span style="color: #666666">.</span><span style="color: #7D9029">setToolTipText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Accumulator&quot;</span><span style="color: #666666">);</span>

        jLabel3<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        jLabel3<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;CI&quot;</span><span style="color: #666666">);</span>
        jLabel3<span style="color: #666666">.</span><span style="color: #7D9029">setToolTipText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Control Instruction&quot;</span><span style="color: #666666">);</span>

        txtCI<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtCI<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtCI<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtCI<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">);</span>

        txtA<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtA<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtA<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtA<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">);</span>

        txtBinA<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtBinA<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtBinA<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtBinA<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0000 0000  0000 0000  0000 0000  0000 0000&quot;</span><span style="color: #666666">);</span>

        txtBinCI<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtBinCI<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtBinCI<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtBinCI<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0000 0000  0000 0000  0000 0000  0000 0000&quot;</span><span style="color: #666666">);</span>

        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span> jPanel2Layout <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">(</span>jPanel2<span style="color: #666666">);</span>
        jPanel2<span style="color: #666666">.</span><span style="color: #7D9029">setLayout</span><span style="color: #666666">(</span>jPanel2Layout<span style="color: #666666">);</span>
        jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalGroup</span><span style="color: #666666">(</span>
            jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGap</span><span style="color: #666666">(47,</span> <span style="color: #666666">47,</span> <span style="color: #666666">47)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel3<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">TRAILING</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel2<span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtA<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">81,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtCI<span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinCI<span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinA<span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">())</span>
        <span style="color: #666666">);</span>
        jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">setVerticalGroup</span><span style="color: #666666">(</span>
            jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">BASELINE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel2<span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtA<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">20,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinA<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel2Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">BASELINE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel3<span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtCI<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinCI<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">))</span>
        <span style="color: #666666">);</span>

        jPanel3<span style="color: #666666">.</span><span style="color: #7D9029">setBorder</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">BorderFactory</span><span style="color: #666666">.</span><span style="color: #7D9029">createTitledBorder</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Memory snippet&quot;</span><span style="color: #666666">));</span>

        jLabel4<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        jLabel4<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;M[CI]&quot;</span><span style="color: #666666">);</span>
        jLabel4<span style="color: #666666">.</span><span style="color: #7D9029">setToolTipText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Control Instruction&quot;</span><span style="color: #666666">);</span>

        jLabel5<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        jLabel5<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;M[line]&quot;</span><span style="color: #666666">);</span>
        jLabel5<span style="color: #666666">.</span><span style="color: #7D9029">setToolTipText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Control Instruction&quot;</span><span style="color: #666666">);</span>

        txtMLine<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtMLine<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtMLine<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtMLine<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">);</span>

        txtMCI<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtMCI<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtMCI<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtMCI<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">);</span>

        txtBinMCI<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtBinMCI<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtBinMCI<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtBinMCI<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0000 0000  0000 0000  0000 0000  0000 0000&quot;</span><span style="color: #666666">);</span>

        txtBinMLine<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtBinMLine<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtBinMLine<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtBinMLine<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0000 0000  0000 0000  0000 0000  0000 0000&quot;</span><span style="color: #666666">);</span>

        jLabel6<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        jLabel6<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;line&quot;</span><span style="color: #666666">);</span>
        jLabel6<span style="color: #666666">.</span><span style="color: #7D9029">setToolTipText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Control Instruction&quot;</span><span style="color: #666666">);</span>

        txtLine<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtLine<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtLine<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtLine<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">);</span>

        txtBinLine<span style="color: #666666">.</span><span style="color: #7D9029">setEditable</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">);</span>
        txtBinLine<span style="color: #666666">.</span><span style="color: #7D9029">setFont</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> java<span style="color: #666666">.</span><span style="color: #7D9029">awt</span><span style="color: #666666">.</span><span style="color: #7D9029">Font</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Monospaced&quot;</span><span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">12));</span> <span style="color: #408080; font-style: italic">// NOI18N</span>
        txtBinLine<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalAlignment</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span><span style="color: #666666">.</span><span style="color: #7D9029">RIGHT</span><span style="color: #666666">);</span>
        txtBinLine<span style="color: #666666">.</span><span style="color: #7D9029">setText</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0000 0000&quot;</span><span style="color: #666666">);</span>

        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span> jPanel3Layout <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">(</span>jPanel3<span style="color: #666666">);</span>
        jPanel3<span style="color: #666666">.</span><span style="color: #7D9029">setLayout</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">);</span>
        jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalGroup</span><span style="color: #666666">(</span>
            jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                        <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel5<span style="color: #666666">)</span>
                        <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                        <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtMLine<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">81,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                        <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                        <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinMLine<span style="color: #666666">))</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                        <span style="color: #666666">.</span><span style="color: #7D9029">addGap</span><span style="color: #666666">(14,</span> <span style="color: #666666">14,</span> <span style="color: #666666">14)</span>
                        <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">TRAILING</span><span style="color: #666666">)</span>
                            <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel6<span style="color: #666666">)</span>
                            <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel4<span style="color: #666666">))</span>
                        <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                        <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
                            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtMCI<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">81,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinMCI<span style="color: #666666">))</span>
                            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtLine<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">81,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinLine<span style="color: #666666">)))))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">())</span>
        <span style="color: #666666">);</span>
        jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">setVerticalGroup</span><span style="color: #666666">(</span>
            jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">BASELINE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel4<span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtMCI<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinMCI<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">BASELINE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel6<span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtLine<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinLine<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>jPanel3Layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">BASELINE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jLabel5<span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtMLine<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>txtBinMLine<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">))</span>
        <span style="color: #666666">);</span>

        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span> layout <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">setLayout</span><span style="color: #666666">(</span>layout<span style="color: #666666">);</span>
        layout<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalGroup</span><span style="color: #666666">(</span>
            layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jPanel2<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jPanel1<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">)</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jPanel3<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">))</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">())</span>
        <span style="color: #666666">);</span>
        layout<span style="color: #666666">.</span><span style="color: #7D9029">setVerticalGroup</span><span style="color: #666666">(</span>
            layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jPanel2<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jPanel3<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addPreferredGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">LayoutStyle</span><span style="color: #666666">.</span><span style="color: #7D9029">ComponentPlacement</span><span style="color: #666666">.</span><span style="color: #7D9029">RELATED</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>jPanel1<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">PREFERRED_SIZE</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">))</span>
        <span style="color: #666666">);</span>
    <span style="color: #666666">}</span><span style="color: #408080; font-style: italic">// &lt;/editor-fold&gt;//GEN-END:initComponents</span>


    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span> lblRunState<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JLabel</span> lblSpeed<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtA<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtBinA<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtBinCI<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtBinLine<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtBinMCI<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtBinMLine<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtCI<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtLine<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtMCI<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JTextField</span> txtMLine<span style="color: #666666">;</span>
    <span style="color: #408080; font-style: italic">// End of variables declaration//GEN-END:variables</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We don&#8217;t have to care about method <code>initComponents()</code> and the fields at the end of the class. Those are generated by
the NetBeans by its GUI designer. I have included it just because the overall look and how the variables - text fields
etc. are named.</p>
</div>
<div class="paragraph">
<p>The only thing which should grasp our attention is the nested <code>Updater</code> class. The class implements the mechanism of
updating values of the GUI. The mechanism is the observer pattern, as you might have recognized. The updater implements
<code>CPU.CPUListener</code> interface, with two methods. The <code>runStateChanged()</code> method is called by the CPU when the run state
has changed. The argument is the new run state. The second method, <code>internalStateChanged()</code> is called by CPU always
when the internal state of a CPU has changed - ie. values of registers. When the CPU is in running state, this method
is not called for performance reasons.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Don&#8217;t forget to register the updater by calling <code>cpu.addCPUListener()</code>. The proper way upon shutting down should
      be to remove it, but the class <code>AbstractCPU</code> will take care about it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we need to incorporate the panel into the main class. It&#8217;s easy:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> JPanel <span style="color: #0000FF">getStatusPanel</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> CpuPanel<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">,</span> engine<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="automatic-emulation">4.11. Automatic emulation</h3>
<div class="paragraph">
<p>The optional step is to change a behavior slightly when user runs the automatic emulation. Why here? Why not in
e.g. CRT display or other plug-in? To answer this question, let&#8217;s think a bit.</p>
</div>
<div class="paragraph">
<p>Automatic emulation exists to suppress interaction with user and perform the whole emulation - from compilation to
running the program - automatically. The important output is usually redirected to a file; so as the required input
is read from file, instead asking the user for it. User then can check the output separately.</p>
</div>
<div class="paragraph">
<p>Usually some terminal input/output is redirected in case of automatic emulation. For example, LSI ADM-3A emulator
redirects input from file <code>adm3a-terminal.in</code> and output to <code>adm3a-terminal.out</code>.</p>
</div>
<div class="paragraph">
<p>But for SSEM - what output is important enough to be put in a file in case of automatic
emulation? Well, the answer is clear - content of the memory, which is not big - just 32 rows. In addition, it will
be useful to see the content of the accumulator and CI register after the emulation finishes. Plug-in which has
easy access to the memory, to the registers and knows the emulation state is CPU. Therefore, we implement the automation
support here.</p>
</div>
<div class="paragraph">
<p>After each emulation "stop" - no matter the reason of stopping, if before the emulation was running, we want to perform
a "snapshot" of the emulator state - registers <code>Acc</code>, <code>CI</code> and memory content. This snapshot will be then written to a
file called <code>ssem.out</code>.</p>
</div>
<div class="paragraph">
<p>At first, let&#8217;s implement the class:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/AutomaticEmulation.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.cpu</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.cpu.CPU</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.MemoryContext</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.NumberUtils</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.RadixUtils</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.slf4j.Logger</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.slf4j.LoggerFactory</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.FileOutputStream</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.IOException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.OutputStream</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.io.PrintWriter</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AutomaticEmulation</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> Logger LOGGER <span style="color: #666666">=</span> LoggerFactory<span style="color: #666666">.</span><span style="color: #7D9029">getLogger</span><span style="color: #666666">(</span>AutomaticEmulation<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> String SSEM_FILE_NAME <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;ssem.out&quot;</span><span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> CPU cpu<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> EmulatorEngine engine<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">CPUListener</span> listener<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">volatile</span> <span style="color: #B00040">boolean</span> waitingForStop <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>

    AutomaticEmulation<span style="color: #666666">(</span>CPU cpu<span style="color: #666666">,</span> EmulatorEngine engine<span style="color: #666666">,</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memory</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">engine</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>engine<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">cpu</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>cpu<span style="color: #666666">);</span>

        listener <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">CPUListener</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">runStateChanged</span><span style="color: #666666">(</span>CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> runState<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>runState <span style="color: #666666">==</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_RUNNING</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    waitingForStop <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
                <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>waitingForStop<span style="color: #666666">)</span> <span style="color: #666666">{</span> <span style="color: #408080; font-style: italic">// runState != STATE_RUNNING</span>
                    waitingForStop <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
                    snapshot<span style="color: #666666">();</span>
                <span style="color: #666666">}</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">internalStateChanged</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

            <span style="color: #666666">}</span>
        <span style="color: #666666">};</span>

        cpu<span style="color: #666666">.</span><span style="color: #7D9029">addCPUListener</span><span style="color: #666666">(</span>listener<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">destroy</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        cpu<span style="color: #666666">.</span><span style="color: #7D9029">removeCPUListener</span><span style="color: #666666">(</span>listener<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">snapshot</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        Byte<span style="color: #666666">[][]</span> memorySnapshot <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Byte<span style="color: #666666">[</span>memory<span style="color: #666666">.</span><span style="color: #7D9029">getSize</span><span style="color: #666666">()</span> <span style="color: #666666">/</span> <span style="color: #666666">4][4];</span>

        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> memorySnapshot<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">;</span> i<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
            Byte<span style="color: #666666">[]</span> word <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>i <span style="color: #666666">*</span> <span style="color: #666666">4);</span>
            System<span style="color: #666666">.</span><span style="color: #7D9029">arraycopy</span><span style="color: #666666">(</span>word<span style="color: #666666">,</span> <span style="color: #666666">0,</span> memorySnapshot<span style="color: #666666">[</span>i<span style="color: #666666">],</span> <span style="color: #666666">0,</span> <span style="color: #666666">4);</span>
        <span style="color: #666666">}</span>

        <span style="color: #B00040">int</span> ciSnapshot <span style="color: #666666">=</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">CI</span><span style="color: #666666">;</span>
        <span style="color: #B00040">int</span> accSnapshot <span style="color: #666666">=</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">Acc</span><span style="color: #666666">;</span>

        saveSnapshot<span style="color: #666666">(</span>ciSnapshot<span style="color: #666666">,</span> accSnapshot<span style="color: #666666">,</span> memorySnapshot<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">saveSnapshot</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> ciSnapshot<span style="color: #666666">,</span> <span style="color: #B00040">int</span> accSnapshot<span style="color: #666666">,</span> Byte<span style="color: #666666">[][]</span> memorySnapshot<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">try</span><span style="color: #666666">(</span>OutputStream out <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> FileOutputStream<span style="color: #666666">(</span>SSEM_FILE_NAME<span style="color: #666666">))</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">try</span><span style="color: #666666">(</span>PrintWriter writer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> PrintWriter<span style="color: #666666">(</span>out<span style="color: #666666">))</span> <span style="color: #666666">{</span>

                writer<span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;ACC=0x&quot;</span> <span style="color: #666666">+</span> Integer<span style="color: #666666">.</span><span style="color: #7D9029">toHexString</span><span style="color: #666666">(</span>accSnapshot<span style="color: #666666">));</span>
                writer<span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;CI=0x&quot;</span> <span style="color: #666666">+</span> Integer<span style="color: #666666">.</span><span style="color: #7D9029">toHexString</span><span style="color: #666666">(</span>ciSnapshot<span style="color: #666666">));</span>
                writer<span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">();</span>

                writer<span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;   L L L L L 5 6 7 8 9 0 1 2 I I I 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1&quot;</span><span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> memorySnapshot<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">;</span> i<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
                    <span style="color: #B00040">int</span> number <span style="color: #666666">=</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">readInt</span><span style="color: #666666">(</span>memorySnapshot<span style="color: #666666">[</span>i<span style="color: #666666">],</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">Strategy</span><span style="color: #666666">.</span><span style="color: #7D9029">BIG_ENDIAN</span><span style="color: #666666">);</span>
                    String binary <span style="color: #666666">=</span> RadixUtils<span style="color: #666666">.</span><span style="color: #7D9029">formatBinaryString</span><span style="color: #666666">(</span>number<span style="color: #666666">,</span> <span style="color: #666666">32,</span> <span style="color: #666666">0,</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">);</span>
                    writer<span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span>String<span style="color: #666666">.</span><span style="color: #7D9029">format</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;%02d %s&quot;</span><span style="color: #666666">,</span> i<span style="color: #666666">,</span> binary<span style="color: #666666">.</span><span style="color: #7D9029">replaceAll</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;0&quot;</span><span style="color: #666666">,</span><span style="color: #BA2121">&quot;  &quot;</span><span style="color: #666666">).</span><span style="color: #7D9029">replaceAll</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;1&quot;</span><span style="color: #666666">,</span><span style="color: #BA2121">&quot;* &quot;</span><span style="color: #666666">)));</span>
                <span style="color: #666666">}</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>IOException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">error</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;Could not snapshot SSEM state&quot;</span><span style="color: #666666">,</span> e<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, the class should be incorporated to the main class:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>

    <span style="color: #008000; font-weight: bold">private</span> Optional<span style="color: #666666">&lt;</span>AutomaticEmulation<span style="color: #666666">&gt;</span> automaticEmulation <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">empty</span><span style="color: #666666">();</span>

    <span style="color: #666666">...</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        <span style="color: #666666">...</span>

        <span style="color: #B00040">boolean</span> auto <span style="color: #666666">=</span> Boolean<span style="color: #666666">.</span><span style="color: #7D9029">parseBoolean</span><span style="color: #666666">(</span>settingsManager<span style="color: #666666">.</span><span style="color: #7D9029">readSetting</span><span style="color: #666666">(</span>getPluginID<span style="color: #666666">(),</span> SettingsManager<span style="color: #666666">.</span><span style="color: #7D9029">AUTO</span><span style="color: #666666">));</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>auto<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            automaticEmulation <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">of</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> AutomaticEmulation<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">,</span> engine<span style="color: #666666">,</span> memory<span style="color: #666666">));</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it. If we run the emulator with the command line:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>java -jar emuStudio.jar --config SSEM --nogui --auto --input examples/as-ssem/the-fraj.ssem</pre>
</div>
</div>
<div class="paragraph">
<p>the emulation will run without user interaction, and file <code>ssem.out</code> will be created with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ACC=0x0
CI=0x8

   L L L L L 5 6 7 8 9 0 1 2 I I I 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
00
01 * * *   *                   *                         * * *   *
02   *
03   * *   *                     *
04   *     *                 * *
05   *     *                   *
06   *     *                     *
07 * * *   *                 * *
08 *                           *
09   *     *                 * *
10   *     *                   *
11     *   *                     *
12                             * *
13 * *     *                   *
14 *                         * *
15 *   *   *                     *
16 * * *                     * *
17
18
19 *     *   * * * * * * * * *   * * * * * * * * * * * *       *
20 * * * * * * * * * * * * * * * * * * * * * * * * * * *   * * * *
21                           * * * * * * * * * * * * * * * * * * *
22 *
23   * * *   *   *   * * *   * * *   * * *       * *     * * * *
24     *     *   *   *       *       *     *   *     *       *
25     *     *   *   *       *       *     *   *     *       *
26     *     * * *   * *     * *     * * *     * * * *       *
27     *     * * *   * *     * *     * * *     * * * *       *
28     *     *   *   *       *       *   *     *     *       *
29     *     *   *   *       *       *     *   *     *   *   *
30     *     *   *   * * *   *       *     *   *     *     *
31</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing-4">4.12. Testing</h3>
<div class="paragraph">
<p>Now you have implemented complete CPU emulator. It should work. Should. But how do we now until we try? Every program
can have bugs. And most likely it does. It is crucial for CPU emulator to work literally exactly as the real CPU. With
little playing we can&#8217;t test all instructions, all their variants and check all possible inputs. This must be done
systematically.</p>
</div>
<div class="paragraph">
<p>In languages which have mutable state ("inpure languages"), like Java, it is quite hard to reason about the correctness.
There are some ways, but instead of formal reasoning became very popular a technique called automated testing. There
exist several levels of automated tests. Those which are usually placed very close to the source code of the project,
and which tests a single "unit" - the smallest entity - are called unit tests.</p>
</div>
<div class="paragraph">
<p>In object oriented languages, unit tests should test production classes and their behavior in the isolated
environment. Each unit test is also a class. Maven uses standard path where the unit tests should be put.</p>
</div>
<div class="paragraph">
<p>Testing of SSEM CPU is left as an exercise for the plug-in developer.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="DEVICE_HOWTO">5. Writing a Device</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial will describe how to implement a virtual device to be used in emuStudio. The tutorial
will focus on implementing simple CRT display for SSEM computer.
The main focus is put on how to use emuLib API in a virtual device project so it can be used in emuStudio.</p>
</div>
<div class="sect2">
<h3 id="DEVICE_GETTING_STARTED">5.1. Getting started</h3>
<div class="paragraph">
<p>Before reading on, please read the <a href="#INTRODUCTION_PLUGINS">Introduction</a> chapter. It gives the information
needed for setting up the development environment and for basic understanding how the emuStudio/plug-ins lifecycle
work.</p>
</div>
<div class="paragraph">
<p>In this tutorial we will implement a CRT display for our SSEM computer. It will not completely mimic the real
"monitor" interface with switches and everything, but it will just display the content of the memory. There exist
several good sources about how the real monitor looked like; and with many additional details - just to mention
few:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.rogerdavies.com/2009/12/manchester-ssem-baby/">Roger Davies nice article about SSEM</a></p>
</li>
<li>
<p><a href="http://www.cs.ubc.ca/~hilpert/e/SSEM/index.html">Brent Hilpert page about SSEM, including emulator</a></p>
</li>
<li>
<p><a href="http://www.davidsharp.com/baby/">David Sharp page about SSEM, including emulator</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As we know from <a href="#MEMORY_HOWTO">Writing a memory</a>, SSEM memory is in fact a 32x32 grid of bits. A memory cell has 4 bytes = 32 bits. So
we have 32 rows or memory cells in the memory, each of size 4 bytes.</p>
</div>
<div class="paragraph">
<p>Next, the number stored in memory is "reversed" when compared to current x86 numbers representation in memory. It means,
that LSB and MSB were switched. What&#8217;s more, SSEM used two&#8217;s complement to represent negative numbers.</p>
</div>
<div class="paragraph">
<p>With that information, we are able to create the display. For the simplicity, the display will be just a black canvas
with the grid of squares - bits - filled with different color - based on whether the corresponding bit is 1 or 0.</p>
</div>
<div class="paragraph">
<p>The display should be able to "listen" for memory changes and re-paint itself to be up to date with the current state
of the SSEM memory.</p>
</div>
<div class="paragraph">
<p>Besides displaying, there will be no other interaction from user.</p>
</div>
</div>
<div class="sect2">
<h3 id="preparing-the-environment-4">5.2. Preparing the environment</h3>
<div class="paragraph">
<p>In order to start developing the device, create new Java project. Here, Maven will be used for dependencies management.
The plug-in will be implemented as another standard emuStudio plug-in, so it will inherit Maven plug-in dependencies
from the main POM file.</p>
</div>
<div class="paragraph">
<p>The project should be located at <code>emuStudio/plugins/devices/ssem-display</code>, and should contain the following structure:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>src/
  main/
    java/
    resources/
test/
  java/
pom.xml</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note the naming of the plug-in. It follows the naming convention as described in the <a href="#INTRODUCTION_NAMING">Naming conventions</a>
      guide.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The POM file of the project might look as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>ssem-display/pom.xml</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span style="color: #008000; font-weight: bold">&lt;project</span> <span style="color: #7D9029">xmlns=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span style="color: #7D9029">xmlns:xsi=</span><span style="color: #BA2121">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span style="color: #7D9029">xsi:schemaLocation=</span><span style="color: #BA2121">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;modelVersion&gt;</span>4.0.0<span style="color: #008000; font-weight: bold">&lt;/modelVersion&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;parent&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emustudio-parent<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;version&gt;</span>0.39<span style="color: #008000; font-weight: bold">&lt;/version&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;relativePath&gt;</span>../../..<span style="color: #008000; font-weight: bold">&lt;/relativePath&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/parent&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>ssem-display<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;packaging&gt;</span>jar<span style="color: #008000; font-weight: bold">&lt;/packaging&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;name&gt;</span>SSEM CRT Display<span style="color: #008000; font-weight: bold">&lt;/name&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;description&gt;</span>CRT Display for SSEM computer<span style="color: #008000; font-weight: bold">&lt;/description&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;build&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;finalName&gt;</span>ssem-display<span style="color: #008000; font-weight: bold">&lt;/finalName&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;plugins&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-jar-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;archive&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;manifest&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addClasspath&gt;</span>false<span style="color: #008000; font-weight: bold">&lt;/addClasspath&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultImplementationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultImplementationEntries&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;addDefaultSpecificationEntries&gt;</span>true<span style="color: #008000; font-weight: bold">&lt;/addDefaultSpecificationEntries&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/manifest&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/archive&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>maven-dependency-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/plugins&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/build&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;dependencies&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.slf4j<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>slf4j-api<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>net.sf.emustudio<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>emuLib<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>junit<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;dependency&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.easymock<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>easymock<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/dependency&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/dependencies&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s start with the first Java class, the main plug-in class. Let&#8217;s put it to package
<code>net.sf.emustudio.ssem.display</code>, and call it <code>DisplaySSEM</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="DEVICE_MAIN_CLASS">5.3. The main class</h3>
<div class="paragraph">
<p>Go to the <code>DeviceSSEM</code> class source. Extend the class from <code>emulib.plugins.devices.AbstractDevice</code> class.
The abstract class extends from <code>emulib.plugins.devices.Device</code> interface and implements the most common methods,
usable by all devices.</p>
</div>
<div class="paragraph">
<p>It is also necessary to annotate the class with <code>emulib.annotations.PluginType</code> annotation, which is required for every
main class of any emuStudio plug-in. The code snippet looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/display/DisplaySSEM.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.display</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PLUGIN_TYPE</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PluginType</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.AbstractDevice</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.ContextPool</span><span style="color: #666666">;</span>

<span style="color: #AA22FF">@PluginType</span><span style="color: #666666">(</span>
        type <span style="color: #666666">=</span> PLUGIN_TYPE<span style="color: #666666">.</span><span style="color: #7D9029">DEVICE</span><span style="color: #666666">,</span>
        title <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;SSEM CRT display&quot;</span><span style="color: #666666">,</span>
        copyright <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;\u00A9 Copyright 2006-2017, Peter Jakubo&quot;</span><span style="color: #666666">,</span>
        description <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;CRT display for SSEM computer.&quot;</span>
<span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">DisplaySSEM</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractDevice <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> Logger LOGGER <span style="color: #666666">=</span> LoggerFactory<span style="color: #666666">.</span><span style="color: #7D9029">getLogger</span><span style="color: #666666">(</span>DisplaySSEM<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">DisplaySSEM</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #408080; font-style: italic">// ... other methods ...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The constructor presented here is mandatory. This is one of the behavioral contracts, emuStudio expects
      that a plug-in will have a constructor with two arguments: <code>pluginID</code> (assigned by emuStudio), and a context
      pool, which is a storage or registrar of all plug-ins contexts.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the initialization phase (see <a href="#INTRODUCTION_INITIALIZATION">Phase 2 - Initialization</a>), we need to obtain SSEM memory, which will be used
as the source of information which bits are "turned on":</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/display/DisplaySSEM.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">DisplaySSEM</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractDevice <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> ContextPool contextPool<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">DisplaySSEM</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">contextPool</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>contextPool<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settings<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">initialize</span><span style="color: #666666">(</span>settings<span style="color: #666666">);</span>
        MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory <span style="color: #666666">=</span> contextPool<span style="color: #666666">.</span><span style="color: #7D9029">getMemoryContext</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">,</span> MemoryContext<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>memory<span style="color: #666666">.</span><span style="color: #7D9029">getDataType</span><span style="color: #666666">()</span> <span style="color: #666666">!=</span> Byte<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> PluginInitializationException<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Expected Byte memory cell type!&quot;</span><span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">showSettings</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #408080; font-style: italic">// we don&#39;t have settings GUI</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isShowSettingsSupported</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">showGUI</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #408080; font-style: italic">// TODO!</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At first - notice that in the constructor we are not registering any device context. It means that the device does not
provide any interaction with other plug-ins. It is however possible to do it as for any other plug-in.</p>
</div>
<div class="paragraph">
<p>However, it is not the case the opposite way - the device can (and must) use memory to obtain its contents. It is
very possible to get the memory context from the context pool. This is done in the initialization phase, so it is clear
that <code>contextPool</code> is loaded with all available contexts from other plug-ins.</p>
</div>
<div class="paragraph">
<p>It is a good practice to check whether the data type of the memory cells is as we expect; unfortunately in Java the
generics information does not differentiate a type so we need to do it manually.</p>
</div>
<div class="paragraph">
<p>Now notice there are two methods dealing with GUI. The first one is <code>showGUI()</code> and the second one is <code>showSettings()</code>,
which creates a pair with <code>isShowSettingsSupported()</code>. In emuStudio, each device plug-in can have a "main GUI window",
which is used primarily for the interaction with user. On the other hand, as it could be noticed in other plug-in types,
each plug-in can have its own "settings" window, which shows specific settings of a plug-in. It is also the case for
the device plug-ins.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-gui">5.4. The GUI</h3>
<div class="paragraph">
<p>We are nowon the best way to implement the GUI of the dislpay. As it was the case for the SSEM memory GUI, the display
will also use a <code>javax.swing.JDialog</code> window for displaying the GUI. Next, the window will contain the canvas - a
<code>javax.swing.JPanel</code> - which will paint the grid with the squares. In order to do that, we need to create our own
version of <code>JPanel</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For better description about how painting of Swing components works, please see
      <a href="https://docs.oracle.com/javase/tutorial/uiswing/painting/index.html">this tutorial</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before that, let&#8217;s show how we want the result to look like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vbmacher.github.io/emuStudio/docdevel/emulator_tutorial/images//ssem-display.png" alt="SSEM Display GUI sample look">
</div>
</div>
<div class="sect3">
<h4 id="display-panel">5.4.1. Display panel</h4>
<div class="paragraph">
<p>And now we are ready for the source code of the <code>DisplayPanel</code>:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/display/DisplayPanel.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.display</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.NumberUtils</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">net.jcip.annotations.ThreadSafe</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JPanel</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.Color</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.Dimension</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.awt.Graphics</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.stream.Collectors</span><span style="color: #666666">;</span>

<span style="color: #AA22FF">@ThreadSafe</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">DisplayPanel</span> <span style="color: #008000; font-weight: bold">extends</span> JPanel <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">int</span> PIXEL_SIZE <span style="color: #666666">=</span> <span style="color: #666666">10;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">int</span> PIXEL_SIZE_PLUS_GAP <span style="color: #666666">=</span> PIXEL_SIZE <span style="color: #666666">+</span> <span style="color: #666666">2;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">int</span> CELL_SIZE <span style="color: #666666">=</span> <span style="color: #666666">32;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">int</span> ROWS <span style="color: #666666">=</span> <span style="color: #666666">32;</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> <span style="color: #B00040">boolean</span><span style="color: #666666">[][]</span> memory <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #B00040">boolean</span><span style="color: #666666">[</span>CELL_SIZE<span style="color: #666666">][</span>CELL_SIZE<span style="color: #666666">];</span>

    DisplayPanel<span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setBackground</span><span style="color: #666666">(</span>Color<span style="color: #666666">.</span><span style="color: #7D9029">BLACK</span><span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setDoubleBuffered</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">writeRow</span><span style="color: #666666">(</span>Byte<span style="color: #666666">[]</span> value<span style="color: #666666">,</span> <span style="color: #B00040">int</span> row<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> number <span style="color: #666666">=</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">readInt</span><span style="color: #666666">(</span>value<span style="color: #666666">,</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">Strategy</span><span style="color: #666666">.</span><span style="color: #7D9029">BIG_ENDIAN</span><span style="color: #666666">);</span>
        Boolean<span style="color: #666666">[]</span> bits <span style="color: #666666">=</span> String<span style="color: #666666">.</span><span style="color: #7D9029">format</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;%&quot;</span> <span style="color: #666666">+</span> CELL_SIZE <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;s&quot;</span><span style="color: #666666">,</span> Integer<span style="color: #666666">.</span><span style="color: #7D9029">toBinaryString</span><span style="color: #666666">(</span>number<span style="color: #666666">)).</span><span style="color: #7D9029">chars</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">mapToObj</span><span style="color: #666666">(</span>c <span style="color: #666666">-&gt;</span> c <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;1&#39;</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">collect</span><span style="color: #666666">(</span>Collectors<span style="color: #666666">.</span><span style="color: #7D9029">toList</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">toArray</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Boolean<span style="color: #666666">[0]);</span>

        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> ROWS<span style="color: #666666">;</span> i<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
            memory<span style="color: #666666">[</span>row<span style="color: #666666">][</span>i<span style="color: #666666">]</span> <span style="color: #666666">=</span> bits<span style="color: #666666">[</span>i<span style="color: #666666">];</span>
        <span style="color: #666666">}</span>
        repaint<span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">clear</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">boolean</span><span style="color: #666666">[]</span> memoryRow <span style="color: #666666">:</span> memory<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> j <span style="color: #666666">=</span> <span style="color: #666666">0;</span> j <span style="color: #666666">&lt;</span> memoryRow<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">;</span> j<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
                memoryRow<span style="color: #666666">[</span>j<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        repaint<span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

     <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">paintComponent</span><span style="color: #666666">(</span>Graphics g<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        Dimension size <span style="color: #666666">=</span> getSize<span style="color: #666666">();</span>
        <span style="color: #B00040">int</span> startX <span style="color: #666666">=</span> size<span style="color: #666666">.</span><span style="color: #7D9029">width</span> <span style="color: #666666">/</span> <span style="color: #666666">2</span> <span style="color: #666666">-</span> <span style="color: #666666">(</span>CELL_SIZE <span style="color: #666666">/</span> <span style="color: #666666">2)</span> <span style="color: #666666">*</span> PIXEL_SIZE_PLUS_GAP <span style="color: #666666">-</span> PIXEL_SIZE<span style="color: #666666">;</span>
        <span style="color: #B00040">int</span> startY <span style="color: #666666">=</span> size<span style="color: #666666">.</span><span style="color: #7D9029">height</span> <span style="color: #666666">/</span> <span style="color: #666666">2</span> <span style="color: #666666">-</span> <span style="color: #666666">(</span>ROWS <span style="color: #666666">/</span> <span style="color: #666666">2)</span> <span style="color: #666666">*</span> PIXEL_SIZE_PLUS_GAP<span style="color: #666666">;</span>

        g<span style="color: #666666">.</span><span style="color: #7D9029">setColor</span><span style="color: #666666">(</span>Color<span style="color: #666666">.</span><span style="color: #7D9029">BLACK</span><span style="color: #666666">);</span>
        g<span style="color: #666666">.</span><span style="color: #7D9029">fillRect</span><span style="color: #666666">(0,</span> <span style="color: #666666">0,</span> size<span style="color: #666666">.</span><span style="color: #7D9029">width</span><span style="color: #666666">,</span> size<span style="color: #666666">.</span><span style="color: #7D9029">height</span><span style="color: #666666">);</span>

        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">length</span><span style="color: #666666">;</span> i<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> j <span style="color: #666666">=</span> <span style="color: #666666">0;</span> j <span style="color: #666666">&lt;</span> memory<span style="color: #666666">[</span>i<span style="color: #666666">].</span><span style="color: #7D9029">length</span><span style="color: #666666">;</span> j<span style="color: #666666">++)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>memory<span style="color: #666666">[</span>i<span style="color: #666666">][</span>j<span style="color: #666666">])</span> <span style="color: #666666">{</span>
                  g<span style="color: #666666">.</span><span style="color: #7D9029">setColor</span><span style="color: #666666">(</span>Color<span style="color: #666666">.</span><span style="color: #7D9029">GREEN</span><span style="color: #666666">);</span>
                  g<span style="color: #666666">.</span><span style="color: #7D9029">fillRect</span><span style="color: #666666">(</span>
                          startX <span style="color: #666666">+</span> j <span style="color: #666666">*</span> PIXEL_SIZE_PLUS_GAP<span style="color: #666666">,</span>
                          startY <span style="color: #666666">+</span> i <span style="color: #666666">*</span> PIXEL_SIZE_PLUS_GAP<span style="color: #666666">,</span>
                          PIXEL_SIZE<span style="color: #666666">,</span>
                          PIXEL_SIZE
                  <span style="color: #666666">);</span>
                <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
                  g<span style="color: #666666">.</span><span style="color: #7D9029">setColor</span><span style="color: #666666">(</span>Color<span style="color: #666666">.</span><span style="color: #7D9029">DARK_GRAY</span><span style="color: #666666">);</span>
                  g<span style="color: #666666">.</span><span style="color: #7D9029">fillRect</span><span style="color: #666666">(</span>
                          startX <span style="color: #666666">+</span> j <span style="color: #666666">*</span> PIXEL_SIZE_PLUS_GAP<span style="color: #666666">,</span>
                          startY <span style="color: #666666">+</span> i <span style="color: #666666">*</span> PIXEL_SIZE_PLUS_GAP<span style="color: #666666">,</span>
                          PIXEL_SIZE<span style="color: #666666">,</span>
                          PIXEL_SIZE
                  <span style="color: #666666">);</span>
                <span style="color: #666666">}</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At first, notice that the display panel has its own memory - we can call it "video memory". It is absolutely not
related to the real hardware, becasuse SSEM didn&#8217;t have this thing. I decided to introduce the video memory because
when painting, which will occur in UI thread - and often!, don&#8217;t have to interact with the real SSEM memory,
accessed also by the CPU, in emulation thread. So painting method - the <code>paintComponent()</code> - is using this
vide memory to ask whether the bit - or the square - should be green or black, based on whether the memory bit is 1
or 0. Also this fact - bit representation in video memory - is a bit different. Instead of numbers 1 or 0 we store
booleans, which better corresponds to a two-value options.</p>
</div>
<div class="paragraph">
<p>Except the <code>paintComponent()</code>, we can see there to be a <code>writeRow()</code> and <code>clear()</code> methods. The <code>writeRow()</code> method
will be called by a memory listener, which is not now defined. The idea is that when a byte in the SSEM memory changes,
the listener will be notified about the change, which will call the <code>writeRow</code> as the consequence.</p>
</div>
<div class="paragraph">
<p>It means that we will update the whole row - memory cell - even if only part of it had changed. The decision about this
detail is simplicity, the performance can be improved if we update only specific bits.</p>
</div>
<div class="paragraph">
<p>Method <code>clear()</code> will erase the video memory.</p>
</div>
</div>
<div class="sect3">
<h4 id="gui-window">5.4.2. GUI window</h4>
<div class="paragraph">
<p>As it was said already, we need to implement a <code>JDialog</code> which will contain the display panel. The source code
for the dialog is as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/display/DisplayDialog.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.display</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.Memory</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.MemoryContext</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">javax.swing.JDialog</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">DisplayDialog</span> <span style="color: #008000; font-weight: bold">extends</span> JDialog <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> DisplayPanel displayPanel<span style="color: #666666">;</span>

    DisplayDialog<span style="color: #666666">(</span>MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memory</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">displayPanel</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> DisplayPanel<span style="color: #666666">();</span>

        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">setLocationRelativeTo</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">);</span>
        initComponents<span style="color: #666666">();</span>

        scrollPane<span style="color: #666666">.</span><span style="color: #7D9029">setViewportView</span><span style="color: #666666">(</span>displayPanel<span style="color: #666666">);</span>

        initListener<span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initListener</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        memory<span style="color: #666666">.</span><span style="color: #7D9029">addMemoryListener</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Memory<span style="color: #666666">.</span><span style="color: #7D9029">MemoryListener</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">memoryChanged</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> bytePosition<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>bytePosition <span style="color: #666666">==</span> <span style="color: #666666">-1)</span> <span style="color: #666666">{</span>
                    reset<span style="color: #666666">();</span>
                <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
                    <span style="color: #B00040">int</span> row <span style="color: #666666">=</span> bytePosition <span style="color: #666666">/</span> <span style="color: #666666">4;</span>
                    displayPanel<span style="color: #666666">.</span><span style="color: #7D9029">writeRow</span><span style="color: #666666">(</span>memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>row <span style="color: #666666">*</span> <span style="color: #666666">4),</span> row<span style="color: #666666">);</span>
                <span style="color: #666666">}</span>
            <span style="color: #666666">}</span>

            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">memorySizeChanged</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
                <span style="color: #408080; font-style: italic">// never happens</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">});</span>
    <span style="color: #666666">}</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">reset</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        displayPanel<span style="color: #666666">.</span><span style="color: #7D9029">clear</span><span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span><span style="color: #B00040">int</span> i <span style="color: #666666">=</span> <span style="color: #666666">0;</span> i <span style="color: #666666">&lt;</span> <span style="color: #666666">4</span> <span style="color: #666666">*</span> <span style="color: #666666">32;</span> i <span style="color: #666666">+=</span> <span style="color: #666666">4)</span> <span style="color: #666666">{</span>
            displayPanel<span style="color: #666666">.</span><span style="color: #7D9029">writeRow</span><span style="color: #666666">(</span>memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>i<span style="color: #666666">),</span> i <span style="color: #666666">/</span> <span style="color: #666666">4);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic">     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The</span>
<span style="color: #408080; font-style: italic">     * content of this method is always regenerated by the Form Editor.</span>
<span style="color: #408080; font-style: italic">     */</span>
    <span style="color: #AA22FF">@SuppressWarnings</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;unchecked&quot;</span><span style="color: #666666">)</span>
    <span style="color: #408080; font-style: italic">// &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;Generated Code&quot;&gt;//GEN-BEGIN:initComponents</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initComponents</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

        scrollPane <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JScrollPane</span><span style="color: #666666">();</span>

        setDefaultCloseOperation<span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">WindowConstants</span><span style="color: #666666">.</span><span style="color: #7D9029">DISPOSE_ON_CLOSE</span><span style="color: #666666">);</span>
        setTitle<span style="color: #666666">(</span><span style="color: #BA2121">&quot;SSEM CRT Display&quot;</span><span style="color: #666666">);</span>

        javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span> layout <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">(</span>getContentPane<span style="color: #666666">());</span>
        getContentPane<span style="color: #666666">().</span><span style="color: #7D9029">setLayout</span><span style="color: #666666">(</span>layout<span style="color: #666666">);</span>
        layout<span style="color: #666666">.</span><span style="color: #7D9029">setHorizontalGroup</span><span style="color: #666666">(</span>
            layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>scrollPane<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">432,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">())</span>
        <span style="color: #666666">);</span>
        layout<span style="color: #666666">.</span><span style="color: #7D9029">setVerticalGroup</span><span style="color: #666666">(</span>
            layout<span style="color: #666666">.</span><span style="color: #7D9029">createParallelGroup</span><span style="color: #666666">(</span>javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">Alignment</span><span style="color: #666666">.</span><span style="color: #7D9029">LEADING</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">addGroup</span><span style="color: #666666">(</span>layout<span style="color: #666666">.</span><span style="color: #7D9029">createSequentialGroup</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addComponent</span><span style="color: #666666">(</span>scrollPane<span style="color: #666666">,</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">GroupLayout</span><span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_SIZE</span><span style="color: #666666">,</span> <span style="color: #666666">416,</span> Short<span style="color: #666666">.</span><span style="color: #7D9029">MAX_VALUE</span><span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">addContainerGap</span><span style="color: #666666">())</span>
        <span style="color: #666666">);</span>

        pack<span style="color: #666666">();</span>
    <span style="color: #666666">}</span><span style="color: #408080; font-style: italic">// &lt;/editor-fold&gt;//GEN-END:initComponents</span>


    <span style="color: #408080; font-style: italic">// Variables declaration - do not modify//GEN-BEGIN:variables</span>
    <span style="color: #008000; font-weight: bold">private</span> javax<span style="color: #666666">.</span><span style="color: #7D9029">swing</span><span style="color: #666666">.</span><span style="color: #7D9029">JScrollPane</span> scrollPane<span style="color: #666666">;</span>
    <span style="color: #408080; font-style: italic">// End of variables declaration//GEN-END:variables</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the constructor you can notice that we add the memory listener to the memory which is responsible for updating
the display, as was explained in the previous section.</p>
</div>
<div class="paragraph">
<p>Also, the interesting method is <code>reset()</code>, which causes to at first - clearing the display and then loading it with
new content - by copying the whole memory into the video memory of the display.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wrapping-up">5.5. Wrapping up</h3>
<div class="paragraph">
<p>The last step is to finish the main class. We need to include and show the display when emuStudio asks for it:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/display/DisplaySSEM.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">package</span> <span style="color: #0000FF; font-weight: bold">net.sf.emustudio.ssem.display</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PLUGIN_TYPE</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.annotations.PluginType</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.emustudio.SettingsManager</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.device.AbstractDevice</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.plugins.memory.MemoryContext</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.ContextPool</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">emulib.runtime.exceptions.PluginInitializationException</span><span style="color: #666666">;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.MissingResourceException</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Objects</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.Optional</span><span style="color: #666666">;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">java.util.ResourceBundle</span><span style="color: #666666">;</span>

<span style="color: #AA22FF">@PluginType</span><span style="color: #666666">(</span>
        type <span style="color: #666666">=</span> PLUGIN_TYPE<span style="color: #666666">.</span><span style="color: #7D9029">DEVICE</span><span style="color: #666666">,</span>
        title <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;SSEM CRT display&quot;</span><span style="color: #666666">,</span>
        copyright <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;\u00A9 Copyright 2006-2017, Peter Jakubo&quot;</span><span style="color: #666666">,</span>
        description <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;CRT display for SSEM computer.&quot;</span>
<span style="color: #666666">)</span>
<span style="color: #AA22FF">@SuppressWarnings</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;unused&quot;</span><span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">DisplaySSEM</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractDevice <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">boolean</span> nogui<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> ContextPool contextPool<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> Optional<span style="color: #666666">&lt;</span>DisplayDialog<span style="color: #666666">&gt;</span> display <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">empty</span><span style="color: #666666">();</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">DisplaySSEM</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">contextPool</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>contextPool<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getVersion</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
            ResourceBundle bundle <span style="color: #666666">=</span> ResourceBundle<span style="color: #666666">.</span><span style="color: #7D9029">getBundle</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;net.sf.emustudio.ssem.display.version&quot;</span><span style="color: #666666">);</span>
            <span style="color: #008000; font-weight: bold">return</span> bundle<span style="color: #666666">.</span><span style="color: #7D9029">getString</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;version&quot;</span><span style="color: #666666">);</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>MissingResourceException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;(unknown)&quot;</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settings<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span><span style="color: #7D9029">initialize</span><span style="color: #666666">(</span>settings<span style="color: #666666">);</span>
        MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory <span style="color: #666666">=</span> contextPool<span style="color: #666666">.</span><span style="color: #7D9029">getMemoryContext</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">,</span> MemoryContext<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>memory<span style="color: #666666">.</span><span style="color: #7D9029">getDataType</span><span style="color: #666666">()</span> <span style="color: #666666">!=</span> Byte<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> PluginInitializationException<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Expected Byte memory cell type!&quot;</span><span style="color: #666666">);</span>
        <span style="color: #666666">}</span>

        String s <span style="color: #666666">=</span> settings<span style="color: #666666">.</span><span style="color: #7D9029">readSetting</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">,</span> SettingsManager<span style="color: #666666">.</span><span style="color: #7D9029">NO_GUI</span><span style="color: #666666">);</span>
        nogui <span style="color: #666666">=</span> <span style="color: #666666">(</span>s <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">&amp;&amp;</span> s<span style="color: #666666">.</span><span style="color: #7D9029">toUpperCase</span><span style="color: #666666">().</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;TRUE&quot;</span><span style="color: #666666">);</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(!</span>nogui<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            display <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">of</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> DisplayDialog<span style="color: #666666">(</span>memory<span style="color: #666666">));</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">reset</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        display<span style="color: #666666">.</span><span style="color: #7D9029">ifPresent</span><span style="color: #666666">(</span>DisplayDialog<span style="color: #666666">::</span>reset<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">destroy</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        display<span style="color: #666666">.</span><span style="color: #7D9029">ifPresent</span><span style="color: #666666">(</span>DisplayDialog<span style="color: #666666">::</span>dispose<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">showGUI</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        display<span style="color: #666666">.</span><span style="color: #7D9029">ifPresent</span><span style="color: #666666">(</span>displayDialog <span style="color: #666666">-&gt;</span> displayDialog<span style="color: #666666">.</span><span style="color: #7D9029">setVisible</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">));</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">showSettings</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #408080; font-style: italic">// we don&#39;t have settings GUI</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">isShowSettingsSupported</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the method <code>initialize()</code> - we added a check whether we are in a no-GUI mode. If yes, we should ignore
all requests for showing the GUI. Otherwise, we will create the display GUI right away, and only once.</p>
</div>
<div class="paragraph">
<p>The method <code>showGUI()</code> will then make the GUI visible - show it.</p>
</div>
<div class="paragraph">
<p>Now we have finished the last piece of the SSEM computer emulator and it is ready for run.</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. For example, <code>non terminal Instruction Statement;</code> in the gramamr above defines a non-terminal <code>Statement</code>, which should return an instance of <code>Instruction</code> class. The class <code>Instruction</code> must be implemented manually - it is part of AST; there are no special requirements for the implementation.
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. The error code should be defined by you, developer, if you want. It is a convention used also in other compilers that specific error has assigned a unique number. In our compiler, we do not use it.
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. See <a href="https://en.wikipedia.org/wiki/Manchester_Small-Scale_Experimental_Machine#Williams-Kilburn_tube" class="bare">https://en.wikipedia.org/wiki/Manchester_Small-Scale_Experimental_Machine#Williams-Kilburn_tube</a>
</div>
<div class="footnote" id="_footnote_4">
<a href="#_footnoteref_4">4</a>. The code might seem generally complicated and bloated with a boiler-plate. I personally blame Java Swing or Java itself for it, since it is a "corporate" language, usually used for different purposes than writing an emulator :)
</div>
<div class="footnote" id="_footnote_5">
<a href="#_footnoteref_5">5</a>. See <a href="#CPU_HOWTO">Writing a CPU</a> tutorial for more information about Edigen
</div>
</div>
            
        </div>
    </div>
</div>


    <footer class="site-footer">
        <div class="container">
            <nav class="navbar">
                <div class="container">
                    <ul class="nav navbar-nav">
                        <li><a href="https://github.com/vbmacher/emuStudio">GitHub</a></li>
                        <li><a href="https://sourceforge.net/p/emustudio/" rel="nofollow"><img alt="Download emuStudio" src="https://sourceforge.net/sflogo.php?type=10&group_id=340604"></a></li>
                        <li class="navbar-text">&copy; Copyright 2006-2017, Peter Jakubo</li>
                    </ul>
                </div>
            </nav>
        </div>
    </footer>

    </body>
</html>

