



<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>Cpu &diams; emuStudio</title>
    <meta name="keywords" content="emulator,emulation,emustudio,programming emulator,debugging in emulator,computer emulation,altair emulation">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="emuStudio &diams; Computer emulation platform/framework" href="../../../feed.xml">
    <link rel="alternate" type="application/atom+xml" title="emuStudio &diams; Computer emulation platform/framework" href="../../../atom.xml">

    <!-- Favicons -->
    <link rel="shortcut icon" type="image/x-icon" href="../../../favicon.ico?">
    <meta name="application-name" content="emuStudio &diams; Computer emulation platform/framework">
    <meta name="msapplication-TileColor" content="#ffffff">

    <!-- Fonts -->
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto+Condensed:300,300italic,400,400italic,700,700italic|Oswald:300,400,700">

    <!-- Styles -->
    <link rel="stylesheet" href="../../../css/style.css">


    <!-- Scripts -->

    <!--[if lt IE 9]>
        <script src="../../../js/html5shiv.min.js"></script>
        <script src="../../../js/respond.min.js"></script>
    [endif]-->

    <script src="../../../js/jquery-3.1.1.min.js"></script>
    <script src="../../../js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous">
    </script>


    <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-3492956-5', 'auto');
        ga('send', 'pageview');

    </script>
</head>


<body>


<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/emuStudio/"><i><img alt="&diams;" style="margin: -5px;margin-right:2px;" src="../../../img/logo-2.svg" width="30px" /></i>emuStudio</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <!--<form class="navbar-form navbar-left" role="search">-->
                <!--<div class="form-group">-->
                    <!--<input type="text" class="form-control" placeholder="Search website">-->
                <!--</div>-->
                <!--<button type="submit" class="btn btn-default">Submit</button>-->
            <!--</form>-->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/emuStudio/">Home</a>
                </li>
                
                <li>
                    <a href="/emuStudio/download">Download</a>
                </li>
                
                <li>
                    <a href="/emuStudio/docs">Docs</a>
                </li>
                
                <li>
                    <a href="/emuStudio/devel">Developer</a>
                </li>
                
                <li>
                    <a href="/emuStudio/roadmap">Roadmap</a>
                </li>
                
                <li>
                    <a href="/emuStudio/about">About</a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>


<div class="title-group">
    <h1 class="special" data-toc-skip>
      <span>
          
            Cpu
          
      </span>
    </h1>
    
    
</div>


<div class="container">
    <div class="sect1">
<h2 id="CPU_HOWTO">Writing a CPU</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial will describe some basic knowledge about how to create a CPU to be used in emuStudio. The tutorial
does not aim to explain emulation techniques in much detail, nor it is exhaustive. This is left for the programmer.
The tutorial focuses on how to use emuLib API in a CPU project so it can be used in emuStudio.</p>
</div>
<div class="sect2">
<h3 id="CPU_GETTING_STARTED">Getting started</h3>
<div class="paragraph">
<p>Before reading on, please read the <a href="#INTRODUCTION_PLUGINS">[INTRODUCTION_PLUGINS]</a> chapter. It gives the information
needed for setting up the development environment and for basic understanding how the emuStudio/plug-ins lifecycle
work.</p>
</div>
<div class="paragraph">
<p>A CPU is just another plug-in, which means that it is "enough" to implement some API. The CPU
API can be found in <code>emulib.plugins.cpu</code> project package.</p>
</div>
<div class="paragraph">
<p>CPU is supposed to be the core of the emulator in the similar way as the real CPU is core to the computer.
The term "emulation technique" is usually used when we talk about CPU emulation. This tutorial will not cover
the techniques in much detail. Furthermore, only instruction interpretation will be used for its simplicity.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More information about emulation techniques can be found for example at
      <a href="http://www.xsim.com/papers/Bario.2001.emubook.pdf">this link</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this tutorial, a simple CPU will be implemented for the world&#8217;s very first stored-program computer,
<a href="https://en.wikipedia.org/wiki/Manchester_Small-Scale_Experimental_Machine">SSEM</a>, nicknamed
"Baby". It was a predecessor of Manchester Mark 1 which led to Ferranti Mark 1, the world&#8217;s first commercially available
general-purpose computer.</p>
</div>
</div>
<div class="sect2">
<h3 id="CPU_WHAT_CPU_DOES">What emuStudio&#8217;s CPU can do</h3>
<div class="paragraph">
<p>CPU emulators in emuStudio are not just plain emulators. Besides, they must cooperate with emuStudio and provide
capabilities allowing debugging and some visualization.</p>
</div>
<div class="paragraph">
<p>The CPU must, besides the emulation "engine", implement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Disassembler</p>
</li>
<li>
<p>Java Swing GUI panel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Disassembler will be used by emuStudio for creating the list of instructions in the debugger panel. The visualization
of CPU registers, possibly current frequency and run state must be implemented by the CPU plug-in. For that purpose
the plug-in must provide the GUI panel to CPU.</p>
</div>
<div class="paragraph">
<p>Both the disassembler and GUI panel should be instantiated only once. emuStudio will ask for them also only once, during
the process of loading of the virtual computer.</p>
</div>
<div class="paragraph">
<p>For developing disassembler, there is good news. There exist a tool which can generate emuStudio disassembler from
a specification file. It is called Edigen, a short for "emulator disassembler generator". We will use this tool also
in this tutorial. For more information, see the projects at:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/sulir/edigen" class="bare">https://github.com/sulir/edigen</a></p>
</li>
<li>
<p>and <a href="https://github.com/sulir/edigen-maven-plugin" class="bare">https://github.com/sulir/edigen-maven-plugin</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="preparing-the-environment">Preparing the environment</h3>
<div class="paragraph">
<p>We will use Maven for managing the source code and dependencies.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are new to Maven, please read
      <a href="https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html">Maven in 5 minutes</a> tutorial.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The project should be located in <code>emuStudio/plugins/cpu/ssem-cpu</code>.
In order to create the initial project structure, run <code>mvn archetype:generate</code> in that directory.</p>
</div>
<div class="paragraph">
<p>The following structure should now exist:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>src/
  main/
    java/
    resources/
test/
  java/
pom.xml</pre>
</div>
</div>
<div class="paragraph">
<p>We will start with the <code>pom.xml</code> file, which follows.</p>
</div>
<div class="listingblock">
<div class="title"><code>pom.xml</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">Unresolved directive in cpu.adoc - include::{sourcedir}/plugins/cpu/ssem-cpu/pom.xml[]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-main-class">The main class</h3>
<div class="paragraph">
<p>We will start with implementing the main class of the CPU. It provides the main communication point - the API - used by
emuStudio main module. The main module can pass requests for starting or stopping the emulation, or it can request
for the disassembler or the GUI panel.</p>
</div>
<div class="paragraph">
<p>We will start with small snippet of code which will be extended throughout the tutorial. The first snippet looks
as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #AA22FF">@PluginType</span><span style="color: #666666">(</span>
    type <span style="color: #666666">=</span> PLUGIN_TYPE<span style="color: #666666">.</span><span style="color: #7D9029">CPU</span><span style="color: #666666">,</span>
    title <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;SSEM CPU&quot;</span><span style="color: #666666">,</span>
    copyright <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;\u00A9 Copyright 2017, Your Name&quot;</span><span style="color: #666666">,</span>
    description <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Emulator of SSEM CPU&quot;</span>
<span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">CpuImpl</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">destroyInternal</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>

    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">protected</span> RunState <span style="color: #0000FF">stepInternal</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> JPanel <span style="color: #0000FF">getStatusPanel</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getInstructionPosition</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">0;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">setInstructionPosition</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> i<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Disassembler <span style="color: #0000FF">getDisassembler</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>

    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> String <span style="color: #0000FF">getVersion</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;1.0.0&quot;</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> RunState <span style="color: #0000FF">call</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, there is a lot of methods which needs attention. Note two methods especially - <code>getStatusPanel()</code>
and <code>getDisassembler()</code>. Those two methods will return the components, mentioned first in section <a href="#CPU_WHAT_CPU_DOES">What emuStudio&#8217;s CPU can do</a>.</p>
</div>
<div class="paragraph">
<p>Also note that the class extends from <code>AbstractCPU</code>. The <code>AbstractCPU</code> class lies in emuLib library. It implements
some fundamental methods required by <code>CPU</code> interface. For example, managing breakpoints and controlling the
high-level emulation lifecycle in a thread-safe way. Generally speaking, the class eliminates lots of repeated
boiler-plate code needed to be done in every CPU plug-in.</p>
</div>
</div>
<div class="sect2">
<h3 id="CPU_BEHAVIORAL_CONTRACTS">Behavioral contracts</h3>
<div class="sect3">
<h4 id="load-and-initialization">Load and initialization</h4>
<div class="paragraph">
<p>Loading the virtual computer starts with creating separate class loader derived from the one emuStudio is using,
so each plug-in can see everything what emuStudio can see, roughly speaking. There can be loaded only one computer
in emuStudio.</p>
</div>
<div class="paragraph">
<p>The CPU plug-in JAR file is loaded using the class loader as a second in order.</p>
</div>
<div class="paragraph">
<p>The loading process follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>JAR content is searched for a main class. Main class must be annotated with <code>@PluginType(type = PLUGIN_TYPE.CPU)</code>
annotation and it does not matter in which package it resists.</p>
</li>
<li>
<p>There must be just one main class in the JAR. If there are more classes annotated with mentioned annotation, the
first found will be used; however the search order is non-deterministic.</p>
</li>
<li>
<p>The main class must implement <code>emulib.plugins.cpu.CPU</code> interface (in any depth of inheritance).</p>
</li>
<li>
<p>Plug-in is instantiated by calling the main class constructor. The constructor must be public and must have two
parameters of type: <code>java.lang.Long</code> (as the first) and <code>emulib.runtime.ContextPool</code> (as the second). The first
parameter represents a unique plug-in ID assigned by emuLib. This ID can then be used to access configuration
of the emulated computer. The second parameter is a context pool object. It is a pool of plugin contexts, runtime
entities intended for the plug-in intercommunication. In the constructor, the CPU should initialize its context to
the context pool. However; it must not retrieve the contexts of other plugins now, because they are not present at
this point, except compiler.</p>
</li>
<li>
<p>Plug-in is initialized by calling method <code>emulib.plugins.Plugin.initialize(SettingsManager settingsManager)</code> from
the main thread of emuStudio (not UI thread). This method is intended for all the initialization which could not be
performed in the constructor, such as reading plug-in settings, or retrieving contexts of other plug-in(s) from
the context pool.</p>
</li>
<li>
<p>Specifically for CPU, emuStudio calls <code>getDisassembler()</code> and <code>getStatusPanel()</code> methods in unspecified order.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After those steps, the CPU plug-in is ready. Further work of the CPU is event-based. emuStudio will handle UI events
and control the plug-in by calling appropriate methods of the main class instance. CPU emulators are run in
different thread than UI thread, so all method calls come from the same "controller" thread.</p>
</div>
<div class="paragraph">
<p>In case of automatic emulation, the emulation control is performed only in the main thread.</p>
</div>
</div>
<div class="sect3">
<h4 id="emulation-lifecycle">Emulation lifecycle</h4>
<div class="paragraph">
<p>As it was described in section "Emulation lifecycle" in the user manual of the main module, the emulation "life"
is a state machine. This state machine manages a state, called "current state". It then reacts on events from the
outside world and transitions the current state to another state, following the rules. The state transition can, and
in this case does - cause side-effects. It means that except the simple changing the state, it performs some actions.</p>
</div>
<div class="paragraph">
<p>For example, you know that there is a button above the debug window, a green-filled arrow, when clicked on it
the emulation will be executed. Besides, there are more buttons, for example "step emulation", which will do execute
just one CPU instruction. The clicks on the buttons are the "outside world" events, which will be propagated to
the state machine of emuStudio.</p>
</div>
<div class="paragraph">
<p>The state machine can be seen in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vbmacher.github.io/emuStudio/images/run-states.svg" alt="run states" width="335" height="300">
</div>
</div>
<div class="paragraph">
<p>The states of the state machine are encoded into an enum in emuLib:</p>
</div>
<div class="listingblock">
<div class="title"><code>emulib.plugins.cpu.CPU.RunState</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">enum</span> RunState <span style="color: #666666">{</span>
    STATE_STOPPED_NORMAL<span style="color: #666666">(</span><span style="color: #BA2121">&quot;stopped&quot;</span><span style="color: #666666">),</span>
    STATE_STOPPED_BREAK<span style="color: #666666">(</span><span style="color: #BA2121">&quot;breakpoint&quot;</span><span style="color: #666666">),</span>
    STATE_STOPPED_ADDR_FALLOUT<span style="color: #666666">(</span><span style="color: #BA2121">&quot;stopped (address fallout)&quot;</span><span style="color: #666666">),</span>
    STATE_STOPPED_BAD_INSTR<span style="color: #666666">(</span><span style="color: #BA2121">&quot;stopped (instruction fallout)&quot;</span><span style="color: #666666">),</span>
    STATE_RUNNING<span style="color: #666666">(</span><span style="color: #BA2121">&quot;running&quot;</span><span style="color: #666666">);</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The initial state is <code>breakpoint</code>. This is a behavioral contract which all CPUs must fulfil.</p>
</div>
<div class="paragraph">
<p>The <code>AbstractCPU</code> class implements the state machine by implementing fundamental methods of the <code>CPU</code> interface:</p>
</div>
<div class="listingblock">
<div class="title"><code>emulib.plugins.cpu.CPU</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">interface</span> <span style="color: #0000FF; font-weight: bold">CPU</span> <span style="color: #008000; font-weight: bold">extends</span> Plugin <span style="color: #666666">{</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">step</span><span style="color: #666666">();</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">execute</span><span style="color: #666666">();</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">pause</span><span style="color: #666666">();</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">stop</span><span style="color: #666666">();</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">reset</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> memoryLocation<span style="color: #666666">);</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The CPU plug-in developer can benefit from using <code>AbstractCPU</code> which implements most of the methods in a thread-safe
way. It is the required to implement only the following methods, which do not have to be synchronized:</p>
</div>
<div class="listingblock">
<div class="title"><code>emulib.plugins.cpu.AbstractCPU</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #AA22FF">@ThreadSafe</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AbstractCPU</span> <span style="color: #008000; font-weight: bold">implements</span> CPU<span style="color: #666666">,</span> Callable<span style="color: #666666">&lt;</span>RunState<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #008000; font-weight: bold">abstract</span> RunState <span style="color: #0000FF">stepInternal</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">resetInternal</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> var1<span style="color: #666666">);</span>

    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #008000; font-weight: bold">abstract</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">destroyInternal</span><span style="color: #666666">();</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="cpu-emulation-modes">CPU emulation modes</h5>
<div class="paragraph">
<p>The CPU can work in two modes while performing the emulation: "step" mode or "run" mode. The modes are disjunct - only one
of them can be active in time.</p>
</div>
<div class="sect5">
<h6 id="step-mode">"Step" mode</h6>
<div class="paragraph">
<p>In the "step" mode, the CPU emulates instructions in "steps", one-by-one. One instruction should be emulated by calling
<code>step()</code> method. After the emulation of the instruction is finished, the CPU run state should be returned back to
<code>STATE_STOPPED_BREAK</code>.</p>
</div>
<div class="paragraph">
<p>In case of error, the run state should change to <code>STATE_STOPPED_(how)</code>, where <code>(how)</code> is the general root cause of the
error (e.g. <code>BAD_INSTR</code> or <code>ADDR_FALLOUT</code>).</p>
</div>
<div class="paragraph">
<p>In this mode, it is not required to emulate the instruction in a performance-optimized manner.</p>
</div>
</div>
<div class="sect5">
<h6 id="run-mode">"Run" mode</h6>
<div class="paragraph">
<p>In the "run" mode, the CPU should emulate instructions infinitely until either some CPU-halt instruction is encountered
or user stops the emulation by external GUI event. Within this mode the developer is encouraged to use some good
emulation technique, which can focus on performance. The code paths which will be run by JVM in this mode should be
optimized for performance.</p>
</div>
<div class="paragraph">
<p>Furthermore, emuStudio will stop disassembling instructions and also other performance-consuming tasks to unburden the
CPU and other virtual components from various requests causing slow down of the general emulation performance.</p>
</div>
<div class="paragraph">
<p>When the emulation is finished, either by the external event (clicking on the "stop" button) or by some instruction,
the run state should be set accordingly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if the stop is "normal" or "expected", the run state should be <code>STATE_STOPPED_NORMAL</code></p>
</li>
<li>
<p>if the stop is caused by trying to read/write from nonexistant location in memory, the run state should be <code>STOPPED_ADDR_FALLOUT</code></p>
</li>
<li>
<p>if the stop is caused by trying to execute unknown instruction, the run state should be <code>STOPPED_BAD_INSTR</code></p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="final-notes">Final notes</h6>
<div class="paragraph">
<p>The described modes are reflected in methods of <code>AbstractCPU</code> class. The <code>call()</code> method represents the "run" mode, and
<code>stepInternal()</code> method, represents the "step" mode.</p>
</div>
<div class="paragraph">
<p>The contract which needs attention is threading. Execution of mentioned methods is done always by emuStudio.
It has dedicated one thread for this purpose. The methods are never executed from the UI thread, but from the dedicated
thread, using a work-queue for the upcoming events.</p>
</div>
<div class="paragraph">
<p>This means that CPU emulation control will not block UI, even if the execution takes longer time.
However, all the other methods from the CPU interface are (possibly) executed from the UI thread, so they should be
implemented in a responsive manner; they can block.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="CPU_SSEM_ARCHITECTURE">Architecture</h3>
<div class="paragraph">
<p>SSEM is one of the first implementations of the von-Neumann design of a computer. It contained control unit,
arithmetic-logic unit and I/O subsystem (CRT display). More information about the real architecture can be found
at <a href="http://www.cs.ubc.ca/~hilpert/e/SSEM/">this link</a>.</p>
</div>
<div class="paragraph">
<p>The architecture of our SSEM CPU emulator will look as follows (below is Display and Memory just to show how it
is connected overally):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vbmacher.github.io/emuStudio/images/ssem-scheme.svg" alt="ssem scheme" width="402" height="301">
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-main-class-2">The main class</h3>
<div class="paragraph">
<p>The fundamental steps when building a CPU involves the initialization and destruction code. After reading the
<a href="#CPU_BEHAVIORAL_CONTRACTS">Behavioral contracts</a>, you should be aware of how the code should look like.</p>
</div>
<div class="paragraph">
<p>The initialization code is represented by the constructor and the <code>initialize()</code> method.</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> ContextPool contextPool<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">CpuImpl</span><span style="color: #666666">(</span>Long pluginID<span style="color: #666666">,</span> ContextPool contextPool<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">(</span>pluginID<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">contextPool</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>contextPool<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        <span style="color: #408080; font-style: italic">// TODO</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will leave the other methods unimplemented for now.</p>
</div>
<div class="paragraph">
<p>While getting to the initialization part, what the CPU needs in order to operate? Especially, our SSEM "CPU". It
requires memory. The I/O subsystem, as can be seen at the picture under <a href="#CPU_SSEM_ARCHITECTURE">Architecture</a> section, will not be
implemented in this tutorial. There is dedicated separate tutorial for the CRT display.</p>
</div>
<div class="paragraph">
<p>The first step of the initialization is getting the memory from the context pool:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">private</span> MemoryContext<span style="color: #666666">&lt;</span>Integer<span style="color: #666666">&gt;</span> memory<span style="color: #666666">;</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        memory <span style="color: #666666">=</span> contextPool<span style="color: #666666">.</span><span style="color: #7D9029">getMemoryContext</span><span style="color: #666666">(</span>getPluginID<span style="color: #666666">(),</span> MemoryContext<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we see what the context pool is used for. It is a "storage" of communication objects which plug-ins provide
(contexts). Other plug-ins, which are connected with the one they want to communicate with, ask for the context.
There exist many specific contexts - for CPU, for compilers, memories or devices.</p>
</div>
<div class="paragraph">
<p>What&#8217;s more, the context can be extended with another, custom methods. In this case, the context class should be
passed as the second argument when calling <code>get&#8230;&#8203;Context()</code>. In our case, we expect the standard <code>MemoryContext</code>
interface, so we pass <code>MemoryContext.class</code> as the second argument.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The question you might have is why not to get the memory in the constructor? To answer this question, please
      read the document "Introduction for writing virtual computers", section "Loading and initialization".
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What now? We need to implement three fundamental components - GUI panel, disassembler and the emulator engine itself.
We can start with the interesting stuff right away.</p>
</div>
</div>
<div class="sect2">
<h3 id="emulator-engine">Emulator engine</h3>
<div class="paragraph">
<p>Emulator engine is the core of the emulator. As we all probably know, the CPU interprets some binary-encoded "commands"
- instructions - which are stored in memory. Basic von-Neumann CPUs work sequentially. Execution of one instruction
involves four basic steps: fetch, decode and execute, and store, executed in order.</p>
</div>
<div class="paragraph">
<p>Implementation of these steps in a programming language like Java does not have to be so explicit. It is often true
that the steps will overlap and mix up in the emulation algorithm; they really don&#8217;t have to be explicitly distinguished.
The aim of the emulator is to preserve external behavior (output or the effect), not the internal behavior. This is
different for the case of a simulator, which tries to mimic both internal and external behavior.</p>
</div>
<div class="paragraph">
<p>Emulator "looks" like real computer, "behaves" like the real one, but inside it is normal program which was written
using any programming style; it can use various variables, methods and other language features.</p>
</div>
<div class="paragraph">
<p>The pseudo-algorithm for executing one instruction can look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>step() {
  // fetch phase
  instruction = memory.read(current_instruction);
  current_instruction = current_instruction + 1;

  // decode phase
  line = parseLine(instruction);
  opcode = parseOpcode(instruction);

  // execute phase
  switch (opcode) {
    case 0: // JMP
      ...
    case 4: // JPR
      ...
    ...
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>And what CPU does when it runs? It executes these steps in the infinite loop, until it is stopped either internally or
by the external event. The main CPU emulation algorithm just described is called "interpretation", and it can look as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>run() {
  while (!stopped) {
    step();
  }
}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Java, besides interpretation it is possible to write also a threaded dispatch algorithm, which requires Java
      relection or lambdas. Threaded dispatch stores the execution implementation of each instruction in a separate
      method. Then, there is a dispatch table (array of method references), which maps the methods by opcode. Then,
      after the decoding of the opcode, the instruction is executed just by indexing that table and executing the method it
      references to. This algorithm is generally faster than interpretation, and it is still simple enough to be
      implemented.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our emulator engine will be constructed as a separate class. Besides the emulation methods it will contain the
variables representing CPU registers - <code>CI</code> (current instruction) and <code>Acc</code> (accumulator). In SSEM, both are 32-bit
values.</p>
</div>
<div class="paragraph">
<p>The class looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/EmulatorEngine.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EmulatorEngine</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">volatile</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> currentRunState<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">volatile</span> <span style="color: #B00040">int</span> Acc<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">volatile</span> <span style="color: #B00040">int</span> CI<span style="color: #666666">;</span>

    EmulatorEngine<span style="color: #666666">(</span>MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memory</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #B00040">void</span> <span style="color: #0000FF">reset</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> startingPos<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        Acc <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
        CI <span style="color: #666666">=</span> startingPos<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> <span style="color: #0000FF">step</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        Byte<span style="color: #666666">[]</span> instruction <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>CI<span style="color: #666666">);</span>
        CI <span style="color: #666666">+=</span> <span style="color: #666666">4;</span>

        <span style="color: #B00040">int</span> line <span style="color: #666666">=</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">reverseBits</span><span style="color: #666666">(</span>instruction<span style="color: #666666">[0],</span> <span style="color: #666666">8)</span> <span style="color: #666666">*</span> <span style="color: #666666">4;</span>
        <span style="color: #B00040">int</span> opcode <span style="color: #666666">=</span> instruction<span style="color: #666666">[1]</span> <span style="color: #666666">&amp;</span> <span style="color: #666666">7;</span>

        <span style="color: #008000; font-weight: bold">switch</span> <span style="color: #666666">(</span>opcode<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">0:</span> <span style="color: #408080; font-style: italic">// JMP</span>
                <span style="color: #B00040">int</span> oldCi <span style="color: #666666">=</span> CI <span style="color: #666666">-</span> <span style="color: #666666">4;</span>
                CI <span style="color: #666666">=</span> <span style="color: #666666">4</span> <span style="color: #666666">*</span> readInt<span style="color: #666666">(</span>line<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>CI <span style="color: #666666">==</span> oldCi<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    <span style="color: #408080; font-style: italic">// endless loop detected;</span>
                    <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_NORMAL</span><span style="color: #666666">;</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">4:</span> <span style="color: #408080; font-style: italic">// JPR</span>
                CI <span style="color: #666666">=</span> CI <span style="color: #666666">+</span> <span style="color: #666666">4</span> <span style="color: #666666">*</span> readInt<span style="color: #666666">(</span>line<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">2:</span> <span style="color: #408080; font-style: italic">// LDN</span>
                Acc <span style="color: #666666">=</span> <span style="color: #666666">-</span>readInt<span style="color: #666666">(</span>line<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">6:</span> <span style="color: #408080; font-style: italic">// STO</span>
                writeInt<span style="color: #666666">(</span>line<span style="color: #666666">,</span> Acc<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">1:</span> <span style="color: #408080; font-style: italic">// SUB</span>
                Acc <span style="color: #666666">=</span> Acc <span style="color: #666666">-</span> readInt<span style="color: #666666">(</span>line<span style="color: #666666">);</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">3:</span> <span style="color: #408080; font-style: italic">// CMP / SKN</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>Acc <span style="color: #666666">&lt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
                    CI <span style="color: #666666">+=</span> <span style="color: #666666">4;</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">break</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">case</span> <span style="color: #666666">7:</span> <span style="color: #408080; font-style: italic">// STP / HLT</span>
                <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_NORMAL</span><span style="color: #666666">;</span>
            <span style="color: #008000; font-weight: bold">default</span><span style="color: #666666">:</span>
                <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BAD_INSTR</span><span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BREAK</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">readInt</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        Byte<span style="color: #666666">[]</span> word <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">readWord</span><span style="color: #666666">(</span>line<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">return</span> NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">readInt</span><span style="color: #666666">(</span>word<span style="color: #666666">,</span> Strategy<span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">writeInt</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> line<span style="color: #666666">,</span> <span style="color: #B00040">int</span> value<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        Byte<span style="color: #666666">[]</span> word <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Byte<span style="color: #666666">[4];</span>
        NumberUtils<span style="color: #666666">.</span><span style="color: #7D9029">writeInt</span><span style="color: #666666">(</span>value<span style="color: #666666">,</span> word<span style="color: #666666">,</span> Strategy<span style="color: #666666">.</span><span style="color: #7D9029">REVERSE_BITS</span><span style="color: #666666">);</span>
        memory<span style="color: #666666">.</span><span style="color: #7D9029">writeWord</span><span style="color: #666666">(</span>line<span style="color: #666666">,</span> word<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> <span style="color: #0000FF">run</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> currentRunState <span style="color: #666666">=</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BREAK</span><span style="color: #666666">;</span>

        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">(!</span>Thread<span style="color: #666666">.</span><span style="color: #7D9029">currentThread</span><span style="color: #666666">().</span><span style="color: #7D9029">isInterrupted</span><span style="color: #666666">()</span> <span style="color: #666666">&amp;&amp;</span> currentRunState <span style="color: #666666">==</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BREAK</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
                currentRunState <span style="color: #666666">=</span> step<span style="color: #666666">();</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>IllegalArgumentException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>e<span style="color: #666666">.</span><span style="color: #7D9029">getCause</span><span style="color: #666666">()</span> <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">&amp;&amp;</span> e<span style="color: #666666">.</span><span style="color: #7D9029">getCause</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">instanceof</span> IndexOutOfBoundsException<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_ADDR_FALLOUT</span><span style="color: #666666">;</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BAD_INSTR</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>IndexOutOfBoundsException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_ADDR_FALLOUT</span><span style="color: #666666">;</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> currentRunState<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pretty short, huh? Method <code>step()</code> and <code>run()</code> return <code>CPU.RunState</code> enum, which is used by emuStudio to determine
if the emulator is still running or in what state it is. The <code>step()</code> method is the most fundamental regarding the
instruction emulation, but it is so easy that we&#8217;ll rather talk about the <code>run()</code> method.</p>
</div>
<div class="paragraph">
<p>The <code>run()</code> method begins with the already described cycle. However, the conditions of determining if the CPU should
be running can look complex at the first sight. However, we are checking just two conditions - if the current run state
has changed (look at the <code>step()</code> method - it can change there), or if the current thread is interrupted. It can
interrupt by external condition, e.g. when somebody quits the emulator during CPU emulation.</p>
</div>
<div class="paragraph">
<p>Then, there are many catches. They are quite required because of many possible situations which can happen - when the
CPU gets to the end of the memory, what it should do? It does nothing, so the memory will throw some variant of
<code>IndexOutOfBoundsException</code>. For this purpose, CPU state contains one which is called <code>STATE_STOPPED_ADDR_FALLOUT</code>,
meaning "address fallout", like if the address "fell out" of allowed range.</p>
</div>
<div class="paragraph">
<p>And the last bad thing which can happen is when the memory at the current instruction position contains some unknown
data, not recognized by CPU. For this situation, we have <code>STATE_STOPPED_BAD_INSTR</code> state.</p>
</div>
<div class="paragraph">
<p>That&#8217;s pretty it. We will now extend the engine to support breakpoints and controlling the speed.</p>
</div>
<div class="sect3">
<h4 id="breakpoints-support">Breakpoints support</h4>
<div class="paragraph">
<p>Since emuStudio is mainly intended for students, as they should get in touch with emulated computers and how they work,
it should allow sometimes to pause the emulation at a point she wants. This capability is also useful when
our program written for the emulated computer does not work and we want to know what happens after executing specific
instruction. We can set a "breakpoint" to that instruction, a flag saying that CPU should pause itself when it
encounters the instruction.</p>
</div>
<div class="paragraph">
<p>Breakpoint is in fact an address - memory location, at which the CPU should pause its execution. It is used only when
CPU is running. Breakpoints are usually stored in a set. The class <code>emulib.plugins.cpu.AbstractCPU</code> has already this
set as a protected member (called <code>breakpoints</code>) and implements all the breakpoints enabling/disabling. What is still
left to do for us is to check if at specific address (current instruction position) the breakpoint is set, and if yes,
somehow "pause" the CPU.</p>
</div>
<div class="paragraph">
<p>We implement this in the <code>run()</code> method, right before instruction execution:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/EmulatorEngine.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EmulatorEngine</span> <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> CPU cpu<span style="color: #666666">;</span>

    EmulatorEngine<span style="color: #666666">(</span>MemoryContext<span style="color: #666666">&lt;</span>Byte<span style="color: #666666">&gt;</span> memory<span style="color: #666666">,</span> CPU cpu<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">memory</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">cpu</span> <span style="color: #666666">=</span> Objects<span style="color: #666666">.</span><span style="color: #7D9029">requireNonNull</span><span style="color: #666666">(</span>cpu<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> <span style="color: #0000FF">run</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">(...)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>cpu<span style="color: #666666">.</span><span style="color: #7D9029">isBreakpointSet</span><span style="color: #666666">(</span>CI<span style="color: #666666">))</span> <span style="color: #666666">{</span>
                    <span style="color: #008000; font-weight: bold">return</span> CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span><span style="color: #666666">.</span><span style="color: #7D9029">STATE_STOPPED_BREAK</span><span style="color: #666666">;</span>
                <span style="color: #666666">}</span>
                currentRunState <span style="color: #666666">=</span> step<span style="color: #666666">();</span>
            <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(...)</span> <span style="color: #666666">{</span>
              <span style="color: #666666">...</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> currentRunState<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the engine requires also the CPU main object, needed for checking if the breakpoint is set at current
instruction location, denoted by the <code>CI</code> register. If the breakpoint is set, the resulting state is <code>STATE_STOPPED_BREAK</code>, and
emuStudio will take care about the pausing and updating the GUI.</p>
</div>
</div>
<div class="sect3">
<h4 id="preserving-the-speed">Preserving the speed</h4>
<div class="paragraph">
<p>Every real computer runs at some speed, usually talking just about only CPU speed. Baby "CPU" could perform about 700
instructions per second. How we should achieve that? The simplest method would be something like that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>run() {
    while (!stopped) {
        start = measureTime();
        ... perform 700 instructions ...
        end = measureTime();

        to_wait = 1.second - (end - start);
        if (to_wait &gt; 0) {
            wait_time(to_wait);
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>So perform 700 instructions, then wait until one second elapses, and go again. What&#8217;s wrong about this solution?
That the algorithm is not "smooth". 700 instructions will be performed at full blast, and then there will be something
like a "break", and the situation will repeat. Real CPU certainly didn&#8217;t work like that and we can do better.</p>
</div>
<div class="paragraph">
<p>If we know how long it takes to execute each instruction, if our host CPU is faster than CPU of SSEM (which is I
suppose :), we can "wait" after each instruction the time difference, so we will artificially slow down to SSEM speed.</p>
</div>
<div class="paragraph">
<p>In reality, every instruction is performed in some number of machine "cycles". We can imagine the machine cycle
as a time of elementary phase when performing the instruction. Based on this information which is
usually available, can be build a technique for preserving speed even better.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Description of the speed-preservation technique can be seen e.g. at
      <a href="http://emustudio.sourceforge.net/downloads/2010-cse.pdf">this link</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I don&#8217;t quite know the speed of particular SSEM instructions, and besides the algorithm is quite complex. More achievable
is a bit different approach, but still quite interesting.</p>
</div>
<div class="paragraph">
<p>Waiting after each instruction requires computing the time difference, checking it and if it is &gt; 0, wait the amount
of time, by calling some Java method. However, we don&#8217;t know how long each instruction will take, but we can estimate
it by measuring.</p>
</div>
<div class="paragraph">
<p>We will execute as many instructions as we can in a second, and by simple math we can then compute how long we should
"wait", in average, so at the end we will execute 700 instructions in a second, in average. Once again, the steps are
as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Measure how many instructions will be executed in 1 second, we will label the number as N.</p>
</li>
<li>
<p>The goal is to achieve 700 instructions per second. It is assumed N &gt; 700. In the first step, we need 1 / N * 700
seconds to pass and we know that 700 instructions will be then executed. We will label this as M = 1 / N * 700. It
will be a constant, after the measurement.</p>
</li>
<li>
<p>Then, we need to wait 1 / M seconds after each instruction, and 700 instructions per second is achieved.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The measurement will not be very accurate, since perfect or almost perfect measuring of method execution in Java has
some rules, like warming up JVM before measurement, etc.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For time measurement it is necessary to use <code>System.nanoTime()</code> method instead of <code>System.currentTimeMillis()</code>.
      The reason is that the latter is corrected time-to-time by operating system because of errors caused by not
      really accurate timer in your computer. Then, the time difference can give invalid values, sometimes even
      negative ones. The <code>System.nanoTime()</code> is not corrected, so time difference works well.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The algorithm will work in the following steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1. Measure average instruction time
2. Compute how much CPU should wait after executing each instruction
3. Wait after each instruction for the computed time</pre>
</div>
</div>
<div class="paragraph">
<p>The third step will be performed only if the time we should wait is greater than zero. It means that the host computer
is faster than Baby computer (which is expected).</p>
</div>
<div class="paragraph">
<p>The algorithm can be implemented as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EmulatorEngine</span> <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">volatile</span> <span style="color: #B00040">long</span> averageInstructionNanos<span style="color: #666666">;</span>

    CPU<span style="color: #666666">.</span><span style="color: #7D9029">RunState</span> <span style="color: #0000FF">run</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>averageInstructionNanos <span style="color: #666666">==</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
            measureAverageInstructionNanos<span style="color: #666666">();</span>
        <span style="color: #666666">}</span>
        <span style="color: #B00040">long</span> waitNanos <span style="color: #666666">=</span> TimeUnit<span style="color: #666666">.</span><span style="color: #7D9029">SECONDS</span><span style="color: #666666">.</span><span style="color: #7D9029">toNanos</span><span style="color: #666666">(1)</span> <span style="color: #666666">/</span> averageInstructionNanos<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">(...)</span> <span style="color: #666666">{</span>
            <span style="color: #666666">...</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>waitNanos <span style="color: #666666">&gt;</span> <span style="color: #666666">0)</span> <span style="color: #666666">{</span>
                LockSupport<span style="color: #666666">.</span><span style="color: #7D9029">parkNanos</span><span style="color: #666666">(</span>waitNanos<span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
        <span style="color: #008000; font-weight: bold">return</span> currentRunState<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Quite simple, so far. We will measure the instruction speed just once, on the first call of the <code>run()</code> method. The
measured value will be reused for later executions and will not slow down the whole emulator.</p>
</div>
<div class="paragraph">
<p>However, how we should measure the average time which is taken by the instruction execution?
Well, if we want to be at least somehow accurate, we should emulate the <code>step()</code> method several times, and then compute
the average. However, we can&#8217;t. The reason is that <code>step()</code> method uses real memory and CPU registers. We should use
kind of "fake" the <code>step()</code> method which will not change the emulator state or memory. But the fake step should implement
instruction with the average "complexity", which we will do just with some estimation or better - feeling. The
algorithm can look as follows (there&#8217;s lot to improve ofcourse):</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/EmulatorEngine.java</code></div>
<div class="content">
<pre>public class EmulatorEngine {
    final static int INSTRUCTIONS_PER_SECOND = 700;
    private final static int MEMORY_CELLS = 32 * 4;
    ...

    private void fakeStep() {
        Byte[] instruction = memory.readWord(CI);

        int line = NumberUtils.reverseBits(instruction[0], 8);
        int opcode = instruction[1] &amp; 3;
        CI = (CI + 4) % MEMORY_CELLS;


        switch (opcode) {
            case 0: break;
            case 1: break;
            case 2: break;
            case 3: break;
            case 4: break;
            case 6: break;
            case 7: break;
        }

        Acc -= memory.read(line % MEMORY_CELLS);
    }


    private void measureAverageInstructionNanos() {
        int oldCI = CI;
        int oldAcc = Acc;

        long start = System.nanoTime();
        for (int i = 0; i &lt; INSTRUCTIONS_PER_SECOND; i++) {
            fakeStep();
        }
        long elapsed = System.nanoTime() - start;

        averageInstructionNanos = elapsed / INSTRUCTIONS_PER_SECOND;

        CI = oldCI;
        Acc = oldAcc;
    }

    ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>At first, we will save the registers (emulator state). Then, we will execute the fake step for 700 times and then
compute the average time. At the end we restore the state, and that&#8217;s it. As you might notice, we tried to use
real things in this "fake" step method like real memory (but just for reading), and emulator registers, which we backed
up and then restored.</p>
</div>
<div class="paragraph">
<p>That&#8217;s about it! If we had disassembler and GUI, the emulator is now ready - we have just implemented the core of the CPU.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="disassembler">Disassembler</h3>
<div class="paragraph">
<p>Disassembler is not needed for the emulation itself. It is needed for emuStudio to be able to visually show the
instructions. Instructions are encoded in a binary form and reside in memory. Disassembler "disassembles" - decodes the
instructions and transforms them into a string representation which can be easily shown on screen.</p>
</div>
<div class="paragraph">
<p>Decoding binary instructions for disassembler can be a bit different from decoding used in the emulator. For example,
instructions binary code can use constants which can be used directly in the emulator, but which must be translated
in the disassembler. Also, decoding code is usually mixed up with emulator code for performance reasons, so it&#8217;s
hard to reuse it. For these reasons, the programmer often need to implement the decoding part again and duplicate the
work a bit. But not in emuStudio.</p>
</div>
<div class="paragraph">
<p>Fortunately, there exist a project called Edigen (<a href="https://github.com/sulir/edigen" class="bare">https://github.com/sulir/edigen</a>), a disassembler generator. It works
similarly as a parser generator: developer writes a specification file with all the instructions of the CPU. Then, Edigen
(either from the command line or from Maven) generates disassembler and decoder source code, using predefined templates.
These generally do not need any further attention from the developer and can be used right away.</p>
</div>
<div class="paragraph">
<p>SSEM CPU specification file should be put in <code>ssem-cpu/src/main/edigen/cpu.eds</code>, and it looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>ssem-cpu/src/main/edigen/cpu.eds</code></div>
<div class="content">
<pre class="pygments highlight"><code>Unresolved directive in cpu.adoc - include::{sourcedir}/plugins/cpu/ssem-cpu/src/main/edigen/cpu.eds[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The specification file might look a bit cryptic at first sight, but it&#8217;s quite easy. The content is divided into two
sections, separated with two <code>%%</code> chars on a separate line. The first section contains rules which are used for parsing
the instruction binary codes and assign labels to the codes. The second section specifies the disassembled string
formats for particular rules.</p>
</div>
<div class="paragraph">
<p>There can exist multiple rules, and rules can include another rules. If the rule includes the same rule recursively,
it means it&#8217;s a constant. In that case, in the parenthesis after the rule inclusion must be a number of bits
which the constant takes.</p>
</div>
<div class="sect3">
<h4 id="using-generated-disassembler">Using generated disassembler</h4>
<div class="paragraph">
<p>When you look into our <code>pom.xml</code> file, you can find a section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml">...
      <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>edigen<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>edigen-maven-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;decoderName&gt;</span>net.sf.emustudio.ssem.DecoderImpl<span style="color: #008000; font-weight: bold">&lt;/decoderName&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;disassemblerName&gt;</span>net.sf.emustudio.ssem.DisassemblerImpl<span style="color: #008000; font-weight: bold">&lt;/disassemblerName&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;executions&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;execution&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;goals&gt;</span>
              <span style="color: #008000; font-weight: bold">&lt;goal&gt;</span>generate<span style="color: #008000; font-weight: bold">&lt;/goal&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/goals&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/execution&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/executions&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The disassembler will be generated in the class <code>net.sf.emustudio.ssem.DisassemblerImpl</code>. The class already implements
the interface <code>emulib.plugins.cpu.Disassembler</code>, which is exactly what method <code>CPU.getDisassembler()</code> returns.
Disassembler is an independent component so it also uses the memory from where it reads the instructions. Therefore,
disassembler can be initialized <em>after</em> the memory. Now we are ready to do full initialization of the emulator, with
the engine as well as disassembler. The code looks as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">private</span> EmulatorEngine engine<span style="color: #666666">;</span>
    <span style="color: #008000; font-weight: bold">private</span> Disassembler disasm<span style="color: #666666">;</span>

    <span style="color: #666666">...</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        memory <span style="color: #666666">=</span> contextPool<span style="color: #666666">.</span><span style="color: #7D9029">getMemoryContext</span><span style="color: #666666">(</span>getPluginID<span style="color: #666666">(),</span> MemoryContext<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
        Decoder decoder <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> DecoderImpl<span style="color: #666666">(</span>memory<span style="color: #666666">);</span>
        disasm <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> DisassemblerImpl<span style="color: #666666">(</span>memory<span style="color: #666666">,</span> decoder<span style="color: #666666">);</span>
        engine <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> EmulatorEngine<span style="color: #666666">(</span>memory<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> Disassembler <span style="color: #0000FF">getDisassembler</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> disasm<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> RunState <span style="color: #0000FF">call</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">run</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">protected</span> RunState <span style="color: #0000FF">stepInternal</span><span style="color: #666666">()</span> <span style="color: #008000; font-weight: bold">throws</span> Exception <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">step</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">resetInternal</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> startPos<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        engine<span style="color: #666666">.</span><span style="color: #7D9029">reset</span><span style="color: #666666">(</span>startPos<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">getInstructionPosition</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> engine<span style="color: #666666">.</span><span style="color: #7D9029">CI</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">boolean</span> <span style="color: #0000FF">setInstructionPosition</span><span style="color: #666666">(</span><span style="color: #B00040">int</span> i<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #B00040">int</span> memSize <span style="color: #666666">=</span> memory<span style="color: #666666">.</span><span style="color: #7D9029">getSize</span><span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>i <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span> <span style="color: #666666">||</span> i <span style="color: #666666">&gt;=</span> memSize<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> IllegalArgumentException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Instruction position can be in &lt;0,&quot;</span> <span style="color: #666666">+</span> memSize<span style="color: #666666">/4</span> <span style="color: #666666">+</span><span style="color: #BA2121">&quot;&gt;, but was: &quot;</span> <span style="color: #666666">+</span> i<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
        engine<span style="color: #666666">.</span><span style="color: #7D9029">CI</span> <span style="color: #666666">=</span> i<span style="color: #666666">;</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are approaching the end of our road. The last thing to do is to implement a status panel GUI of the CPU.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="status-panel">Status panel</h3>
<div class="paragraph">
<p>The status panel is a Java Swing panel (class extending <code>java.swing.JPanel</code>). The GUI can be "drawn" in any favorite
IDE, like NetBeans or IntelliJ IDEA. The status panel should show the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CPU run state</p>
</li>
<li>
<p>Internal state: registers or possibly portion of memory</p>
</li>
<li>
<p>Optionally, speed (running frequency)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The status panel is the interaction point between CPU and the user. With it, the user can be allowed to modify or
view the internal status of the CPU emulator. This is very handy when learning or checking how it works, what the
registers' values really are (and compare them with those shown on a display), etc.</p>
</div>
<div class="paragraph">
<p>SSEM CPU status panel will look as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vbmacher.github.io/emuStudio/docdevel/emulator_tutorial/images//cpu-status-panel.png" alt="SSEM CPU Status panel GUI">
</div>
</div>
<div class="paragraph">
<p>The class code is:</p>
</div>
<div class="listingblock">
<div class="title"><code>ssem-cpu/src/main/java/net/sf/emustudio/ssem/cpu/CpuPanel.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java">Unresolved directive in cpu<span style="color: #666666">.</span><span style="color: #7D9029">adoc</span> <span style="color: #666666">-</span> include<span style="color: #666666">::{</span>sourcedir<span style="color: #666666">}/</span>plugins<span style="color: #666666">/</span>cpu<span style="color: #666666">/</span>ssem<span style="color: #666666">-</span>cpu<span style="color: #666666">/</span>src<span style="color: #666666">/</span>main<span style="color: #666666">/</span>java<span style="color: #666666">/</span>net<span style="color: #666666">/</span>sf<span style="color: #666666">/</span>emustudio<span style="color: #666666">/</span>ssem<span style="color: #666666">/</span>cpu<span style="color: #666666">/</span>CpuPanel<span style="color: #666666">.</span><span style="color: #7D9029">java</span><span style="color: #666666">[</span>lines<span style="color: #666666">=20..-1]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We don&#8217;t have to care about method <code>initComponents()</code> and the fields at the end of the class. Those are generated by
the NetBeans by its GUI designer. I have included it just because the overall look and how the variables - text fields
etc. are named.</p>
</div>
<div class="paragraph">
<p>The only thing which should grasp our attention is the nested <code>Updater</code> class. The class implements the mechanism of
updating values of the GUI. The mechanism is the observer pattern, as you might have recognized. The updater implements
<code>CPU.CPUListener</code> interface, with two methods. The <code>runStateChanged()</code> method is called by the CPU when the run state
has changed. The argument is the new run state. The second method, <code>internalStateChanged()</code> is called by CPU always
when the internal state of a CPU has changed - ie. values of registers. When the CPU is in running state, this method
is not called for performance reasons.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Don&#8217;t forget to register the updater by calling <code>cpu.addCPUListener()</code>. The proper way upon shutting down should
      be to remove it, but the class <code>AbstractCPU</code> will take care about it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we need to incorporate the panel into the main class. It&#8217;s easy:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> JPanel <span style="color: #0000FF">getStatusPanel</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> CpuPanel<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">,</span> engine<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="automatic-emulation">Automatic emulation</h3>
<div class="paragraph">
<p>The optional step is to change a behavior slightly when user runs the automatic emulation. Why here? Why not in
e.g. CRT display or other plug-in? To answer this question, let&#8217;s think a bit.</p>
</div>
<div class="paragraph">
<p>Automatic emulation exists to suppress interaction with user and perform the whole emulation - from compilation to
running the program - automatically. The important output is usually redirected to a file; so as the required input
is read from file, instead asking the user for it. User then can check the output separately.</p>
</div>
<div class="paragraph">
<p>Usually some terminal input/output is redirected in case of automatic emulation. For example, LSI ADM-3A emulator
redirects input from file <code>adm3a-terminal.in</code> and output to <code>adm3a-terminal.out</code>.</p>
</div>
<div class="paragraph">
<p>But for SSEM - what output is important enough to be put in a file in case of automatic
emulation? Well, the answer is clear - content of the memory, which is not big - just 32 rows. In addition, it will
be useful to see the content of the accumulator and CI register after the emulation finishes. Plug-in which has
easy access to the memory, to the registers and knows the emulation state is CPU. Therefore, we implement the automation
support here.</p>
</div>
<div class="paragraph">
<p>After each emulation "stop" - no matter the reason of stopping, if before the emulation was running, we want to perform
a "snapshot" of the emulator state - registers <code>Acc</code>, <code>CI</code> and memory content. This snapshot will be then written to a
file called <code>ssem.out</code>.</p>
</div>
<div class="paragraph">
<p>At first, let&#8217;s implement the class:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/AutomaticEmulation.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java">Unresolved directive in cpu<span style="color: #666666">.</span><span style="color: #7D9029">adoc</span> <span style="color: #666666">-</span> include<span style="color: #666666">::{</span>sourcedir<span style="color: #666666">}/</span>plugins<span style="color: #666666">/</span>cpu<span style="color: #666666">/</span>ssem<span style="color: #666666">-</span>cpu<span style="color: #666666">/</span>src<span style="color: #666666">/</span>main<span style="color: #666666">/</span>java<span style="color: #666666">/</span>net<span style="color: #666666">/</span>sf<span style="color: #666666">/</span>emustudio<span style="color: #666666">/</span>ssem<span style="color: #666666">/</span>cpu<span style="color: #666666">/</span>AutomaticEmulation<span style="color: #666666">.</span><span style="color: #7D9029">java</span><span style="color: #666666">[</span>lines<span style="color: #666666">=20..-1]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, the class should be incorporated to the main class:</p>
</div>
<div class="listingblock">
<div class="title"><code>src/main/java/net/sf/emustudio/ssem/cpu/CpuImpl.java</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">CpuImpl</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractCPU <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>

    <span style="color: #008000; font-weight: bold">private</span> Optional<span style="color: #666666">&lt;</span>AutomaticEmulation<span style="color: #666666">&gt;</span> automaticEmulation <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">empty</span><span style="color: #666666">();</span>

    <span style="color: #666666">...</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initialize</span><span style="color: #666666">(</span>SettingsManager settingsManager<span style="color: #666666">)</span> <span style="color: #008000; font-weight: bold">throws</span> PluginInitializationException <span style="color: #666666">{</span>
        <span style="color: #666666">...</span>

        <span style="color: #B00040">boolean</span> auto <span style="color: #666666">=</span> Boolean<span style="color: #666666">.</span><span style="color: #7D9029">parseBoolean</span><span style="color: #666666">(</span>settingsManager<span style="color: #666666">.</span><span style="color: #7D9029">readSetting</span><span style="color: #666666">(</span>getPluginID<span style="color: #666666">(),</span> SettingsManager<span style="color: #666666">.</span><span style="color: #7D9029">AUTO</span><span style="color: #666666">));</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>auto<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            automaticEmulation <span style="color: #666666">=</span> Optional<span style="color: #666666">.</span><span style="color: #7D9029">of</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> AutomaticEmulation<span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">,</span> engine<span style="color: #666666">,</span> memory<span style="color: #666666">));</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>

    <span style="color: #666666">...</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it. If we run the emulator with the command line:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>java -jar emuStudio.jar --config SSEM --nogui --auto --input examples/as-ssem/the-fraj.ssem</pre>
</div>
</div>
<div class="paragraph">
<p>the emulation will run without user interaction, and file <code>ssem.out</code> will be created with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ACC=0x0
CI=0x8

   L L L L L 5 6 7 8 9 0 1 2 I I I 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
00
01 * * *   *                   *                         * * *   *
02   *
03   * *   *                     *
04   *     *                 * *
05   *     *                   *
06   *     *                     *
07 * * *   *                 * *
08 *                           *
09   *     *                 * *
10   *     *                   *
11     *   *                     *
12                             * *
13 * *     *                   *
14 *                         * *
15 *   *   *                     *
16 * * *                     * *
17
18
19 *     *   * * * * * * * * *   * * * * * * * * * * * *       *
20 * * * * * * * * * * * * * * * * * * * * * * * * * * *   * * * *
21                           * * * * * * * * * * * * * * * * * * *
22 *
23   * * *   *   *   * * *   * * *   * * *       * *     * * * *
24     *     *   *   *       *       *     *   *     *       *
25     *     *   *   *       *       *     *   *     *       *
26     *     * * *   * *     * *     * * *     * * * *       *
27     *     * * *   * *     * *     * * *     * * * *       *
28     *     *   *   *       *       *   *     *     *       *
29     *     *   *   *       *       *     *   *     *   *   *
30     *     *   *   * * *   *       *     *   *     *     *
31</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing">Testing</h3>
<div class="paragraph">
<p>Now you have implemented complete CPU emulator. It should work. Should. But how do we now until we try? Every program
can have bugs. And most likely it does. It is crucial for CPU emulator to work literally exactly as the real CPU. With
little playing we can&#8217;t test all instructions, all their variants and check all possible inputs. This must be done
systematically.</p>
</div>
<div class="paragraph">
<p>In languages which have mutable state ("inpure languages"), like Java, it is quite hard to reason about the correctness.
There are some ways, but instead of formal reasoning became very popular a technique called automated testing. There
exist several levels of automated tests. Those which are usually placed very close to the source code of the project,
and which tests a single "unit" - the smallest entity - are called unit tests.</p>
</div>
<div class="paragraph">
<p>In object oriented languages, unit tests should test production classes and their behavior in the isolated
environment. Each unit test is also a class. Maven uses standard path where the unit tests should be put.</p>
</div>
<div class="paragraph">
<p>Testing of SSEM CPU is left as an exercise for the plug-in developer.</p>
</div>
</div>
</div>
</div>
</div>


    <footer class="site-footer">
        <div class="container">
            <nav class="navbar">
                <div class="container">
                    <ul class="nav navbar-nav">
                        <li><a href="https://github.com/vbmacher/emuStudio">GitHub</a></li>
                        <li><a href="https://sourceforge.net/p/emustudio/" rel="nofollow"><img alt="Download emuStudio" src="https://sourceforge.net/sflogo.php?type=10&group_id=340604"></a></li>
                        <li class="navbar-text">&copy; Copyright 2006-2017, Peter Jakubo</li>
                    </ul>
                </div>
            </nav>
        </div>
    </footer>

    </body>
</html>

